<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Provisioning Portal</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    
    /* Tab Navigation */
    .tab-navigation{display:flex;background:#fff;border:1px solid #ddd;border-radius:4px 4px 0 0;margin-bottom:0}
    .tab-button{flex:1;padding:15px 20px;background:#f8f9fa;border:none;border-right:1px solid #ddd;cursor:pointer;font-weight:bold;transition:all 0.3s}
    .tab-button:last-child{border-right:none}
    .tab-button:hover{background:#e9ecef}
    .tab-button.active{background:#c41e3a;color:white}
    
    /* Tab Content */
    .tab-content{display:none;background:#f5f5f5;border:1px solid #ddd;border-top:none;border-radius:0 0 4px 4px;padding:20px}
    .tab-content.active{display:block}
    
    .main-layout{display:flex;gap:20px;flex-wrap:wrap}
    .left-panel{flex:2;min-width:800px}
    .right-panel{flex:1;min-width:400px}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    
    /* Special styling for reservation column */
    .reservation-column{background:#f0e6ff;border-color:#6b3aa0}
    .reservation-column .column-header{background:#8b5fbf;color:white}
    
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .form-control.textarea{min-height:80px;resize:vertical;font-family:Arial,sans-serif}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .checkbox-group{margin-top:5px}
    .checkbox-group label{font-weight:normal;display:flex;align-items:center;margin-bottom:5px}
    .checkbox-group input[type="checkbox"]{margin-right:8px}
    
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-reserve{background:#6b3aa0;color:#fff}
    .btn-reserve:hover{background:#8b5fbf}
    .btn-reserve:disabled{background:#ccc;cursor:not-allowed}
    .btn-small{padding:4px 8px;font-size:12px}
    
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .reserved-item{display:flex;justify-content:space-between;align-items:flex-start;
      background:#fff;padding:10px;border-radius:3px;margin:5px 0;border:1px solid #ddd}
    .reserved-item-content{flex:1}
    .reserved-phone{font-weight:bold;color:#6b3aa0;margin-bottom:5px}
    .reserved-notes{color:#666;font-size:12px;font-style:italic}
    
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    .error{background:#ffe6e6;color:#cc0000;padding:10px;border:1px solid #cc0000;border-radius:4px;margin-bottom:15px}
    .warning{background:#fff3cd;color:#856404;padding:10px;border:1px solid #ffc107;border-radius:4px;margin-bottom:15px}
    
    .help-text{font-size:12px;color:#666;margin-top:3px;font-style:italic}
    .char-counter{font-size:11px;color:#666;text-align:right;margin-top:2px}
    
    /* Naming convention preview */
    .naming-preview{background:#f0f8ff;border:1px solid #0066cc;padding:10px;border-radius:4px;margin-top:10px}
    .naming-preview h5{color:#0066cc;margin-bottom:5px}
    .naming-item{font-family:monospace;font-size:12px;margin:3px 0}
    
    /* Batch Operations Table Styles */
    .batch-panel{background:#f0f8ff;border:2px solid #4169e1;border-radius:4px;padding:20px}
    .batch-header{background:#4169e1;color:white;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #4169e1}
    .batch-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .batch-table th,.batch-table td{border:1px solid #ddd;padding:8px;text-align:left}
    .batch-table th{background:#e6f2ff;font-weight:bold}
    .batch-table .action-add{background:#e8f5e8}
    .batch-table .action-modify{background:#fff3cd}
    .batch-table .action-deprovision{background:#f8d7da}
    .batch-summary{background:#fff;border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:15px}
    .remove-batch-item{background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px}
    .remove-batch-item:hover{background:#c82333}
    .batch-empty{text-align:center;color:#666;font-style:italic;padding:20px}
    
    /* Teams status indicator */
    .teams-status{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px;text-align:center}
    .teams-status.authenticated{background:#e8f5e8;border-color:#4caf50;color:#2e7d32}
    .teams-status.warning{background:#fff3cd;border-color:#ffc107;color:#856404}
    
    /* Agent list */
    .agent-list{max-height:200px;overflow-y:auto;border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9}
    .agent-item{display:flex;justify-content:space-between;align-items:center;padding:5px;margin:3px 0;background:#fff;border-radius:3px}
    
    @media(max-width:1200px){
      .main-layout{flex-direction:column}
      .left-panel,.right-panel{min-width:auto}
    }
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <!-- Teams Authentication Status -->
    <div id="teamsStatus" class="teams-status">
      üîÑ Initializing Teams integration...
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="showTab('phone-users', event)">Teams Phone Users</button>
      <button class="tab-button" onclick="showTab('shared-devices', event)">Teams Shared Devices</button>
      <button class="tab-button" onclick="showTab('call-queues', event)">Call Queues</button>
      <button class="tab-button" onclick="showTab('auto-attendants', event)">Auto Attendants</button>
      <button class="tab-button" onclick="showTab('aa-cq-pairs', event)">AA/CQ Pairs</button>
    </div>

<!-- TEAMS PHONE USERS TAB -->
    <div id="phone-users" class="tab-content active">
      <div class="main-layout">
        <!-- LEFT PANEL - Forms -->
        <div class="left-panel">
          <div class="columns">

            <!-- ADD PHONE USER -->
            <div class="column">
              <div class="column-header">Add a Teams Phone User</div>
              <div id="addUserMessages"></div>

              <div class="form-group">
                <label for="addUsername">Select User:</label>
                <select id="addUsername" class="form-control">
                  <option value="">Select a user...</option>
                </select>
                <div class="help-text">(A5 Faculty non-enterprise voice enabled)</div>
              </div>

              <div class="form-group">
                <label for="addPhoneNumber">Pick an available phone number:</label>
                <select id="addPhoneNumber" class="form-control">
                  <option value="">Select phone number...</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="addReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div class="form-group">
                <label>International Calling:</label>
                <div class="radio-group">
                  <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
                  <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
                </div>
              </div>

              <div class="form-group">
                <label>Teams Call Queue Group Membership(s):</label>
                <div id="addCallQueueGroups" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control cq-group-select">
                      <option value="">Select call queue group...</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
              </div>

              <div class="form-group">
                <label>Teams Auto Attendant Authorized User (Manager):</label>
                <div id="addAutoAttendants" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control aa-select">
                      <option value="">Select auto attendant...</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
              </div>

              <div class="form-group">
                <label>Teams Call Queue Authorized User (Manager):</label>
                <div id="addCallQueueManagers" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control cq-select">
                      <option value="">Select call queue...</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
              </div>

              <div style="display:flex; gap:10px; margin-top:auto;">
                <button id="addUserSubmit" class="btn btn-primary submit-button" disabled style="flex:1;">
                  Add to Batch Queue
                </button>
                <button id="clearAddForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- MODIFY PHONE USER -->
            <div class="column">
              <div class="column-header">Modify a Teams Phone User</div>
              <div id="modifyUserMessages"></div>

              <div class="form-group">
                <label for="modifyUsername">Username:</label>
                <input type="text" id="modifyUsername" class="form-control"
                       placeholder="Enter MSOE email to lookup user"/>
                <button id="modifyLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup User</button>
              </div>

              <div id="currentUserInfo" class="user-info" style="display:none">
                <h4>Current User Settings:</h4>
                <div id="currentSettings"></div>
              </div>

              <div id="modifyPhoneGroup" class="form-group" style="display:none">
                <label>Change Phone Number:</label>
                <select id="modifyPhoneNumber" class="form-control">
                  <option value="">Select new phone number‚Ä¶</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="modifyReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div id="modifyIntlGroup" class="form-group" style="display:none">
                <label>International Calling:</label>
                <div class="radio-group">
                  <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
                  <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
                </div>
              </div>

              <div id="modifyButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                        style="display:none; flex:1;">Add Modification to Batch</button>
                <button id="clearModifyForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- DEPROVISION PHONE USER -->
            <div class="column">
              <div class="column-header">Deprovision a Teams Phone User</div>
              <div id="deprovisionUserMessages"></div>

              <div class="form-group">
                <label for="deprovisionUsername">Username:</label>
                <input type="text" id="deprovisionUsername" class="form-control"
                       placeholder="Enter MSOE email"/>
                <button id="deprovLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup User</button>
              </div>

              <div id="deprovisionUserInfo" class="user-info" style="display:none">
                <h4>User to be Deprovisioned:</h4>
                <div id="deprovisionSettings"></div>
              </div>

              <div id="deprovisionButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                        style="display:none; flex:1;">Add Deprovision to Batch</button>
                <button id="clearDeprovisionForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- RESERVE PHONE NUMBER -->
            <div class="column reservation-column">
              <div class="column-header">Reserve a Phone Number</div>
              <div id="reserveMessages"></div>

              <div class="form-group">
                <label for="reservePhoneNumber">Select Phone Number to Reserve:</label>
                <select id="reservePhoneNumber" class="form-control">
                  <option value="">Select phone number to reserve...</option>
                </select>
              </div>

              <div class="form-group">
                <label for="reserveNotes">Reservation Notes:</label>
                <textarea id="reserveNotes" class="form-control textarea" 
                          placeholder="Enter notes about this reservation (optional)"
                          maxlength="500"></textarea>
                <div class="char-counter">
                  <span id="charCount">0</span> / 500 characters
                </div>
              </div>

              <button id="reserveSubmit" class="btn btn-reserve submit-button" disabled style="width:100%;">
                Reserve Phone Number
              </button>

              <div style="margin-top:20px;border-top:1px solid #999;padding-top:15px;">
                <h4 style="margin-bottom:10px;color:#6b3aa0;">Currently Reserved Numbers:</h4>
                <div id="reservedNumbersList" class="dynamic-section">
                  <div class="batch-empty">Loading reserved numbers...</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT PANEL - Batch Operations -->
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Batch Operations Queue - Phone Users</div>
            
            <div class="batch-summary">
              <strong>Summary:</strong>
              <div>Adds: <span id="batchAddCount">0</span></div>
              <div>Modifications: <span id="batchModifyCount">0</span></div>
              <div>Deprovisions: <span id="batchDeprovisionCount">0</span></div>
              <div><strong>Total: <span id="batchTotalCount">0</span></strong></div>
            </div>

            <div id="batchTableContainer">
              <div id="batchEmptyMessage" class="batch-empty">
                No operations queued. Use the forms on the left to add operations to the batch.
              </div>
              <table id="batchTable" class="batch-table" style="display:none">
                <thead>
                  <tr>
                    <th>Action</th>
                    <th>Username</th>
                    <th>Details</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="batchTableBody">
                </tbody>
              </table>
            </div>

            <div style="margin-top:15px;">
              <button id="submitAllBatch" class="btn btn-success" style="width:100%; display:none">
                Submit All Operations
              </button>
              <button id="clearAllBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
                Clear All
              </button>
              <button id="resetPageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
                üîÑ Reset Page
              </button>
            </div>

            <div id="batchResults" style="margin-top:15px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CALL QUEUES TAB -->
    <div id="call-queues" class="tab-content">
      <div class="main-layout">
        <div class="left-panel">
          <div class="columns">
            <!-- ADD CALL QUEUE -->
            <div class="column">
              <div class="column-header">Add Call Queue</div>
              <div id="addCQMessages"></div>
              
              <div class="form-group">
                <label for="addCQName">Call Queue Name:</label>
                <input type="text" id="addCQName" class="form-control" 
                       placeholder="e.g., IT Support" maxlength="50"/>
                <div class="naming-preview">
                  <h5>Generated Names:</h5>
                  <div class="naming-item">UPN: <span id="cqUPNPreview">q_@msoe.edu</span></div>
                  <div class="naming-item">Display: <span id="cqDisplayPreview">Q </span></div>
                  <div class="naming-item">CQ Agent / Voicemail Group: <span id="cqAgentGroupPreview">qg@msoe.edu</span></div>
                </div>
              </div>

              <div class="form-group">
                <label for="addCQPhone">Phone Number:</label>
                <select id="addCQPhone" class="form-control">
                  <option value="">Select phone number...</option>
                </select>
              </div>

              <div style="display:flex; gap:10px; margin-top:auto;">
                <button id="addCQSubmit" class="btn btn-primary" style="flex:1;">
                  Add to Batch Queue
                </button>
                <button id="clearAddCQForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- MODIFY CALL QUEUE - Simplified for now -->
            <div class="column">
              <div class="column-header">Modify Call Queue</div>
              <div id="modifyCQMessages"></div>
              <p style="color:#666;font-style:italic;padding:20px;">Modification functionality coming soon</p>
            </div>

            <!-- DEPROVISION CALL QUEUE - Simplified for now -->
            <div class="column">
              <div class="column-header">Deprovision Call Queue</div>
              <div id="deprovCQMessages"></div>
              <p style="color:#666;font-style:italic;padding:20px;">Deprovision functionality coming soon</p>
            </div>
          </div>
        </div>

        <!-- RIGHT PANEL - CQ Batch Operations -->
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Call Queue Operations Queue</div>
            
            <div class="batch-summary">
              <strong>Summary:</strong>
              <div>Total: <span id="batchCQTotalCount">0</span></div>
            </div>

            <div id="batchCQTableContainer">
              <div id="batchCQEmptyMessage" class="batch-empty">
                No operations queued. Use the forms on the left to add operations.
              </div>
              <table id="batchCQTable" class="batch-table" style="display:none">
                <thead>
                  <tr>
                    <th>Call Queue</th>
                    <th>Phone</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="batchCQTableBody"></tbody>
              </table>
            </div>

            <div style="margin-top:15px;">
              <button id="submitAllCQBatch" class="btn btn-success" style="width:100%; display:none">
                Submit All CQ Operations
              </button>
              <button id="clearAllCQBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
                Clear All
              </button>
            </div>

            <div id="batchCQResults" style="margin-top:15px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Similar simplified structures for AUTO ATTENDANTS and AA/CQ PAIRS tabs -->
    <div id="auto-attendants" class="tab-content">
      <p style="padding:40px;text-align:center;color:#666;">Auto Attendants module - Coming soon</p>
    </div>

    <div id="aa-cq-pairs" class="tab-content">
      <p style="padding:40px;text-align:center;color:#666;">AA/CQ Pairs module - Coming soon</p>
    </div>

  </div>

<!-- Teams SDK -->
  <script src="https://statics.teams.microsoft.com/sdk/v1.11.0/js/MicrosoftTeams.min.js"></script>

  <script>
// CONFIGURATION
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'NULL'
    };

    // GLOBAL VARIABLES
    let phoneNumbers = [];
    let dropdownData = null;
    let currentUser = null;
    let reservedNumbers = [];
    let batchOperations = [];
    let batchCQOperations = [];
    let isTeamsEnvironment = false;
    
    // Mock data for testing
    const mockUsers = [
      { DisplayName: 'John Doe', UserPrincipalName: 'jdoe@msoe.edu' },
      { DisplayName: 'Jane Smith', UserPrincipalName: 'jsmith@msoe.edu' },
      { DisplayName: 'Bob Johnson', UserPrincipalName: 'bjohnson@msoe.edu' }
    ];
    
    const mockCallQueueGroups = [
      { DisplayName: 'IT Support Queue', Identity: 'qg_itsupport@msoe.edu' },
      { DisplayName: 'Admissions Queue', Identity: 'qg_admissions@msoe.edu' },
      { DisplayName: 'HR Queue', Identity: 'qg_hr@msoe.edu' }
    ];
    
    const mockAutoAttendants = [
      { Name: 'Main Reception AA', Identity: 'call_mainreception@msoe.edu' },
      { Name: 'IT Support AA', Identity: 'call_itsupport@msoe.edu' }
    ];
    
    const mockCallQueues = [
      { Name: 'IT Support CQ', Identity: 'q_itsupport@msoe.edu' },
      { Name: 'HR CQ', Identity: 'q_hr@msoe.edu' }
    ];

    // INITIALIZATION
    document.addEventListener('DOMContentLoaded', () => {
      initializeTeams();
      loadInitialData();
      setupEventHandlers();
    });

    function setupEventHandlers() {
      // Phone Users
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addReservedNumber').addEventListener('change', handleReservedNumberSelection);
      document.getElementById('addUserSubmit').onclick = addToBatch;
      document.getElementById('clearAddForm').onclick = clearAddForm;
      document.getElementById('modifyLookupBtn').addEventListener('click', lookupUser);
      document.getElementById('modifyUserSubmit').onclick = addModifyToBatch;
      document.getElementById('clearModifyForm').onclick = clearModifyForm;
      document.getElementById('deprovLookupBtn').addEventListener('click', lookupDeprovisionUser);
      document.getElementById('deprovisionUserSubmit').onclick = addDeprovisionToBatch;
      document.getElementById('clearDeprovisionForm').onclick = clearDeprovisionForm;
      document.getElementById('submitAllBatch').onclick = submitAllOperations;
      document.getElementById('clearAllBatch').onclick = clearAllBatch;
      document.getElementById('resetPageBtn').onclick = () => location.reload();
      document.getElementById('reservePhoneNumber').addEventListener('change', validateReserveForm);
      document.getElementById('reserveNotes').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
        validateReserveForm();
      });
      document.getElementById('reserveSubmit').onclick = reservePhoneNumber;

      // Call Queues
      document.getElementById('addCQName').addEventListener('input', updateCQNamingPreview);
      document.getElementById('addCQSubmit').onclick = addCQToBatch;
      document.getElementById('clearAddCQForm').onclick = clearCQForm;
      document.getElementById('submitAllCQBatch').onclick = submitAllCQOperations;
      document.getElementById('clearAllCQBatch').onclick = clearAllCQBatch;
    }

    // TAB MANAGEMENT
    function showTab(tabName, event) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    }

    // TEAMS INITIALIZATION
    function initializeTeams() {
      try {
        if (typeof microsoftTeams !== 'undefined') {
          microsoftTeams.initialize();
          isTeamsEnvironment = true;
          document.getElementById('teamsStatus').textContent = '‚úÖ Teams detected - SSO enabled';
          document.getElementById('teamsStatus').className = 'teams-status authenticated';
        } else {
          isTeamsEnvironment = false;
          document.getElementById('teamsStatus').textContent = '‚ö†Ô∏è Running outside Teams - using mock data';
          document.getElementById('teamsStatus').className = 'teams-status warning';
        }
      } catch (error) {
        isTeamsEnvironment = false;
        document.getElementById('teamsStatus').textContent = '‚ö†Ô∏è Teams initialization failed - using mock data';
        document.getElementById('teamsStatus').className = 'teams-status warning';
      }
    }

    // UTILITY FUNCTIONS
    function formatPhoneNumber(p){
      let d=p.replace(/\D/g,'');
      if(d.length===11&&d.startsWith('1')) return `+1 ${d.slice(1,4)} ${d.slice(4,7)} ${d.slice(7)}`;
      if(d.length===10) return `+1 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}`;
      return p;
    }

    function showMessage(id,msg,type){
      let c=document.getElementById(id);
      if(c) c.innerHTML=type?`<div class="${type}">${msg}</div>`:'';
    }

    function removeItem(btn){
      btn.parentNode.remove();
    }

    // DATA LOADING FUNCTIONS
    async function loadInitialData() {
      // Load phone numbers
      try {
        const response = await fetch(`${API.url}?code=${API.key}`);
        if (response.ok) {
          phoneNumbers = await response.json();
        } else {
          throw new Error('API failed');
        }
      } catch (error) {
        console.log('Using mock phone numbers');
        phoneNumbers = Array.from({length: 10}, (_, i) => ({
          AvailablePhoneNumber: `+1414555${String(i).padStart(4, '0')}`
        }));
      }

      // Load dropdown data
      try {
        const response = await fetch(`${API.url}?code=${API.key}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({action: 'getdropdowndata'})
        });
        if (response.ok) {
          dropdownData = await response.json();
        } else {
          throw new Error('API failed');
        }
      } catch (error) {
        console.log('Using mock dropdown data');
        dropdownData = {
          users: mockUsers,
          callQueueGroups: mockCallQueueGroups,
          autoAttendants: mockAutoAttendants,
          callQueues: mockCallQueues
        };
      }

      // Populate all dropdowns
      populateAllDropdowns();
    }

    function populateAllDropdowns() {
      // Phone number dropdowns
      const phoneSelects = ['addPhoneNumber', 'modifyPhoneNumber', 'reservePhoneNumber', 'addCQPhone'];
      phoneSelects.forEach(id => {
        const select = document.getElementById(id);
        if (select) {
          select.innerHTML = '<option value="">Select phone number...</option>';
          phoneNumbers.forEach(num => {
            const option = new Option(formatPhoneNumber(num.AvailablePhoneNumber), num.AvailablePhoneNumber);
            select.appendChild(option);
          });
        }
      });

      // User dropdown
      const userSelect = document.getElementById('addUsername');
      if (userSelect && dropdownData.users) {
        userSelect.innerHTML = '<option value="">Select a user...</option>';
        dropdownData.users.forEach(user => {
          const option = new Option(user.DisplayName + ' (' + user.UserPrincipalName + ')', user.UserPrincipalName);
          userSelect.appendChild(option);
        });
      }

      // Call Queue Groups
      const cqGroups = document.querySelectorAll('.cq-group-select');
      cqGroups.forEach(select => {
        select.innerHTML = '<option value="">Select call queue group...</option>';
        if (dropdownData.callQueueGroups) {
          dropdownData.callQueueGroups.forEach(group => {
            const option = new Option(group.DisplayName, group.Identity);
            select.appendChild(option);
          });
        }
      });

      // Auto Attendants
      const aaSelects = document.querySelectorAll('.aa-select');
      aaSelects.forEach(select => {
        select.innerHTML = '<option value="">Select auto attendant...</option>';
        if (dropdownData.autoAttendants) {
          dropdownData.autoAttendants.forEach(aa => {
            const option = new Option(aa.Name, aa.Identity);
            select.appendChild(option);
          });
        }
      });

      // Call Queues
      const cqSelects = document.querySelectorAll('.cq-select');
      cqSelects.forEach(select => {
        select.innerHTML = '<option value="">Select call queue...</option>';
        if (dropdownData.callQueues) {
          dropdownData.callQueues.forEach(cq => {
            const option = new Option(cq.Name, cq.Identity);
            select.appendChild(option);
          });
        }
      });
    }

    // PHONE USERS FUNCTIONS
    function validateAddForm() {
      const username = document.getElementById('addUsername').value;
      const phoneNumber = document.getElementById('addPhoneNumber').value;
      const reservedNumber = document.getElementById('addReservedNumber').value;
      const submitBtn = document.getElementById('addUserSubmit');
      
      submitBtn.disabled = !(username && (phoneNumber || reservedNumber));
    }

    function handleReservedNumberSelection() {
      const reserved = document.getElementById('addReservedNumber').value;
      const regular = document.getElementById('addPhoneNumber');
      
      if (reserved) {
        regular.value = '';
        regular.disabled = true;
      } else {
        regular.disabled = false;
      }
      validateAddForm();
    }

    function addToBatch() {
      const username = document.getElementById('addUsername').value;
      const phoneNumber = document.getElementById('addPhoneNumber').value || document.getElementById('addReservedNumber').value;
      const intlCalling = document.querySelector('input[name="addIntlCalling"]:checked').value;
      
      const operation = {
        action: 'add',
        username: username,
        phoneNumber: phoneNumber,
        intlCalling: intlCalling === 'yes'
      };
      
      batchOperations.push(operation);
      updateBatchTable();
      clearAddForm();
      showMessage('addUserMessages', 'User added to batch queue', 'success');
    }

    function clearAddForm() {
      document.getElementById('addUsername').selectedIndex = 0;
      document.getElementById('addPhoneNumber').selectedIndex = 0;
      document.getElementById('addReservedNumber').selectedIndex = 0;
      document.querySelector('input[name="addIntlCalling"][value="no"]').checked = true;
      validateAddForm();
      showMessage('addUserMessages', '', '');
    }

    function updateBatchTable() {
      const tbody = document.getElementById('batchTableBody');
      const table = document.getElementById('batchTable');
      const emptyMsg = document.getElementById('batchEmptyMessage');
      const submitBtn = document.getElementById('submitAllBatch');
      const clearBtn = document.getElementById('clearAllBatch');
      
      if (batchOperations.length === 0) {
        table.style.display = 'none';
        emptyMsg.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        table.style.display = 'table';
        emptyMsg.style.display = 'none';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        
        tbody.innerHTML = batchOperations.map((op, idx) => {
          let actionClass = op.action === 'add' ? 'action-add' : op.action === 'modify' ? 'action-modify' : 'action-deprovision';
          let details = '';
          if (op.action === 'add') {
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}, Intl: ${op.intlCalling ? 'Yes' : 'No'}`;
          } else if (op.action === 'modify') {
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}`;
          } else {
            details = 'Remove voice services';
          }
          
          return `
            <tr class="${actionClass}">
              <td>${op.action.charAt(0).toUpperCase() + op.action.slice(1)}</td>
              <td>${op.username}</td>
              <td>${details}</td>
              <td><button class="remove-batch-item" onclick="removeBatchItem(${idx})">X</button></td>
            </tr>`;
        }).join('');
      }
      
      const addCount = batchOperations.filter(op => op.action === 'add').length;
      const modifyCount = batchOperations.filter(op => op.action === 'modify').length;
      const deprovCount = batchOperations.filter(op => op.action === 'deprovision').length;
      
      document.getElementById('batchAddCount').textContent = addCount;
      document.getElementById('batchModifyCount').textContent = modifyCount;
      document.getElementById('batchDeprovisionCount').textContent = deprovCount;
      document.getElementById('batchTotalCount').textContent = batchOperations.length;
    }

    function removeBatchItem(index) {
      batchOperations.splice(index, 1);
      updateBatchTable();
    }

    function lookupUser() {
      const username = document.getElementById('modifyUsername').value;
      if (!username) {
        showMessage('modifyUserMessages', 'Please enter a username', 'error');
        return;
      }
      
      // Mock user data
      currentUser = {
        username: username,
        phoneNumber: '+14145551234',
        intlCalling: false
      };
      
      document.getElementById('currentUserInfo').style.display = 'block';
      document.getElementById('currentSettings').innerHTML = `
        <div class="current-setting">Phone: <span>${formatPhoneNumber(currentUser.phoneNumber)}</span></div>
        <div class="current-setting">International: <span>${currentUser.intlCalling ? 'Yes' : 'No'}</span></div>
      `;
      
      document.getElementById('modifyPhoneGroup').style.display = 'block';
      document.getElementById('modifyIntlGroup').style.display = 'block';
      document.getElementById('modifyUserSubmit').style.display = 'block';
    }

    function addModifyToBatch() {
      if (!currentUser) return;
      
      const newPhone = document.getElementById('modifyPhoneNumber').value;
      const operation = {
        action: 'modify',
        username: currentUser.username,
        phoneNumber: newPhone || currentUser.phoneNumber
      };
      
      batchOperations.push(operation);
      updateBatchTable();
      clearModifyForm();
      showMessage('modifyUserMessages', 'Modification added to batch', 'success');
    }

    function clearModifyForm() {
      document.getElementById('modifyUsername').value = '';
      document.getElementById('currentUserInfo').style.display = 'none';
      document.getElementById('modifyPhoneGroup').style.display = 'none';
      document.getElementById('modifyIntlGroup').style.display = 'none';
      document.getElementById('modifyUserSubmit').style.display = 'none';
      currentUser = null;
      showMessage('modifyUserMessages', '', '');
    }

    function lookupDeprovisionUser() {
      const username = document.getElementById('deprovisionUsername').value;
      if (!username) {
        showMessage('deprovisionUserMessages', 'Please enter a username', 'error');
        return;
      }
      
      currentUser = {
        username: username,
        phoneNumber: '+14145551234'
      };
      
      document.getElementById('deprovisionUserInfo').style.display = 'block';
      document.getElementById('deprovisionSettings').innerHTML = `
        <div class="current-setting">Username: <span>${currentUser.username}</span></div>
        <div class="current-setting">Phone: <span>${formatPhoneNumber(currentUser.phoneNumber)}</span></div>
      `;
      
      document.getElementById('deprovisionUserSubmit').style.display = 'block';
    }

    function addDeprovisionToBatch() {
      if (!currentUser) return;
      
      const operation = {
        action: 'deprovision',
        username: currentUser.username,
        phoneNumber: currentUser.phoneNumber
      };
      
      batchOperations.push(operation);
      updateBatchTable();
      clearDeprovisionForm();
      showMessage('deprovisionUserMessages', 'Deprovision added to batch', 'success');
    }

    function clearDeprovisionForm() {
      document.getElementById('deprovisionUsername').value = '';
      document.getElementById('deprovisionUserInfo').style.display = 'none';
      document.getElementById('deprovisionUserSubmit').style.display = 'none';
      currentUser = null;
      showMessage('deprovisionUserMessages', '', '');
    }

    function submitAllOperations() {
      showMessage('batchResults', 'Operations submitted successfully (mock)', 'success');
      document.getElementById('resetPageBtn').style.display = 'block';
    }

    function clearAllBatch() {
      batchOperations = [];
      updateBatchTable();
    }

    function validateReserveForm() {
      const phone = document.getElementById('reservePhoneNumber').value;
      document.getElementById('reserveSubmit').disabled = !phone;
    }

    function reservePhoneNumber() {
      showMessage('reserveMessages', 'Phone number reserved successfully (mock)', 'success');
      document.getElementById('reservePhoneNumber').selectedIndex = 0;
      document.getElementById('reserveNotes').value = '';
      document.getElementById('charCount').textContent = '0';
    }

    function addCallQueueGroup() {
      const container = document.getElementById('addCallQueueGroups');
      const newItem = document.createElement('div');
      newItem.className = 'dynamic-item';
      newItem.innerHTML = `
        <select class="form-control cq-group-select">
          <option value="">Select call queue group...</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
      `;
      container.appendChild(newItem);
      populateAllDropdowns();
    }

    function addAutoAttendant() {
      const container = document.getElementById('addAutoAttendants');
      const newItem = document.createElement('div');
      newItem.className = 'dynamic-item';
      newItem.innerHTML = `
        <select class="form-control aa-select">
          <option value="">Select auto attendant...</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
      `;
      container.appendChild(newItem);
      populateAllDropdowns();
    }

    function addCallQueueManager() {
      const container = document.getElementById('addCallQueueManagers');
      const newItem = document.createElement('div');
      newItem.className = 'dynamic-item';
      newItem.innerHTML = `
        <select class="form-control cq-select">
          <option value="">Select call queue...</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
      `;
      container.appendChild(newItem);
      populateAllDropdowns();
    }

    // CALL QUEUE FUNCTIONS
    function updateCQNamingPreview() {
      const name = document.getElementById('addCQName').value.toLowerCase().replace(/\s+/g, '');
      document.getElementById('cqUPNPreview').textContent = name ? `q_${name}@msoe.edu` : 'q_@msoe.edu';
      document.getElementById('cqDisplayPreview').textContent = name ? `Q ${document.getElementById('addCQName').value}` : 'Q ';
      document.getElementById('cqAgentGroupPreview').textContent = name ? `qg${name}@msoe.edu` : 'qg@msoe.edu';
    }

    function addCQToBatch() {
      const name = document.getElementById('addCQName').value;
      const phone = document.getElementById('addCQPhone').value;
      
      if (!name || !phone) {
        showMessage('addCQMessages', 'Please fill in all fields', 'error');
        return;
      }
      
      batchCQOperations.push({name, phone});
      updateCQBatchTable();
      clearCQForm();
      showMessage('addCQMessages', 'Call Queue added to batch', 'success');
    }

    function clearCQForm() {
      document.getElementById('addCQName').value = '';
      document.getElementById('addCQPhone').selectedIndex = 0;
      updateCQNamingPreview();
      showMessage('addCQMessages', '', '');
    }

    function updateCQBatchTable() {
      const tbody = document.getElementById('batchCQTableBody');
      const table = document.getElementById('batchCQTable');
      const emptyMsg = document.getElementById('batchCQEmptyMessage');
      const submitBtn = document.getElementById('submitAllCQBatch');
      const clearBtn = document.getElementById('clearAllCQBatch');
      
      if (batchCQOperations.length === 0) {
        table.style.display = 'none';
        emptyMsg.style.display = 'block';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        table.style.display = 'table';
        emptyMsg.style.display = 'none';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        
        tbody.innerHTML = batchCQOperations.map((op, idx) => `
          <tr>
            <td>${op.name}</td>
            <td>${formatPhoneNumber(op.phone)}</td>
            <td><button class="remove-batch-item" onclick="removeCQBatchItem(${idx})">X</button></td>
          </tr>`
        ).join('');
      }
      
      document.getElementById('batchCQTotalCount').textContent = batchCQOperations.length;
    }

    function removeCQBatchItem(index) {
      batchCQOperations.splice(index, 1);
      updateCQBatchTable();
    }

    function submitAllCQOperations() {
      showMessage('batchCQResults', 'Call Queue operations submitted (mock)', 'success');
    }

    function clearAllCQBatch() {
      batchCQOperations = [];
      updateCQBatchTable();
    }

  </script>
</body>
</html>
