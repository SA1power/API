<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Phone User Provisioning</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .main-layout{display:flex;gap:20px;flex-wrap:wrap}
    .left-panel{flex:2;min-width:800px}
    .right-panel{flex:1;min-width:400px}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-small{padding:4px 8px;font-size:12px}
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    .error{background:#ffe6e6;color:#cc0000;padding:10px;border:1px solid #cc0000;border-radius:4px;margin-bottom:15px}
    .warning{background:#fff3cd;color:#856404;padding:10px;border:1px solid #ffeaa7;border-radius:4px;margin-bottom:15px}
    .help-text{font-size:12px;color:#666;margin-top:3px;font-style:italic}
    
    /* Batch Operations Table Styles */
    .batch-panel{background:#f0f8ff;border:2px solid #4169e1;border-radius:4px;padding:20px}
    .batch-header{background:#4169e1;color:white;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #4169e1}
    .batch-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .batch-table th,.batch-table td{border:1px solid #ddd;padding:8px;text-align:left}
    .batch-table th{background:#e6f2ff;font-weight:bold}
    .batch-table .action-add{background:#e8f5e8}
    .batch-table .action-modify{background:#fff3cd}
    .batch-table .action-deprovision{background:#f8d7da}
    .batch-summary{background:#fff;border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:15px}
    .remove-batch-item{background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px}
    .remove-batch-item:hover{background:#c82333}
    .batch-empty{text-align:center;color:#666;font-style:italic;padding:20px}
    
    /* Teams status indicator */
    .teams-status{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px;text-align:center}
    .teams-status.authenticated{background:#e8f5e8;border-color:#4caf50;color:#2e7d32}
    .teams-status.error{background:#ffebee;border-color:#f44336;color:#c62828}
    
    @media(max-width:1200px){
      .main-layout{flex-direction:column}
      .left-panel,.right-panel{min-width:auto}
    }
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <!-- Teams Authentication Status -->
    <div id="teamsStatus" class="teams-status">
      ðŸ”„ Initializing Teams integration...
    </div>

    <div class="main-layout">
      
      <!-- LEFT PANEL - Forms -->
      <div class="left-panel">
        <div class="columns">

          <!-- ADD -->
          <div class="column">
            <div class="column-header">Add a Teams Phone User</div>
            <div id="addUserMessages"></div>

            <div class="form-group">
              <label for="addUsername">Select User:</label>
              <select id="addUsername" class="form-control">
                <option value="">Loading usersâ€¦</option>
              </select>
              <div class="help-text">(A5 Faculty non-enterprise voice enabled)</div>
            </div>

            <div class="form-group">
              <label for="addPhoneNumber">Pick an available phone number:</label>
              <select id="addPhoneNumber" class="form-control">
                <option value="">Loading numbersâ€¦</option>
              </select>
            </div>

            <div class="form-group">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
                <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
              </div>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="addCallQueueGroups" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-group-select">
                    <option value="">Loading Call Queue Groupsâ€¦</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
            </div>

            <div class="form-group">
              <label>Teams Auto Attendant Authorized User (Manager):</label>
              <div id="addAutoAttendants" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control aa-select">
                    <option value="">Loading Auto Attendantsâ€¦</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Authorized User (Manager):</label>
              <div id="addCallQueueManagers" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-select">
                    <option value="">Loading Call Queuesâ€¦</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
            </div>

            <div style="display:flex; gap:10px; margin-top:auto;">
              <button id="addUserSubmit" class="btn btn-primary submit-button" disabled style="flex:1;">
                Add to Batch Queue
              </button>
              <button id="clearAddForm" class="btn btn-secondary" style="flex:0 0 auto;">
                Clear Form
              </button>
            </div>
          </div>


          <!-- MODIFY -->
          <div class="column">
            <div class="column-header">Modify a Teams Phone User</div>
            <div id="modifyUserMessages"></div>

            <div class="form-group">
              <label for="modifyUsername">Username:</label>
              <input type="text" id="modifyUsername" class="form-control"
                     placeholder="Enter MSOE email to lookup user"/>
              <button id="modifyLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="currentUserInfo" class="user-info" style="display:none">
              <h4>Current User Settings:</h4>
              <div id="currentSettings"></div>
            </div>

            <div id="modifyPhoneGroup" class="form-group" style="display:none">
              <label>Change Phone Number:</label>
              <select id="modifyPhoneNumber" class="form-control">
                <option value="">Select new phone numberâ€¦</option>
              </select>
            </div>

            <div id="modifyIntlGroup" class="form-group" style="display:none">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
                <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
              </div>
            </div>

            <div id="modifyCallQueueGroupsGroup" class="form-group" style="display:none">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="currentCallQueueGroups">
                <h5 style="color:#1976d2">Current Group Memberships:</h5>
                <div id="currentCallQueueGroupsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueGroupSelect" class="form-control cq-group-select">
                    <option value="">Select to addâ€¦</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueGroupMembership()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyAutoAttendantsGroup" class="form-group" style="display:none">
              <label>Add Auto Attendant Manager:</label>
              <div id="currentAutoAttendants">
                <h5 style="color:#1976d2">Current Auto Attendants:</h5>
                <div id="currentAutoAttendantsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newAutoAttendantSelect" class="form-control aa-select">
                    <option value="">Select to addâ€¦</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addAutoAttendantRole()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyCallQueueManagersGroup" class="form-group" style="display:none">
              <label>Add Call Queue Manager:</label>
              <div id="currentCallQueueManagers">
                <h5 style="color:#1976d2">Current CQ Managers:</h5>
                <div id="currentCallQueueManagersList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueSelect" class="form-control cq-select">
                    <option value="">Select to addâ€¦</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueRole()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
              <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                      style="display:none; flex:1;">Add Modification to Batch</button>
              <button id="clearModifyForm" class="btn btn-secondary" style="flex:0 0 auto;">
                Clear Form
              </button>
            </div>
          </div>


          <!-- DEPROVISION -->
          <div class="column">
            <div class="column-header">Deprovision a Teams Phone User</div>
            <div id="deprovisionUserMessages"></div>

            <div class="form-group">
              <label for="deprovisionUsername">Username:</label>
              <input type="text" id="deprovisionUsername" class="form-control"
                     placeholder="Enter MSOE email"/>
              <button id="deprovLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="deprovisionUserInfo" class="user-info" style="display:none">
              <h4>User to be Deprovisioned:</h4>
              <div id="deprovisionSettings"></div>
            </div>

            <div id="deprovisionButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
              <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                      style="display:none; flex:1;">Add Deprovision to Batch</button>
              <button id="clearDeprovisionForm" class="btn btn-secondary" style="flex:0 0 auto;">
                Clear Form
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT PANEL - Batch Operations -->
      <div class="right-panel">
        <div class="batch-panel">
          <div class="batch-header">Batch Operations Queue</div>
          
          <div class="batch-summary">
            <strong>Summary:</strong>
            <div>Adds: <span id="batchAddCount">0</span></div>
            <div>Modifications: <span id="batchModifyCount">0</span></div>
            <div>Deprovisions: <span id="batchDeprovisionCount">0</span></div>
            <div><strong>Total: <span id="batchTotalCount">0</span></strong></div>
          </div>

          <div id="batchTableContainer">
            <div id="batchEmptyMessage" class="batch-empty">
              No operations queued. Use the forms on the left to add operations to the batch.
            </div>
            <table id="batchTable" class="batch-table" style="display:none">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Username</th>
                  <th>Details</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="batchTableBody">
              </tbody>
            </table>
          </div>

          <div style="margin-top:15px;">
            <button id="submitAllBatch" class="btn btn-success" style="width:100%; display:none">
              Submit All Operations
            </button>
            <button id="clearAllBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
              Clear All
            </button>
            <button id="resetPageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
              ðŸ”„ Reset Page
            </button>
          </div>

          <div id="batchResults" style="margin-top:15px;"></div>
        </div>
      </div>

    </div>
  </div>

  <!-- Teams SDK - Try multiple versions for compatibility -->
  <script src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js" 
          onerror="console.log('Teams SDK 2.0 failed, trying 1.11'); loadTeamsSDKFallback();"></script>
  <script>
    function loadTeamsSDKFallback() {
      const script = document.createElement('script');
      script.src = 'https://statics.teams.cdn.office.net/sdk/v1.11.0/js/MicrosoftTeams.min.js';
      script.onload = () => console.log('Teams SDK 1.11 loaded successfully');
      script.onerror = () => console.log('Teams SDK 1.11 also failed');
      document.head.appendChild(script);
    }
  </script>

  <script>
    // Configuration
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
    };

    const AZURE_CONFIG = {
      functionAppClientId: 'f2068d39-85c7-4507-9fd3-0758b193b0a9',
      functionAppUrl: 'https://provisionteamsphonesystemusers-a5b3b9fjcxcva8g4.northcentralus-01.azurewebsites.net/api/TriggerRunbook'
    };

    // Global variables
    let phoneNumbers = [], dropdownData = null, currentUser = null;
    let batchOperations = [];
    let teamsContext = null;
    let isTeamsEnvironment = false;

    // Teams initialization with timeout and compatibility fixes
    async function initializeTeams() {
      console.log('=== TEAMS INITIALIZATION START ===');
      console.log('Current URL:', window.location.href);
      console.log('In iframe:', window.self !== window.top);
      console.log('User Agent:', navigator.userAgent);
      
      // Check if Teams SDK is available
      if (typeof microsoftTeams === 'undefined') {
        console.log('Teams SDK not available');
        isTeamsEnvironment = false;
        updateTeamsStatus('âš ï¸ Teams SDK not available - using fallback authentication', 'warning');
        return;
      }
      
      console.log('Teams SDK available, version check...');
      console.log('Teams SDK object:', microsoftTeams);
      
      try {
        // Different initialization approaches based on SDK version
        let initializationSuccessful = false;
        
        // Try modern SDK approach first (v2.0+)
        if (microsoftTeams.app && typeof microsoftTeams.app.initialize === 'function') {
          console.log('Trying modern SDK (v2.0+) initialization...');
          try {
            await Promise.race([
              microsoftTeams.app.initialize(),
              new Promise((_, reject) => setTimeout(() => reject(new Error('Modern init timeout')), 3000))
            ]);
            console.log('Modern SDK initialization successful');
            initializationSuccessful = true;
            
            // Get context with modern SDK
            try {
              teamsContext = await Promise.race([
                microsoftTeams.app.getContext(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Context timeout')), 2000))
              ]);
              console.log('Modern context obtained:', teamsContext);
            } catch (contextError) {
              console.log('Modern context failed:', contextError);
              teamsContext = { app: { host: { name: 'Teams' } } }; // Mock context
            }
            
          } catch (modernError) {
            console.log('Modern SDK failed:', modernError);
          }
        }
        
        // Try legacy SDK approach (v1.x) if modern failed
        if (!initializationSuccessful && microsoftTeams.initialize && typeof microsoftTeams.initialize === 'function') {
          console.log('Trying legacy SDK (v1.x) initialization...');
          try {
            await new Promise((resolve, reject) => {
              const timeout = setTimeout(() => reject(new Error('Legacy init timeout')), 3000);
              microsoftTeams.initialize(() => {
                clearTimeout(timeout);
                console.log('Legacy SDK initialization successful');
                resolve();
              });
            });
            initializationSuccessful = true;
            
            // Get context with legacy SDK
            try {
              teamsContext = await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('Legacy context timeout')), 2000);
                microsoftTeams.getContext((context) => {
                  clearTimeout(timeout);
                  console.log('Legacy context obtained:', context);
                  resolve(context);
                });
              });
            } catch (contextError) {
              console.log('Legacy context failed:', contextError);
              teamsContext = { entityId: 'teams-app' }; // Mock legacy context
            }
            
          } catch (legacyError) {
            console.log('Legacy SDK failed:', legacyError);
          }
        }
        
        // If we're in an iframe but initialization failed, assume Teams anyway
        const inIframe = window.self !== window.top;
        if (!initializationSuccessful && inIframe) {
          console.log('Initialization failed but detected iframe - assuming Teams environment');
          initializationSuccessful = true;
          teamsContext = { app: { host: { name: 'Teams' } } };
        }
        
        if (initializationSuccessful) {
          isTeamsEnvironment = true;
          updateTeamsStatus('âœ… Teams detected - SSO enabled', 'authenticated');
          console.log('Teams environment confirmed');
          
          // Test SSO with both SDK versions
          await testSSOCapability();
          
        } else {
          throw new Error('All initialization methods failed');
        }
        
      } catch (error) {
        console.error('Teams initialization completely failed:', error);
        isTeamsEnvironment = false;
        updateTeamsStatus(`âš ï¸ Teams init failed: ${error.message} - using fallback`, 'warning');
      }
      
      console.log('=== TEAMS INITIALIZATION END ===');
      console.log('Final isTeamsEnvironment:', isTeamsEnvironment);
    }
    
    async function testSSOCapability() {
      try {
        console.log('Testing SSO capability...');
        
        let ssoToken = null;
        
        // Try modern SDK SSO
        if (microsoftTeams.authentication && microsoftTeams.authentication.getAuthToken) {
          try {
            ssoToken = await microsoftTeams.authentication.getAuthToken({
              resources: [`api://${AZURE_CONFIG.functionAppClientId}/.default`],
              silent: true
            });
            console.log('Modern SSO successful');
          } catch (modernSSOError) {
            console.log('Modern SSO failed:', modernSSOError);
          }
        }
        
        // Try legacy SDK SSO if modern failed
        if (!ssoToken && microsoftTeams.authentication && microsoftTeams.authentication.getAuthToken) {
          try {
            ssoToken = await new Promise((resolve, reject) => {
              microsoftTeams.authentication.getAuthToken({
                resources: [`api://${AZURE_CONFIG.functionAppClientId}/.default`],
                successCallback: resolve,
                failureCallback: reject
              });
            });
            console.log('Legacy SSO successful');
          } catch (legacySSOError) {
            console.log('Legacy SSO failed:', legacySSOError);
          }
        }
        
        if (ssoToken) {
          updateTeamsStatus('âœ… Teams authenticated - SSO confirmed working', 'authenticated');
        } else {
          updateTeamsStatus('âœ… Teams detected - SSO available (may need consent)', 'authenticated');
        }
        
      } catch (ssoError) {
        console.warn('SSO test failed:', ssoError);
        updateTeamsStatus('âœ… Teams detected - SSO available (may need consent)', 'authenticated');
      }
    }

    function updateTeamsStatus(message, type = '') {
      const statusEl = document.getElementById('teamsStatus');
      statusEl.textContent = message;
      statusEl.className = `teams-status ${type}`;
    }

    // Enhanced authentication for batch operations
    async function getAuthToken() {
      if (!isTeamsEnvironment) {
        console.log('Not in Teams environment, skipping SSO');
        return null;
      }

      try {
        console.log('Attempting to get auth token...');
        const token = await microsoftTeams.authentication.getAuthToken({
          resources: [`api://${AZURE_CONFIG.functionAppClientId}/.default`]
        });
        console.log('Successfully obtained auth token');
        return token;
      } catch (error) {
        console.error('Failed to get auth token:', error);
        
        // If token fails, try interactive authentication
        try {
          console.log('Attempting interactive authentication...');
          const interactiveToken = await microsoftTeams.authentication.authenticate({
            url: `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${AZURE_CONFIG.functionAppClientId}&response_type=token&scope=api://${AZURE_CONFIG.functionAppClientId}/.default&redirect_uri=${encodeURIComponent(window.location.origin)}`,
            width: 600,
            height: 535
          });
          return interactiveToken;
        } catch (interactiveError) {
          console.error('Interactive authentication also failed:', interactiveError);
          throw new Error(`Authentication failed: ${error.message}`);
        }
      }
    }

    // Enhanced submit function with SSO
    async function submitAllOperations() {
      if (batchOperations.length === 0) return;

      const submitBtn = document.getElementById('submitAllBatch');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;

      try {
        // Always try the Azure Function first (whether in Teams or not)
        submitBtn.textContent = 'ðŸ” Authenticating...';
        
        let authHeaders = {};
        
        if (isTeamsEnvironment) {
          // Try to get Teams SSO token
          try {
            const token = await getAuthToken();
            if (token) {
              authHeaders['Authorization'] = `Bearer ${token}`;
              console.log('Using Teams SSO token');
            }
          } catch (authError) {
            console.warn('Teams SSO failed, proceeding without token:', authError);
            updateTeamsStatus('âš ï¸ SSO failed - proceeding with function key auth', 'warning');
          }
        }
        
        // If no SSO token, we'll rely on the function's configured authentication
        submitBtn.textContent = 'âš™ï¸ Processing Operations...';
        
        console.log('Calling Azure Function with payload:', { operations: batchOperations });
        
        const response = await fetch(AZURE_CONFIG.functionAppUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...authHeaders
          },
          body: JSON.stringify({ operations: batchOperations })
        });

        console.log('Azure Function response status:', response.status);
        
        if (response.ok) {
          const result = await response.json();
          console.log('Azure Function success response:', result);
          
          displayBatchResults([{
            operation: { action: 'batch', username: 'system' },
            success: true,
            message: result.message || 'All operations completed successfully via Azure Function'
          }], 1, 0);
          
          // Clear successful operations
          batchOperations = [];
          
        } else {
          // If Azure Function fails, fall back to individual API calls
          const errorText = await response.text();
          console.error('Azure Function failed:', response.status, errorText);
          
          updateTeamsStatus('âš ï¸ Azure Function unavailable - using fallback API', 'warning');
          submitBtn.textContent = 'âš™ï¸ Using fallback API...';
          
          // Fallback to original individual API calls
          await executeIndividualOperations(submitBtn);
        }

      } catch (error) {
        console.error('Network error calling Azure Function:', error);
        
        // Network error - try fallback
        updateTeamsStatus('âš ï¸ Network error - using fallback API', 'warning');
        submitBtn.textContent = 'âš™ï¸ Using fallback API...';
        
        await executeIndividualOperations(submitBtn);
        
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        updateBatchTable();
        populatePhoneDropdowns();
      }
    }

    // Fallback function for individual API calls
    async function executeIndividualOperations(submitBtn) {
      const results = [];
      let successCount = 0;
      let errorCount = 0;

      for (let operation of batchOperations) {
        try {
          submitBtn.textContent = `âš™ï¸ Processing ${operation.action} for ${operation.username}...`;
          
          const response = await fetch(`${API.url}?code=${API.key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(operation)
          });

          if (response.ok) {
            const result = await response.json();
            results.push({
              operation: operation,
              success: true,
              message: result.message || `${operation.action} successful`
            });
            successCount++;
          } else {
            const error = await response.json();
            results.push({
              operation: operation,
              success: false,
              message: error.error || 'Unknown error'
            });
            errorCount++;
          }
        } catch (error) {
          results.push({
            operation: operation,
            success: false,
            message: error.message || 'Network error'
          });
          errorCount++;
        }
      }

      displayBatchResults(results, successCount, errorCount);
      batchOperations = batchOperations.filter(op => 
        !results.find(r => r.operation.id === op.id && r.success)
      );
    }

    async function handleBatchResponse(response) {
      if (response.ok) {
        const result = await response.json();
        displayBatchResults([{
          operation: { action: 'batch', username: 'system' },
          success: true,
          message: result.message || 'All operations completed successfully via Azure Function'
        }], 1, 0);
        
        // Clear successful operations
        batchOperations = [];
        
      } else {
        const errorText = await response.text();
        let errorMessage;
        
        try {
          const errorJson = JSON.parse(errorText);
          errorMessage = errorJson.error || errorJson.message || `HTTP ${response.status}: ${response.statusText}`;
        } catch (e) {
          errorMessage = `HTTP ${response.status}: ${response.statusText} - ${errorText}`;
        }
        
        console.error('Azure Function error:', errorMessage);
        
        displayBatchResults([{
          operation: { action: 'batch', username: 'system' },
          success: false,
          message: errorMessage
        }], 0, 1);
      }
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM loaded, starting initialization...');
      console.log('Current URL:', window.location.href);
      console.log('Referrer:', document.referrer);
      console.log('In iframe:', window.self !== window.top);
      
      // Initialize Teams first
      await initializeTeams();
      
      // Add a manual Teams check button for debugging
      const teamsStatus = document.getElementById('teamsStatus');
      const debugButton = document.createElement('button');
      debugButton.textContent = 'ðŸ” Debug Teams Connection';
      debugButton.className = 'btn btn-secondary btn-small';
      debugButton.style.marginLeft = '10px';
      debugButton.onclick = function() {
        console.log('=== MANUAL TEAMS DEBUG ===');
        console.log('Teams SDK available:', typeof microsoftTeams !== 'undefined');
        console.log('In iframe:', window.self !== window.top);
        console.log('URL:', window.location.href);
        console.log('Referrer:', document.referrer);
        console.log('User Agent:', navigator.userAgent);
        console.log('Current isTeamsEnvironment:', isTeamsEnvironment);
        console.log('Current teamsContext:', teamsContext);
        
        // Test if Teams object has expected methods
        if (typeof microsoftTeams !== 'undefined') {
          console.log('Teams object structure:');
          console.log('- microsoftTeams.app:', typeof microsoftTeams.app);
          console.log('- microsoftTeams.initialize:', typeof microsoftTeams.initialize);
          console.log('- microsoftTeams.authentication:', typeof microsoftTeams.authentication);
          
          if (microsoftTeams.app) {
            console.log('- microsoftTeams.app.initialize:', typeof microsoftTeams.app.initialize);
            console.log('- microsoftTeams.app.getContext:', typeof microsoftTeams.app.getContext);
          }
          
          // Manual test of Teams initialization
          console.log('Attempting manual Teams test...');
          
          if (microsoftTeams.app && microsoftTeams.app.initialize) {
            microsoftTeams.app.initialize()
              .then(() => {
                console.log('Manual modern init: SUCCESS');
                return microsoftTeams.app.getContext();
              })
              .then(context => {
                console.log('Manual modern context: SUCCESS', context);
              })
              .catch(error => {
                console.log('Manual modern test: FAILED', error);
              });
          } else if (microsoftTeams.initialize) {
            microsoftTeams.initialize(() => {
              console.log('Manual legacy init: SUCCESS');
              microsoftTeams.getContext(context => {
                console.log('Manual legacy context: SUCCESS', context);
              });
            });
          }
        } else {
          console.log('Teams SDK not loaded at all');
        }
        
        console.log('=== END MANUAL DEBUG ===');
        
        // Visual feedback
        const originalText = debugButton.textContent;
        debugButton.textContent = 'âœ… Debug Complete (check console)';
        debugButton.style.background = '#28a745';
        setTimeout(() => {
          debugButton.textContent = originalText;
          debugButton.style.background = '';
        }, 3000);
      };
      teamsStatus.appendChild(debugButton);
      
      // Load data
      loadPhoneNumbers();

      // ADD form events
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addUserSubmit').onclick = addToBatch;
      document.getElementById('clearAddForm').onclick = clearAddFormOnly;
      
      // MODIFY form events
      document.getElementById('modifyLookupBtn').addEventListener('click', lookupUser);
      document.getElementById('modifyUserSubmit').onclick = addModifyToBatch;
      document.getElementById('clearModifyForm').onclick = clearModifyFormOnly;
      document.getElementById('modifyUsername').addEventListener('input', () => {
        const modifyField = document.getElementById('modifyUsername');
        const deprovisionField = document.getElementById('deprovisionUsername');
        validateUsername(modifyField, deprovisionField, 'modifyUserMessages', 'Deprovision');
      });

      // DEPROVISION form events
      document.getElementById('deprovLookupBtn').addEventListener('click', lookupDeprovisionUser);
      document.getElementById('deprovisionUserSubmit').onclick = addDeprovisionToBatch;
      document.getElementById('clearDeprovisionForm').onclick = clearDeprovisionFormOnly;
      document.getElementById('deprovisionUsername').addEventListener('input', () => {
        const deprovisionField = document.getElementById('deprovisionUsername');
        const modifyField = document.getElementById('modifyUsername');
        validateUsername(deprovisionField, modifyField, 'deprovisionUserMessages', 'Modify');
      });

      // BATCH operation events
      document.getElementById('submitAllBatch').onclick = submitAllOperations;
      document.getElementById('clearAllBatch').onclick = clearAllBatch;
      document.getElementById('resetPageBtn').onclick = resetPage;
    });

    // [Rest of the existing functions remain unchanged - keeping them exactly as they were]
    
    async function loadPhoneNumbers() {
      let r = await fetch(`${API.url}?code=${API.key}`);
      if (!r.ok) return console.error('Phone fetch failed');
      phoneNumbers = await r.json();
      populatePhoneDropdowns();

      r = await fetch(`${API.url}?code=${API.key}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'getdropdowndata'})
      });
      if (!r.ok) return console.error('Dropdown fetch failed');
      dropdownData = await r.json();
      populateDropdowns();
    }

    function populateDropdowns() {
      const uSel = document.getElementById('addUsername');
      uSel.innerHTML = '<option value="">Select a userâ€¦</option>';
      (dropdownData.a5Users||[]).forEach(u=>uSel.appendChild(new Option(u,u)));

      document.querySelectorAll('.cq-group-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue Groupâ€¦</option>';
        (dropdownData.callQueueGroups||[]).forEach(g=>sel.appendChild(new Option(g,g)));
      });

      document.querySelectorAll('.aa-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Auto Attendantâ€¦</option>';
        (dropdownData.autoAttendants||[]).forEach(a=>sel.appendChild(new Option(a,a)));
      });

      document.querySelectorAll('.cq-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queueâ€¦</option>';
        (dropdownData.callQueues||[]).forEach(q=>sel.appendChild(new Option(q,q)));
      });
    }

    function populatePhoneDropdowns() {
      const p1 = document.getElementById('addPhoneNumber');
      p1.innerHTML = '<option value="">Select a phone numberâ€¦</option>';
      phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
        .forEach(i=>p1.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      const p2 = document.getElementById('modifyPhoneNumber');
      if(p2){
        p2.innerHTML = '<option value="">Select a phone numberâ€¦</option>';
        phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
          .forEach(i=>p2.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      }
    }

    function validateAddForm(){
      const u=!!document.getElementById('addUsername').value;
      const p=!!document.getElementById('addPhoneNumber').value;
      document.getElementById('addUserSubmit').disabled=!(u&&p);
    }

    function addToBatch(){
      const callQueueGroups = Array.from(document.querySelectorAll('#addCallQueueGroups .cq-group-select'))
                              .map(s=>s.value).filter(v=>v);
      
      const operation = {
        id: Date.now(),
        action: 'add',
        username: document.getElementById('addUsername').value,
        phoneNumber: document.getElementById('addPhoneNumber').value,
        a5Licensed: true,
        internationalCalling: document.getElementById('addIntlYes').checked,
        callQueueGroups: callQueueGroups,
        autoAttendants: Array.from(document.querySelectorAll('#addAutoAttendants .aa-select'))
                              .map(s=>s.value).filter(v=>v),
        callQueueManagers: Array.from(document.querySelectorAll('#addCallQueueManagers .cq-select'))
                              .map(s=>s.value).filter(v=>v)
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearAddForm();
      showMessage('addUserMessages', 
        `<div class="success">User ${operation.username} added to batch queue</div>`);
    }

    function mapCallQueueGroupNames(userMembershipNames) {
      const nameMapping = {
        'Q_HelpdeskCQ1': 'Helpdesk CallQueue',
        'Q_PhoneDemoLab': 'PhoneDemoLab',
        'Q_Sysadmin_MFA_CQ': 'Sysadmin_MFA_CQ',
        'Q Admissions': 'Q G Admissions',
        'Q Athletics': 'Q G Athletics',
        'Q Benefits': 'Q G Benefits',
        'Q Career Connections': 'Q G Career Connections',
        'Q Counseling Services': 'Q G Counseling Services',
        'Q CPE': 'Q G CPE',
        'Q CREATE': 'Q G Create',
        'Q Custodial Hotline': 'Q G Custodial Hotline',
        'Q Dean of Students': 'Q G Dean of Students',
        'Q ECBE Department': 'Q G ECBE Department',
        'Q Financial Aid': 'Q G Financial Aid',
        'Q Grohmann Museum': 'Q G Grohmann Museum',
        'Q Housing': 'Q G Housing',
        'Q Human Resources': 'Q G Human Resources',
        'Q Library': 'Q G Library',
        'Q Mailroom': 'Q G Mailroom',
        'Q Payroll': 'Q G Payroll',
        'Q Public Safety': 'Q G Public Safety',
        'Q Raider Shop': 'Q G Raider Shop',
        'Q Registrar': 'Q G Registrar',
        'Q RPC': 'Q G RPC',
        'Q STEM Center': 'Q G STEM Center',
        'Q Student Accounts': 'Q G Student Accounts',
        'Q WMSE Main Line': 'Q G WMSE Main Line',
        'Q WMSE Pledge Line': 'Q G WMSE Pledge Line',
        'Call Advancement': 'Q G Advancement Entryway',
        'Call WMSE Pledge Line': 'Q G WMSE Pledge Line'
      };
      
      return userMembershipNames.map(name => nameMapping[name] || name);
    }

    function addModifyToBatch(){
      const username = document.getElementById('modifyUsername').value.trim();
      
      let preservedCallQueueGroups = currentUser.callQueueGroups || [];
      let preservedAutoAttendants = currentUser.autoAttendants || [];
      let preservedCallQueueManagers = currentUser.callQueueManagers || [];
      
      let mappedCallQueueGroups = mapCallQueueGroupNames(preservedCallQueueGroups);
      
      const operation = {
        id: Date.now(),
        action: 'modify',
        username: username,
        phoneNumber: document.getElementById('modifyPhoneNumber').value || currentUser.phoneNumber,
        internationalCalling: document.getElementById('modifyIntlYes').checked,
        callQueueGroups: mappedCallQueueGroups,
        autoAttendants: preservedAutoAttendants,
        callQueueManagers: preservedCallQueueManagers,
        originalUser: {...currentUser}
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearModifyForm();
      showMessage('modifyUserMessages', 
        `<div class="success">Modification for ${username} added to batch queue</div>`);
    }

    function addDeprovisionToBatch(){
      const username = document.getElementById('deprovisionUsername').value.trim();
      const operation = {
        id: Date.now(),
        action: 'deprovision',
        username: username
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearDeprovisionForm();
      showMessage('deprovisionUserMessages', 
        `<div class="success">Deprovision for ${username} added to batch queue</div>`);
    }

    function updateBatchTable(){
      const addCount = batchOperations.filter(op => op.action === 'add').length;
      const modifyCount = batchOperations.filter(op => op.action === 'modify').length;
      const deprovisionCount = batchOperations.filter(op => op.action === 'deprovision').length;
      const totalCount = batchOperations.length;

      document.getElementById('batchAddCount').textContent = addCount;
      document.getElementById('batchModifyCount').textContent = modifyCount;
      document.getElementById('batchDeprovisionCount').textContent = deprovisionCount;
      document.getElementById('batchTotalCount').textContent = totalCount;

      const emptyMsg = document.getElementById('batchEmptyMessage');
      const table = document.getElementById('batchTable');
      const submitBtn = document.getElementById('submitAllBatch');
      const clearBtn = document.getElementById('clearAllBatch');

      if (totalCount === 0) {
        emptyMsg.style.display = 'block';
        table.style.display = 'none';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = 'table';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        populateBatchTableRows();
      }
    }

    function populateBatchTableRows(){
      const tbody = document.getElementById('batchTableBody');
      tbody.innerHTML = '';

      batchOperations.forEach(op => {
        const row = document.createElement('tr');
        row.className = `action-${op.action}`;
        
        let details = '';
        switch(op.action) {
          case 'add':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'modify':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'deprovision':
            details = 'Remove all phone settings';
            break;
        }

        row.innerHTML = `
          <td style="text-transform:capitalize; font-weight:bold">${op.action}</td>
          <td>${op.username}</td>
          <td>${details}</td>
          <td><button class="remove-batch-item" onclick="removeBatchOperation(${op.id})">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeBatchOperation(id){
      batchOperations = batchOperations.filter(op => op.id !== id);
      updateBatchTable();
    }

    function clearAllBatch(){
      batchOperations = [];
      updateBatchTable();
      document.getElementById('batchResults').innerHTML = '';
      document.getElementById('resetPageBtn').style.display = 'none';
      
      const btn = document.getElementById('clearAllBatch');
      const originalText = btn.textContent;
      btn.textContent = 'âœ… Cleared!';
      btn.style.background = '#28a745';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#6c757d';
      }, 2000);
    }

    function resetPage(){
      batchOperations = [];
      updateBatchTable();
      document.getElementById('batchResults').innerHTML = '';
      document.getElementById('resetPageBtn').style.display = 'none';
      
      clearAddForm();
      clearModifyForm();
      clearDeprovisionForm();
      
      document.getElementById('addUserMessages').innerHTML = '';
      document.getElementById('modifyUserMessages').innerHTML = '';
      document.getElementById('deprovisionUserMessages').innerHTML = '';
      
      document.getElementById('addUsername').innerHTML = '<option value="">Loading usersâ€¦</option>';
      document.getElementById('addPhoneNumber').innerHTML = '<option value="">Loading numbersâ€¦</option>';
      
      document.getElementById('addCallQueueGroups').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-group-select">
            <option value="">Loading Call Queue Groupsâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addAutoAttendants').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control aa-select">
            <option value="">Loading Auto Attendantsâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addCallQueueManagers').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-select">
            <option value="">Loading Call Queuesâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addIntlNo').checked = true;
      document.getElementById('addIntlYes').checked = false;
      
      currentUser = null;
      
      setTimeout(() => {
        loadPhoneNumbers();
      }, 100);
      
      const btn = document.getElementById('resetPageBtn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ… Page Reset!';
      btn.style.background = '#28a745';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#007bff';
        btn.style.display = 'none';
      }, 2000);
    }

    function displayBatchResults(results, successCount, errorCount){
      const resultsDiv = document.getElementById('batchResults');
      
      let html = `<div class="batch-summary">
        <strong>Batch Results:</strong><br>
        Successful: ${successCount}<br>
        Failed: ${errorCount}<br>
        Total: ${results.length}
      </div>`;

      results.forEach(result => {
        const className = result.success ? 'success' : 'error';
        html += `<div class="${className}" style="margin-bottom:5px; padding:5px; font-size:12px;">
          <strong>${result.operation.action.toUpperCase()}</strong> ${result.operation.username}: ${result.message}
        </div>`;
      });

      if (successCount > 0) {
        html += `<div class="success" style="margin-top:10px; text-align:center;">
          âœ… Page will reload in 3 seconds to refresh data...
        </div>`;
        
        setTimeout(() => {
          try {
            window.location.reload(true);
          } catch(e) {
            window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
          }
        }, 3000);
      }

      resultsDiv.innerHTML = html;

      if (errorCount > 0 && successCount === 0) {
        document.getElementById('resetPageBtn').style.display = 'block';
      }
    }

    function clearAddFormOnly(){
      document.getElementById('addUsername').value = '';
      document.getElementById('addPhoneNumber').value = '';
      document.getElementById('addIntlNo').checked = true;
      document.getElementById('addIntlYes').checked = false;
      
      document.getElementById('addCallQueueGroups').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-group-select">
            <option value="">Select Call Queue Groupâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addAutoAttendants').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control aa-select">
            <option value="">Select Auto Attendantâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addCallQueueManagers').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-select">
            <option value="">Select Call Queueâ€¦</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addUserMessages').innerHTML = '';
      
      populateDropdowns();
      validateAddForm();
    }

    function clearModifyFormOnly(){
      document.getElementById('modifyUsername').value = '';
      ['modifyPhoneGroup','modifyIntlGroup',
       'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
       'modifyCallQueueManagersGroup','currentUserInfo'].forEach(id=>
         document.getElementById(id).style.display='none');
      document.getElementById('modifyUserSubmit').style.display='none';
      currentUser = null;
      
      document.getElementById('modifyUserMessages').innerHTML = '';
      
      const deprovisionMessages = document.getElementById('deprovisionUserMessages');
      if(deprovisionMessages.innerHTML.includes('already entered in the Modify section')) {
        showMessage('deprovisionUserMessages', '', null);
      }
    }

    function clearDeprovisionFormOnly(){
      document.getElementById('deprovisionUsername').value = '';
      document.getElementById('deprovisionUserInfo').style.display='none';
      document.getElementById('deprovisionUserSubmit').style.display='none';
      
      document.getElementById('deprovisionUserMessages').innerHTML = '';
      
      const modifyMessages = document.getElementById('modifyUserMessages');
      if(modifyMessages.innerHTML.includes('already entered in the Deprovision section')) {
        showMessage('modifyUserMessages', '', null);
      }
    }

    function clearAddForm(){
      clearAddFormOnly();
    }

    function validateUsername(field, otherField, messageId, sectionName) {
      const currentValue = field.value.trim();
      const otherValue = otherField.value.trim();
      
      if (currentValue && otherValue && currentValue.toLowerCase() === otherValue.toLowerCase()) {
        showMessage(messageId, `This user is already entered in the ${sectionName} section. Please clear that entry first.`, 'error');
        return false;
      } else {
        showMessage(messageId, '', null);
        return true;
      }
    }

    function clearModifyForm(){
      clearModifyFormOnly();
    }

    function clearDeprovisionForm(){
      clearDeprovisionFormOnly();
    }

    function lookupUser(){
      const u=document.getElementById('modifyUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('modifyUserMessages','Enter a valid MSOE email','error');
      
      const deprovisionUser = document.getElementById('deprovisionUsername').value.trim();
      if(deprovisionUser && deprovisionUser.toLowerCase() === u.toLowerCase()) {
        return showMessage('modifyUserMessages','This user is already entered in the Deprovision section. Please clear that entry first.','error');
      }
      
      showMessage('modifyUserMessages','',null);
      _lookup(u,'modify');
    }

    function _lookup(username,ctx){
      fetch(`${API.url}?code=${API.key}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'lookup',username})
      })
      .then(r=>r.ok? r.json(): r.json().then(e=>Promise.reject(e)))
      .then(user=>{
        if(ctx==='modify'){
          currentUser=user;
          displayCurrentUserSettings();
          showModifyFields();
        } else {
          displayDeprovisionUserSettings(user);
        }
      })
      .catch(err=>{
        console.error(err);
        showMessage(ctx==='modify'?'modifyUserMessages':'deprovisionUserMessages',
                    err.error||err.message,'error');
      });
    }

    function displayCurrentUserSettings(){
      const s=document.getElementById('currentSettings');
      s.innerHTML=`
        <div class="current-setting"><strong>Phone Number:</strong> ${formatPhoneNumber(currentUser.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${currentUser.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(currentUser.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(currentUser.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(currentUser.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('currentUserInfo').style.display='block';
      
      populateCurrentMemberships();
    }

    function populateCurrentMemberships(){
      const cqGroupsList = document.getElementById('currentCallQueueGroupsList');
      cqGroupsList.innerHTML = '';
      if (currentUser.callQueueGroups && currentUser.callQueueGroups.length > 0) {
        currentUser.callQueueGroups.forEach(group => {
          const groupItem = document.createElement('div');
          groupItem.className = 'dynamic-item';
          groupItem.innerHTML = `
            <span>${group}</span>
            <button class="btn btn-danger btn-small" onclick="removeCallQueueGroupMembership('${group}')">Remove</button>
          `;
          cqGroupsList.appendChild(groupItem);
        });
      } else {
        cqGroupsList.innerHTML = '<div style="padding:5px; color:#666; font-style:italic;">No current memberships</div>';
      }

      const aaList = document.getElementById('currentAutoAttendantsList');
      aaList.innerHTML = '';
      if (currentUser.autoAttendants && currentUser.autoAttendants.length > 0) {
        currentUser.autoAttendants.forEach(aa => {
          const aaItem = document.createElement('div');
          aaItem.className = 'dynamic-item';
          aaItem.innerHTML = `
            <span>${aa}</span>
            <button class="btn btn-danger btn-small" onclick="removeAutoAttendantRole('${aa}')">Remove</button>
          `;
          aaList.appendChild(aaItem);
        });
      } else {
        aaList.innerHTML = '<div style="padding:5px; color:#666; font-style:italic;">No current roles</div>';
      }

      const cqMgrList = document.getElementById('currentCallQueueManagersList');
      cqMgrList.innerHTML = '';
      if (currentUser.callQueueManagers && currentUser.callQueueManagers.length > 0) {
        currentUser.callQueueManagers.forEach(cq => {
          const cqItem = document.createElement('div');
          cqItem.className = 'dynamic-item';
          cqItem.innerHTML = `
            <span>${cq}</span>
            <button class="btn btn-danger btn-small" onclick="removeCallQueueRole('${cq}')">Remove</button>
          `;
          cqMgrList.appendChild(cqItem);
        });
      } else {
        cqMgrList.innerHTML = '<div style="padding:5px; color:#666; font-style:italic;">No current roles</div>';
      }
    }

    function showModifyFields(){
      ['modifyPhoneGroup','modifyIntlGroup',
       'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
       'modifyCallQueueManagersGroup'].forEach(id=>document.getElementById(id).style.display='block');
      document.getElementById('modifyUserSubmit').style.display='block';
      document.getElementById('modifyIntlYes').checked=currentUser.internationalCalling;
      document.getElementById('modifyIntlNo').checked=!currentUser.internationalCalling;
    }

    function lookupDeprovisionUser(){
      const u=document.getElementById('deprovisionUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('deprovisionUserMessages','Enter valid MSOE email','error');
      
      const modifyUser = document.getElementById('modifyUsername').value.trim();
      if(modifyUser && modifyUser.toLowerCase() === u.toLowerCase()) {
        return showMessage('deprovisionUserMessages','This user is already entered in the Modify section. Please clear that entry first.','error');
      }
      
      showMessage('deprovisionUserMessages','',null);
      _lookup(u,'deprovision');
    }

    function displayDeprovisionUserSettings(user){
      const d=document.getElementById('deprovisionSettings');
      d.innerHTML=`
        <div class="current-setting"><strong>Username:</strong> ${user.username}</div>
        <div class="current-setting"><strong>Phone:</strong> ${formatPhoneNumber(user.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${user.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(user.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(user.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(user.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('deprovisionUserInfo').style.display='block';
      document.getElementById('deprovisionUserSubmit').style.display='block';
    }

    function formatPhoneNumber(p){
      let d=p.replace(/\D/g,'');
      if(d.length===11&&d.startsWith('1')) return `+1 ${d.slice(1,4)} ${d.slice(4,7)} ${d.slice(7)}`;
      if(d.length===10) return `+1 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}`;
      return p;
    }

    function showMessage(id,msg,type){
      let c=document.getElementById(id);
      c.innerHTML=type?`<div class="${type}">${msg}</div>`:msg;
    }

    function removeItem(btn){btn.parentNode.remove();}
    
    function addCallQueueGroup(){
      let c=document.getElementById('addCallQueueGroups');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-group-select">
          <option value="">Select Call Queue Groupâ€¦</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }

    function addAutoAttendant(){
      let c=document.getElementById('addAutoAttendants');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control aa-select">
          <option value="">Select Auto Attendantâ€¦</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }

    function addCallQueueManager(){
      let c=document.getElementById('addCallQueueManagers');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-select">
          <option value="">Select Call Queueâ€¦</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }

    function addCallQueueGroupMembership(){
      const select = document.getElementById('newCallQueueGroupSelect');
      if(select.value && currentUser) {
        if (!currentUser.callQueueGroups) currentUser.callQueueGroups = [];
        if (!currentUser.callQueueGroups.includes(select.value)) {
          currentUser.callQueueGroups.push(select.value);
          populateCurrentMemberships();
          select.value = '';
        } else {
          alert('User is already a member of this Call Queue Group');
          select.value = '';
        }
      }
    }

    function removeCallQueueGroupMembership(groupName){
      if (currentUser && currentUser.callQueueGroups) {
        currentUser.callQueueGroups = currentUser.callQueueGroups.filter(group => group !== groupName);
        populateCurrentMemberships();
      }
    }

    function addAutoAttendantRole(){
      const select = document.getElementById('newAutoAttendantSelect');
      if(select.value && currentUser) {
        if (!currentUser.autoAttendants) currentUser.autoAttendants = [];
        if (!currentUser.autoAttendants.includes(select.value)) {
          currentUser.autoAttendants.push(select.value);
          populateCurrentMemberships();
          select.value = '';
        } else {
          alert('User is already authorized for this Auto Attendant');
          select.value = '';
        }
      }
    }

    function removeAutoAttendantRole(aaName){
      if (currentUser && currentUser.autoAttendants) {
        currentUser.autoAttendants = currentUser.autoAttendants.filter(aa => aa !== aaName);
        populateCurrentMemberships();
      }
    }

    function addCallQueueRole(){
      const select = document.getElementById('newCallQueueSelect');
      if(select.value && currentUser) {
        if (!currentUser.callQueueManagers) currentUser.callQueueManagers = [];
        if (!currentUser.callQueueManagers.includes(select.value)) {
          currentUser.callQueueManagers.push(select.value);
          populateCurrentMemberships();
          select.value = '';
        } else {
          alert('User is already a manager for this Call Queue');
          select.value = '';
        }
      }
    }

    function removeCallQueueRole(cqName){
      if (currentUser && currentUser.callQueueManagers) {
        currentUser.callQueueManagers = currentUser.callQueueManagers.filter(cq => cq !== cqName);
        populateCurrentMemberships();
      }
    }

  </script>

</body>
</html>
