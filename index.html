<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Phone User Provisioning</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .main-layout{display:flex;gap:20px;flex-wrap:wrap}
    .left-panel{flex:2;min-width:800px}
    .right-panel{flex:1;min-width:400px}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-small{padding:4px 8px;font-size:12px}
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    .error{background:#ffe6e6;color:#cc0000;padding:10px;border:1px solid #cc0000;border-radius:4px;margin-bottom:15px}
    
    /* Batch Operations Table Styles */
    .batch-panel{background:#f0f8ff;border:2px solid #4169e1;border-radius:4px;padding:20px}
    .batch-header{background:#4169e1;color:white;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #4169e1}
    .batch-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .batch-table th,.batch-table td{border:1px solid #ddd;padding:8px;text-align:left}
    .batch-table th{background:#e6f2ff;font-weight:bold}
    .batch-table .action-add{background:#e8f5e8}
    .batch-table .action-modify{background:#fff3cd}
    .batch-table .action-deprovision{background:#f8d7da}
    .batch-summary{background:#fff;border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:15px}
    .remove-batch-item{background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px}
    .remove-batch-item:hover{background:#c82333}
    .batch-empty{text-align:center;color:#666;font-style:italic;padding:20px}
    
    @media(max-width:1200px){
      .main-layout{flex-direction:column}
      .left-panel,.right-panel{min-width:auto}
    }
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <div class="main-layout">
      
      <!-- LEFT PANEL - Forms -->
      <div class="left-panel">
        <div class="columns">

          <!-- ADD -->
          <div class="column">
            <div class="column-header">Add a Teams Phone User</div>
            <div id="addUserMessages"></div>

            <div class="form-group">
              <label for="addUsername">Select User:</label>
              <select id="addUsername" class="form-control">
                <option value="">Loading users…</option>
              </select>
            </div>

            <div class="form-group">
              <label for="addPhoneNumber">Pick an available phone number:</label>
              <select id="addPhoneNumber" class="form-control">
                <option value="">Loading numbers…</option>
              </select>
            </div>

            <div class="form-group">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
                <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
              </div>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="addCallQueueGroups" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-group-select">
                    <option value="">Loading Call Queue Groups…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
            </div>

            <div class="form-group">
              <label>Teams Auto Attendant Authorized User (Manager):</label>
              <div id="addAutoAttendants" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control aa-select">
                    <option value="">Loading Auto Attendants…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Authorized User (Manager):</label>
              <div id="addCallQueueManagers" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-select">
                    <option value="">Loading Call Queues…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
            </div>

            <button id="addUserSubmit" class="btn btn-primary submit-button" disabled>
              Add to Batch Queue
            </button>
          </div>


          <!-- MODIFY -->
          <div class="column">
            <div class="column-header">Modify a Teams Phone User</div>
            <div id="modifyUserMessages"></div>

            <div class="form-group">
              <label for="modifyUsername">Username:</label>
              <input type="text" id="modifyUsername" class="form-control"
                     placeholder="Enter MSOE email to lookup user"/>
              <button id="modifyLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="currentUserInfo" class="user-info" style="display:none">
              <h4>Current User Settings:</h4>
              <div id="currentSettings"></div>
            </div>

            <div id="modifyPhoneGroup" class="form-group" style="display:none">
              <label>Change Phone Number:</label>
              <select id="modifyPhoneNumber" class="form-control">
                <option value="">Select new phone number…</option>
              </select>
            </div>

            <div id="modifyIntlGroup" class="form-group" style="display:none">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
                <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
              </div>
            </div>

            <div id="modifyCallQueueGroupsGroup" class="form-group" style="display:none">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="currentCallQueueGroups">
                <h5 style="color:#1976d2">Current Group Memberships:</h5>
                <div id="currentCallQueueGroupsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueGroupSelect" class="form-control cq-group-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueGroupMembership()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyAutoAttendantsGroup" class="form-group" style="display:none">
              <label>Add Auto Attendant Manager:</label>
              <div id="currentAutoAttendants">
                <h5 style="color:#1976d2">Current Auto Attendants:</h5>
                <div id="currentAutoAttendantsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newAutoAttendantSelect" class="form-control aa-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addAutoAttendantRole()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyCallQueueManagersGroup" class="form-group" style="display:none">
              <label>Add Call Queue Manager:</label>
              <div id="currentCallQueueManagers">
                <h5 style="color:#1976d2">Current CQ Managers:</h5>
                <div id="currentCallQueueManagersList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueSelect" class="form-control cq-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueRole()">Add</button>
                </div>
              </div>
            </div>

            <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                    style="display:none">Add Modification to Batch</button>
          </div>


          <!-- DEPROVISION -->
          <div class="column">
            <div class="column-header">Deprovision a Teams Phone User</div>
            <div id="deprovisionUserMessages"></div>

            <div class="form-group">
              <label for="deprovisionUsername">Username:</label>
              <input type="text" id="deprovisionUsername" class="form-control"
                     placeholder="Enter MSOE email"/>
              <button id="deprovLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="deprovisionUserInfo" class="user-info" style="display:none">
              <h4>User to be Deprovisioned:</h4>
              <div id="deprovisionSettings"></div>
            </div>

            <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                    style="display:none">Add Deprovision to Batch</button>
          </div>

        </div>
      </div>

      <!-- RIGHT PANEL - Batch Operations -->
      <div class="right-panel">
        <div class="batch-panel">
          <div class="batch-header">Batch Operations Queue</div>
          
          <div class="batch-summary">
            <strong>Summary:</strong>
            <div>Adds: <span id="batchAddCount">0</span></div>
            <div>Modifications: <span id="batchModifyCount">0</span></div>
            <div>Deprovisions: <span id="batchDeprovisionCount">0</span></div>
            <div><strong>Total: <span id="batchTotalCount">0</span></strong></div>
          </div>

          <div id="batchTableContainer">
            <div id="batchEmptyMessage" class="batch-empty">
              No operations queued. Use the forms on the left to add operations to the batch.
            </div>
            <table id="batchTable" class="batch-table" style="display:none">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Username</th>
                  <th>Details</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="batchTableBody">
              </tbody>
            </table>
          </div>

          <div style="margin-top:15px;">
            <button id="submitAllBatch" class="btn btn-success" style="width:100%; display:none">
              Submit All Operations
            </button>
            <button id="clearAllBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
              Clear All
            </button>
          </div>

          <div id="batchResults" style="margin-top:15px;"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
    };
    let phoneNumbers = [], dropdownData = null, currentUser = null;
    let batchOperations = []; // Store all pending operations

    document.addEventListener('DOMContentLoaded', ()=> {
      loadPhoneNumbers();

      // ADD
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addUserSubmit').onclick = addToBatch;

      // MODIFY
      document.getElementById('modifyLookupBtn').addEventListener('click', ()=>{
        console.log('Modify Lookup clicked');
        lookupUser();
      });
      document.getElementById('modifyUserSubmit').onclick = addModifyToBatch;

      // DEPROVISION
      document.getElementById('deprovLookupBtn').addEventListener('click', ()=>{
        console.log('Deprov Lookup clicked');
        lookupDeprovisionUser();
      });
      document.getElementById('deprovisionUserSubmit').onclick = addDeprovisionToBatch;

      // BATCH OPERATIONS
      document.getElementById('submitAllBatch').onclick = submitAllOperations;
      document.getElementById('clearAllBatch').onclick = clearAllBatch;
    });

    async function loadPhoneNumbers() {
      // GET numbers
      let r = await fetch(`${API.url}?code=${API.key}`);
      if (!r.ok) return console.error('Phone fetch failed');
      phoneNumbers = await r.json();
      populatePhoneDropdowns();

      // POST dropdowns
      r = await fetch(`${API.url}?code=${API.key}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'getdropdowndata'})
      });
      if (!r.ok) return console.error('Dropdown fetch failed');
      dropdownData = await r.json();
      populateDropdowns();
    }

    function populateDropdowns() {
      if (!dropdownData) return; // Don't populate if data isn't loaded yet
      
      // Users
      const uSel = document.getElementById('addUsername');
      if (uSel) {
        uSel.innerHTML = '<option value="">Select a user…</option>';
        (dropdownData.a5Users||[]).forEach(u=>uSel.appendChild(new Option(u,u)));
      }

      // Call‑Queue Groups
      document.querySelectorAll('.cq-group-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue Group…</option>';
        (dropdownData.callQueueGroups||[]).forEach(g=>sel.appendChild(new Option(g,g)));
      });

      // Auto‑Attendants  
      document.querySelectorAll('.aa-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Auto Attendant…</option>';
        (dropdownData.autoAttendants||[]).forEach(a=>sel.appendChild(new Option(a,a)));
      });

      // Call‑Queues
      document.querySelectorAll('.cq-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue…</option>';
        (dropdownData.callQueues||[]).forEach(q=>sel.appendChild(new Option(q,q)));
      });

      // Modify section dropdowns
      const newCQGroupSel = document.getElementById('newCallQueueGroupSelect');
      if (newCQGroupSel) {
        newCQGroupSel.innerHTML = '<option value="">Select to add…</option>';
        (dropdownData.callQueueGroups||[]).forEach(g=>newCQGroupSel.appendChild(new Option(g,g)));
      }

      const newAASel = document.getElementById('newAutoAttendantSelect'); 
      if (newAASel) {
        newAASel.innerHTML = '<option value="">Select to add…</option>';
        (dropdownData.autoAttendants||[]).forEach(a=>newAASel.appendChild(new Option(a,a)));
      }

      const newCQSel = document.getElementById('newCallQueueSelect');
      if (newCQSel) {
        newCQSel.innerHTML = '<option value="">Select to add…</option>';
        (dropdownData.callQueues||[]).forEach(q=>newCQSel.appendChild(new Option(q,q)));
      }
    }

    function populatePhoneDropdowns() {
      const p1 = document.getElementById('addPhoneNumber');
      p1.innerHTML = '<option value="">Select a phone number…</option>';
      phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
        .forEach(i=>p1.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      const p2 = document.getElementById('modifyPhoneNumber');
      if(p2){
        p2.innerHTML = '<option value="">Select a phone number…</option>';
        phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
          .forEach(i=>p2.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      }
    }

    function validateAddForm(){
      const u=!!document.getElementById('addUsername').value;
      const p=!!document.getElementById('addPhoneNumber').value;
      document.getElementById('addUserSubmit').disabled=!(u&&p);
    }

    // ─── BATCH OPERATIONS ───────────────────────────────────────────
    function addToBatch(){
      const operation = {
        id: Date.now(),
        action: 'add',
        username: document.getElementById('addUsername').value,
        phoneNumber: document.getElementById('addPhoneNumber').value,
        a5Licensed: true,
        internationalCalling: document.getElementById('addIntlYes').checked,
        callQueueGroups: Array.from(document.querySelectorAll('#addCallQueueGroups .cq-group-select'))
                              .map(s=>s.value).filter(v=>v),
        autoAttendants: Array.from(document.querySelectorAll('#addAutoAttendants .aa-select'))
                              .map(s=>s.value).filter(v=>v),
        callQueueManagers: Array.from(document.querySelectorAll('#addCallQueueManagers .cq-select'))
                              .map(s=>s.value).filter(v=>v)
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearAddForm();
      showMessage('addUserMessages', 
        `<div class="success">User ${operation.username} added to batch queue</div>`);
    }

    function addModifyToBatch(){
      const username = document.getElementById('modifyUsername').value.trim();
      const operation = {
        id: Date.now(),
        action: 'modify',
        username: username,
        phoneNumber: document.getElementById('modifyPhoneNumber').value || currentUser.phoneNumber,
        internationalCalling: document.getElementById('modifyIntlYes').checked,
        callQueueGroups: currentUser.callQueueGroups || [],
        autoAttendants: currentUser.autoAttendants || [],
        callQueueManagers: currentUser.callQueueManagers || [],
        originalUser: {...currentUser} // Keep original for comparison
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearModifyForm();
      showMessage('modifyUserMessages', 
        `<div class="success">Modification for ${username} added to batch queue</div>`);
    }

    function addDeprovisionToBatch(){
      const username = document.getElementById('deprovisionUsername').value.trim();
      const operation = {
        id: Date.now(),
        action: 'deprovision',
        username: username
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearDeprovisionForm();
      showMessage('deprovisionUserMessages', 
        `<div class="success">Deprovision for ${username} added to batch queue</div>`);
    }

    function updateBatchTable(){
      const addCount = batchOperations.filter(op => op.action === 'add').length;
      const modifyCount = batchOperations.filter(op => op.action === 'modify').length;
      const deprovisionCount = batchOperations.filter(op => op.action === 'deprovision').length;
      const totalCount = batchOperations.length;

      document.getElementById('batchAddCount').textContent = addCount;
      document.getElementById('batchModifyCount').textContent = modifyCount;
      document.getElementById('batchDeprovisionCount').textContent = deprovisionCount;
      document.getElementById('batchTotalCount').textContent = totalCount;

      const emptyMsg = document.getElementById('batchEmptyMessage');
      const table = document.getElementById('batchTable');
      const submitBtn = document.getElementById('submitAllBatch');
      const clearBtn = document.getElementById('clearAllBatch');

      if (totalCount === 0) {
        emptyMsg.style.display = 'block';
        table.style.display = 'none';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = 'table';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        populateBatchTableRows();
      }
    }

    function populateBatchTableRows(){
      const tbody = document.getElementById('batchTableBody');
      tbody.innerHTML = '';

      batchOperations.forEach(op => {
        const row = document.createElement('tr');
        row.className = `action-${op.action}`;
        
        let details = '';
        switch(op.action) {
          case 'add':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'modify':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'deprovision':
            details = 'Remove all phone settings';
            break;
        }

        row.innerHTML = `
          <td style="text-transform:capitalize; font-weight:bold">${op.action}</td>
          <td>${op.username}</td>
          <td>${details}</td>
          <td><button class="remove-batch-item" onclick="removeBatchOperation(${op.id})">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeBatchOperation(id){
      batchOperations = batchOperations.filter(op => op.id !== id);
      updateBatchTable();
    }

    function clearAllBatch(){
      if(confirm('Are you sure you want to clear all queued operations?')){
        batchOperations = [];
        updateBatchTable();
        document.getElementById('batchResults').innerHTML = '';
      }
    }

    async function submitAllOperations(){
      if(batchOperations.length === 0) return;

      const submitBtn = document.getElementById('submitAllBatch');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      const results = [];
      let successCount = 0;
      let errorCount = 0;

      for(let operation of batchOperations) {
        try {
          const response = await fetch(`${API.url}?code=${API.key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(operation)
          });

          if(response.ok) {
            const result = await response.json();
            results.push({
              operation: operation,
              success: true,
              message: result.message || `${operation.action} successful`
            });
            successCount++;
          } else {
            const error = await response.json();
            results.push({
              operation: operation,
              success: false,
              message: error.error || 'Unknown error'
            });
            errorCount++;
          }
        } catch(error) {
          results.push({
            operation: operation,
            success: false,
            message: error.message || 'Network error'
          });
          errorCount++;
        }
      }

      // Display results
      displayBatchResults(results, successCount, errorCount);

      // Clear successful operations
      batchOperations = batchOperations.filter(op => 
        !results.find(r => r.operation.id === op.id && r.success)
      );

      updateBatchTable();
      populatePhoneDropdowns(); // Refresh available numbers

      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }

    function displayBatchResults(results, successCount, errorCount){
      const resultsDiv = document.getElementById('batchResults');
      
      let html = `<div class="batch-summary">
        <strong>Batch Results:</strong><br>
        Successful: ${successCount}<br>
        Failed: ${errorCount}<br>
        Total: ${results.length}
      </div>`;

      results.forEach(result => {
        const className = result.success ? 'success' : 'error';
        html += `<div class="${className}" style="margin-bottom:5px; padding:5px; font-size:12px;">
          <strong>${result.operation.action.toUpperCase()}</strong> ${result.operation.username}: ${result.message}
        </div>`;
      });

      resultsDiv.innerHTML = html;
    }

    // ─── FORM CLEARING FUNCTIONS ────────────────────────────────────
    function clearAddForm(){
      document.getElementById('addUsername').value = '';
      document.getElementById('addPhoneNumber').value = '';
      document.getElementById('addIntlNo').checked = true;
      document.getElementById('addIntlYes').checked = false;
      
      // Reset dynamic sections to single empty item
      document.getElementById('addCallQueueGroups').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-group-select">
            <option value="">Loading Call Queue Groups…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addAutoAttendants').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control aa-select">
            <option value="">Loading Auto Attendants…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addCallQueueManagers').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-select">
            <option value="">Loading Call Queues…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      // Repopulate all dropdowns after clearing
      setTimeout(() => {
        populateDropdowns();
        validateAddForm();
      }, 100);
    }

    function clearModifyForm(){
      document.getElementById('modifyUsername').value = '';
      ['modifyPhoneGroup','modifyIntlGroup',
       'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
       'modifyCallQueueManagersGroup','currentUserInfo'].forEach(id=>
         document.getElementById(id).style.display='none');
      document.getElementById('modifyUserSubmit').style.display='none';
      currentUser = null;
    }

    function clearDeprovisionForm(){
      document.getElementById('deprovisionUsername').value = '';
      document.getElementById('deprovisionUserInfo').style.display='none';
      document.getElementById('deprovisionUserSubmit').style.display='none';
    }

    // ─── MODIFY FUNCTIONS ───────────────────────────────────────────
    function lookupUser(){
      console.log('lookupUser()');
      const u=document.getElementById('modifyUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('modifyUserMessages','Enter a valid MSOE email','error');
      showMessage('modifyUserMessages','',null);
      _lookup(u,'modify');
    }
    function _lookup(username,ctx){
      fetch(`${API.url}?code=${API.key}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'lookup',username})
      })
      .then(r=>r.ok? r.json(): r.json().then(e=>Promise.reject(e)))
      .then(user=>{
        if(ctx==='modify'){
          currentUser=user;
          displayCurrentUserSettings();
          showModifyFields();
        } else {
          displayDeprovisionUserSettings(user);
        }
      })
      .catch(err=>{
        console.error(err);
        showMessage(ctx==='modify'?'modifyUserMessages':'deprovisionUserMessages',
                    err.error||err.message,'error');
      });
    }
    function displayCurrentUserSettings(){
      const s=document.getElementById('currentSettings');
      s.innerHTML=`
        <div class="current-setting"><strong>Phone Number:</strong> ${formatPhoneNumber(currentUser.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${currentUser.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(currentUser.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(currentUser.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(currentUser.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('currentUserInfo').style.display='block';
    }
    function showModifyFields(){
      ['modifyPhoneGroup','modifyIntlGroup',
       'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
       'modifyCallQueueManagersGroup'].forEach(id=>document.getElementById(id).style.display='block');
      document.getElementById('modifyUserSubmit').style.display='block';
      document.getElementById('modifyIntlYes').checked=currentUser.internationalCalling;
      document.getElementById('modifyIntlNo').checked=!currentUser.internationalCalling;
    }

    // ─── DEPROVISION FUNCTIONS ───────────────────────────────────────
    function lookupDeprovisionUser(){
      console.log('lookupDeprovisionUser()');
      const u=document.getElementById('deprovisionUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('deprovisionUserMessages','Enter valid MSOE email','error');
      showMessage('deprovisionUserMessages','',null);
      _lookup(u,'deprovision');
    }
    function displayDeprovisionUserSettings(user){
      const d=document.getElementById('deprovisionSettings');
      d.innerHTML=`
        <div class="current-setting"><strong>Username:</strong> ${user.username}</div>
        <div class="current-setting"><strong>Phone:</strong> ${formatPhoneNumber(user.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${user.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(user.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(user.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(user.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('deprovisionUserInfo').style.display='block';
      document.getElementById('deprovisionUserSubmit').style.display='block';
    }

    // ─── UTILITIES ─────────────────────────────────────────────────────
    function formatPhoneNumber(p){
      let d=p.replace(/\D/g,'');
      if(d.length===11&&d.startsWith('1')) return `+1 ${d.slice(1,4)} ${d.slice(4,7)} ${d.slice(7)}`;
      if(d.length===10) return `+1 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}`;
      return p;
    }
    function showMessage(id,msg,type){
      let c=document.getElementById(id);
      c.innerHTML=type?`<div class="${type}">${msg}</div>`:msg;
    }
    function removeItem(btn){btn.parentNode.remove();}
    function addCallQueueGroup(){
      let c=document.getElementById('addCallQueueGroups');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-group-select">
          <option value="">Loading Call Queue Groups…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);
      // Populate the new dropdown
      setTimeout(() => {
        const newSelect = div.querySelector('.cq-group-select');
        if (newSelect && dropdownData) {
          newSelect.innerHTML = '<option value="">Select Call Queue Group…</option>';
          (dropdownData.callQueueGroups||[]).forEach(g=>newSelect.appendChild(new Option(g,g)));
        }
      }, 10);
    }
    function addAutoAttendant(){
      let c=document.getElementById('addAutoAttendants');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control aa-select">
          <option value="">Loading Auto Attendants…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);
      // Populate the new dropdown
      setTimeout(() => {
        const newSelect = div.querySelector('.aa-select');
        if (newSelect && dropdownData) {
          newSelect.innerHTML = '<option value="">Select Auto Attendant…</option>';
          (dropdownData.autoAttendants||[]).forEach(a=>newSelect.appendChild(new Option(a,a)));
        }
      }, 10);
    }
    function addCallQueueManager(){
      let c=document.getElementById('addCallQueueManagers');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-select">
          <option value="">Loading Call Queues…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);
      // Populate the new dropdown
      setTimeout(() => {
        const newSelect = div.querySelector('.cq-select');
        if (newSelect && dropdownData) {
          newSelect.innerHTML = '<option value="">Select Call Queue…</option>';
          (dropdownData.callQueues||[]).forEach(q=>newSelect.appendChild(new Option(q,q)));
        }
      }, 10);
    }

    // Modify section dynamic functions (placeholder - can be enhanced)
    function addCallQueueGroupMembership(){
      const select = document.getElementById('newCallQueueGroupSelect');
      if(select.value) {
        alert(`Added ${select.value} to call queue groups (feature to be implemented)`);
        select.value = '';
      }
    }
    function addAutoAttendantRole(){
      const select = document.getElementById('newAutoAttendantSelect');
      if(select.value) {
        alert(`Added ${select.value} to auto attendants (feature to be implemented)`);
        select.value = '';
      }
    }
    function addCallQueueRole(){
      const select = document.getElementById('newCallQueueSelect');
      if(select.value) {
        alert(`Added ${select.value} to call queue managers (feature to be implemented)`);
        select.value = '';
      }
    }
