<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Phone User Provisioning</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    .main-layout{display:flex;gap:20px;flex-wrap:wrap}
    .left-panel{flex:2;min-width:800px}
    .right-panel{flex:1;min-width:400px}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-small{padding:4px 8px;font-size:12px}
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    .error{background:#ffe6e6;color:#cc0000;padding:10px;border:1px solid #cc0000;border-radius:4px;margin-bottom:15px}
    
    /* Batch Operations Table Styles */
    .batch-panel{background:#f0f8ff;border:2px solid #4169e1;border-radius:4px;padding:20px}
    .batch-header{background:#4169e1;color:white;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #4169e1}
    .batch-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .batch-table th,.batch-table td{border:1px solid #ddd;padding:8px;text-align:left}
    .batch-table th{background:#e6f2ff;font-weight:bold}
    .batch-table .action-add{background:#e8f5e8}
    .batch-table .action-modify{background:#fff3cd}
    .batch-table .action-deprovision{background:#f8d7da}
    .batch-summary{background:#fff;border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:15px}
    .remove-batch-item{background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px}
    .remove-batch-item:hover{background:#c82333}
    .batch-empty{text-align:center;color:#666;font-style:italic;padding:20px}
    
    /* Custom Modal Styles for Teams compatibility */
    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:none}
    .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:400px;width:90%}
    .modal-header{font-weight:bold;margin-bottom:15px;color:#333}
    .modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
    .modal-btn{padding:8px 16px;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
    .modal-btn-confirm{background:#dc3545;color:white}
    .modal-btn-cancel{background:#6c757d;color:white}
    .modal-btn:hover{opacity:0.9}
    
    @media(max-width:1200px){
      .main-layout{flex-direction:column}
      .left-panel,.right-panel{min-width:auto}
    }
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <div class="main-layout">
      
      <!-- LEFT PANEL - Forms -->
      <div class="left-panel">
        <div class="columns">

          <!-- ADD -->
          <div class="column">
            <div class="column-header">Add a Teams Phone User</div>
            <div id="addUserMessages"></div>

            <div class="form-group">
              <label for="addUsername">Select User:</label>
              <select id="addUsername" class="form-control">
                <option value="">Loading users…</option>
              </select>
            </div>

            <div class="form-group">
              <label for="addPhoneNumber">Pick an available phone number:</label>
              <select id="addPhoneNumber" class="form-control">
                <option value="">Loading numbers…</option>
              </select>
            </div>

            <div class="form-group">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
                <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
              </div>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="addCallQueueGroups" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-group-select">
                    <option value="">Loading Call Queue Groups…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
            </div>

            <div class="form-group">
              <label>Teams Auto Attendant Authorized User (Manager):</label>
              <div id="addAutoAttendants" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control aa-select">
                    <option value="">Loading Auto Attendants…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
            </div>

            <div class="form-group">
              <label>Teams Call Queue Authorized User (Manager):</label>
              <div id="addCallQueueManagers" class="dynamic-section">
                <div class="dynamic-item">
                  <select class="form-control cq-select">
                    <option value="">Loading Call Queues…</option>
                  </select>
                  <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                </div>
              </div>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
            </div>

            <button id="addUserSubmit" class="btn btn-primary submit-button" disabled>
              Add to Batch Queue
            </button>
          </div>


          <!-- MODIFY -->
          <div class="column">
            <div class="column-header">Modify a Teams Phone User</div>
            <div id="modifyUserMessages"></div>

            <div class="form-group">
              <label for="modifyUsername">Username:</label>
              <input type="text" id="modifyUsername" class="form-control"
                     placeholder="Enter MSOE email to lookup user"/>
              <button id="modifyLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="currentUserInfo" class="user-info" style="display:none">
              <h4>Current User Settings:</h4>
              <div id="currentSettings"></div>
            </div>

            <div id="modifyPhoneGroup" class="form-group" style="display:none">
              <label>Change Phone Number:</label>
              <select id="modifyPhoneNumber" class="form-control">
                <option value="">Select new phone number…</option>
              </select>
            </div>

            <div id="modifyIntlGroup" class="form-group" style="display:none">
              <label>International Calling:</label>
              <div class="radio-group">
                <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
                <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
              </div>
            </div>

            <div id="modifyCallQueueGroupsGroup" class="form-group" style="display:none">
              <label>Teams Call Queue Group Membership(s):</label>
              <div id="currentCallQueueGroups">
                <h5 style="color:#1976d2">Current Group Memberships:</h5>
                <div id="currentCallQueueGroupsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueGroupSelect" class="form-control cq-group-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueGroupMembership()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyAutoAttendantsGroup" class="form-group" style="display:none">
              <label>Add Auto Attendant Manager:</label>
              <div id="currentAutoAttendants">
                <h5 style="color:#1976d2">Current Auto Attendants:</h5>
                <div id="currentAutoAttendantsList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newAutoAttendantSelect" class="form-control aa-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addAutoAttendantRole()">Add</button>
                </div>
              </div>
            </div>

            <div id="modifyCallQueueManagersGroup" class="form-group" style="display:none">
              <label>Add Call Queue Manager:</label>
              <div id="currentCallQueueManagers">
                <h5 style="color:#1976d2">Current CQ Managers:</h5>
                <div id="currentCallQueueManagersList"></div>
              </div>
              <div class="dynamic-section">
                <div class="dynamic-item">
                  <select id="newCallQueueSelect" class="form-control cq-select">
                    <option value="">Select to add…</option>
                  </select>
                  <button class="btn btn-secondary btn-small" onclick="addCallQueueRole()">Add</button>
                </div>
              </div>
            </div>

            <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                    style="display:none">Add Modification to Batch</button>
          </div>


          <!-- DEPROVISION -->
          <div class="column">
            <div class="column-header">Deprovision a Teams Phone User</div>
            <div id="deprovisionUserMessages"></div>

            <div class="form-group">
              <label for="deprovisionUsername">Username:</label>
              <input type="text" id="deprovisionUsername" class="form-control"
                     placeholder="Enter MSOE email"/>
              <button id="deprovLookupBtn" class="btn btn-secondary"
                      style="margin-top:10px">Lookup User</button>
            </div>

            <div id="deprovisionUserInfo" class="user-info" style="display:none">
              <h4>User to be Deprovisioned:</h4>
              <div id="deprovisionSettings"></div>
            </div>

            <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                    style="display:none">Add Deprovision to Batch</button>
          </div>

        </div>
      </div>

      <!-- RIGHT PANEL - Batch Operations -->
      <div class="right-panel">
        <div class="batch-panel">
          <div class="batch-header">Batch Operations Queue</div>
          
          <div class="batch-summary">
            <strong>Summary:</strong>
            <div>Adds: <span id="batchAddCount">0</span></div>
            <div>Modifications: <span id="batchModifyCount">0</span></div>
            <div>Deprovisions: <span id="batchDeprovisionCount">0</span></div>
            <div><strong>Total: <span id="batchTotalCount">0</span></strong></div>
          </div>

          <div id="batchTableContainer">
            <div id="batchEmptyMessage" class="batch-empty">
              No operations queued. Use the forms on the left to add operations to the batch.
            </div>
            <table id="batchTable" class="batch-table" style="display:none">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Username</th>
                  <th>Details</th>
                  <th>Remove</th>
                </tr>
              </thead>
              <tbody id="batchTableBody">
              </tbody>
            </table>
          </div>

          <div style="margin-top:15px;">
            <button id="submitAllBatch" class="btn btn-success" style="width:100%; display:none">
              Submit All Operations
            </button>
            <button id="clearAllBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
              Clear All
            </button>
            <button id="resetPageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
              🔄 Reset Page
            </button>
          </div>

          <div id="batchResults" style="margin-top:15px;"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
    };
    let phoneNumbers = [], dropdownData = null, currentUser = null;
    let batchOperations = []; // NEW: Store all pending operations

    document.addEventListener('DOMContentLoaded', ()=> {
      loadPhoneNumbers();

      // ADD
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addUserSubmit').onclick = addToBatch; // CHANGED: was submitAddUser

      // MODIFY
      document.getElementById('modifyLookupBtn').addEventListener('click', ()=>{
        console.log('Modify Lookup clicked');
        lookupUser();
      });
      document.getElementById('modifyUserSubmit').onclick = addModifyToBatch; // CHANGED: was submitModifyUser

      // DEPROVISION
      document.getElementById('deprovLookupBtn').addEventListener('click', ()=>{
        console.log('Deprov Lookup clicked');
        lookupDeprovisionUser();
      });
      document.getElementById('deprovisionUserSubmit').onclick = addDeprovisionToBatch; // CHANGED: was submitDeprovisionUser

      // NEW: BATCH OPERATIONS
      document.getElementById('submitAllBatch').onclick = submitAllOperations;
      document.getElementById('clearAllBatch').onclick = clearAllBatch;
      
      // Add event listener for reset button
      const resetBtn = document.getElementById('resetPageBtn');
      if (resetBtn) {
        resetBtn.onclick = resetPage;
        console.log('Reset button event listener attached');
      } else {
        console.error('Reset button not found in DOM');
      }
    });

    // UNCHANGED: Keep exact working dropdown logic
    async function loadPhoneNumbers() {
      // GET numbers
      let r = await fetch(`${API.url}?code=${API.key}`);
      if (!r.ok) return console.error('Phone fetch failed');
      phoneNumbers = await r.json();
      populatePhoneDropdowns();

      // POST dropdowns
      r = await fetch(`${API.url}?code=${API.key}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'getdropdowndata'})
      });
      if (!r.ok) return console.error('Dropdown fetch failed');
      dropdownData = await r.json();
      populateDropdowns();
    }

    // UNCHANGED: Keep exact working dropdown logic
    function populateDropdowns() {
      // Users
      const uSel = document.getElementById('addUsername');
      uSel.innerHTML = '<option value="">Select a user…</option>';
      (dropdownData.a5Users||[]).forEach(u=>uSel.appendChild(new Option(u,u)));

      // Call‑Queue Groups
      document.querySelectorAll('.cq-group-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue Group…</option>';
        (dropdownData.callQueueGroups||[]).forEach(g=>sel.appendChild(new Option(g,g)));
      });

      // Auto‑Attendants
      document.querySelectorAll('.aa-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Auto Attendant…</option>';
        (dropdownData.autoAttendants||[]).forEach(a=>sel.appendChild(new Option(a,a)));
      });

      // Call‑Queues
      document.querySelectorAll('.cq-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue…</option>';
        (dropdownData.callQueues||[]).forEach(q=>sel.appendChild(new Option(q,q)));
      });
    }

    // UNCHANGED: Keep exact working dropdown logic
    function populatePhoneDropdowns() {
      const p1 = document.getElementById('addPhoneNumber');
      p1.innerHTML = '<option value="">Select a phone number…</option>';
      phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
        .forEach(i=>p1.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      const p2 = document.getElementById('modifyPhoneNumber');
      if(p2){
        p2.innerHTML = '<option value="">Select a phone number…</option>';
        phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
          .forEach(i=>p2.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      }
    }

    function validateAddForm(){
      const u=!!document.getElementById('addUsername').value;
      const p=!!document.getElementById('addPhoneNumber').value;
      document.getElementById('addUserSubmit').disabled=!(u&&p);
    }

    // NEW: Batch functions replace the original submit functions
    function addToBatch(){
      const operation = {
        id: Date.now(),
        action: 'add',
        username: document.getElementById('addUsername').value,
        phoneNumber: document.getElementById('addPhoneNumber').value,
        a5Licensed: true,
        internationalCalling: document.getElementById('addIntlYes').checked,
        callQueueGroups: Array.from(document.querySelectorAll('#addCallQueueGroups .cq-group-select'))
                              .map(s=>s.value).filter(v=>v),
        autoAttendants: Array.from(document.querySelectorAll('#addAutoAttendants .aa-select'))
                              .map(s=>s.value).filter(v=>v),
        callQueueManagers: Array.from(document.querySelectorAll('#addCallQueueManagers .cq-select'))
                              .map(s=>s.value).filter(v=>v)
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearAddForm();
      showMessage('addUserMessages', 
        `<div class="success">User ${operation.username} added to batch queue</div>`);
    }

    function addModifyToBatch(){
      const username = document.getElementById('modifyUsername').value.trim();
      const operation = {
        id: Date.now(),
        action: 'modify',
        username: username,
        phoneNumber: document.getElementById('modifyPhoneNumber').value || currentUser.phoneNumber,
        internationalCalling: document.getElementById('modifyIntlYes').checked,
        callQueueGroups: currentUser.callQueueGroups || [],
        autoAttendants: currentUser.autoAttendants || [],
        callQueueManagers: currentUser.callQueueManagers || [],
        originalUser: {...currentUser}
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearModifyForm();
      showMessage('modifyUserMessages', 
        `<div class="success">Modification for ${username} added to batch queue</div>`);
    }

    function addDeprovisionToBatch(){
      const username = document.getElementById('deprovisionUsername').value.trim();
      const operation = {
        id: Date.now(),
        action: 'deprovision',
        username: username
      };

      batchOperations.push(operation);
      updateBatchTable();
      clearDeprovisionForm();
      showMessage('deprovisionUserMessages', 
        `<div class="success">Deprovision for ${username} added to batch queue</div>`);
    }

    // NEW: Batch table management
    function updateBatchTable(){
      const addCount = batchOperations.filter(op => op.action === 'add').length;
      const modifyCount = batchOperations.filter(op => op.action === 'modify').length;
      const deprovisionCount = batchOperations.filter(op => op.action === 'deprovision').length;
      const totalCount = batchOperations.length;

      document.getElementById('batchAddCount').textContent = addCount;
      document.getElementById('batchModifyCount').textContent = modifyCount;
      document.getElementById('batchDeprovisionCount').textContent = deprovisionCount;
      document.getElementById('batchTotalCount').textContent = totalCount;

      const emptyMsg = document.getElementById('batchEmptyMessage');
      const table = document.getElementById('batchTable');
      const submitBtn = document.getElementById('submitAllBatch');
      const clearBtn = document.getElementById('clearAllBatch');

      if (totalCount === 0) {
        emptyMsg.style.display = 'block';
        table.style.display = 'none';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = 'table';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        populateBatchTableRows();
      }
    }

    function populateBatchTableRows(){
      const tbody = document.getElementById('batchTableBody');
      tbody.innerHTML = '';

      batchOperations.forEach(op => {
        const row = document.createElement('tr');
        row.className = `action-${op.action}`;
        
        let details = '';
        switch(op.action) {
          case 'add':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'modify':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Intl: ${op.internationalCalling ? 'Yes' : 'No'}`;
            break;
          case 'deprovision':
            details = 'Remove all phone settings';
            break;
        }

        row.innerHTML = `
          <td style="text-transform:capitalize; font-weight:bold">${op.action}</td>
          <td>${op.username}</td>
          <td>${details}</td>
          <td><button class="remove-batch-item" onclick="removeBatchOperation(${op.id})">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeBatchOperation(id){
      batchOperations = batchOperations.filter(op => op.id !== id);
      updateBatchTable();
    }

    function clearAllBatch(){
      if(confirm('Are you sure you want to clear all queued operations?')){
        batchOperations = [];
        updateBatchTable();
        document.getElementById('batchResults').innerHTML = '';
        document.getElementById('resetPageBtn').style.display = 'none';
      }
    }

    function resetPage(){
      console.log('Reset page function called - executing immediately');
      
      // Execute reset immediately without confirmation (Teams iframe compatibility)
      
      // Clear all batch operations and results
      batchOperations = [];
      updateBatchTable();
      document.getElementById('batchResults').innerHTML = '';
      document.getElementById('resetPageBtn').style.display = 'none';
      
      // Reset all forms to initial state
      clearAddForm();
      clearModifyForm();
      clearDeprovisionForm();
      
      // Clear all success messages
      document.getElementById('addUserMessages').innerHTML = '';
      document.getElementById('modifyUserMessages').innerHTML = '';
      document.getElementById('deprovisionUserMessages').innerHTML = '';
      
      // Reset dropdowns to loading state
      document.getElementById('addUsername').innerHTML = '<option value="">Loading users…</option>';
      document.getElementById('addPhoneNumber').innerHTML = '<option value="">Loading numbers…</option>';
      
      // Reset all dynamic sections to single empty items
      document.getElementById('addCallQueueGroups').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-group-select">
            <option value="">Loading Call Queue Groups…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addAutoAttendants').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control aa-select">
            <option value="">Loading Auto Attendants…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('addCallQueueManagers').innerHTML = `
        <div class="dynamic-item">
          <select class="form-control cq-select">
            <option value="">Loading Call Queues…</option>
          </select>
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      // Reset radio buttons
      document.getElementById('addIntlNo').checked = true;
      document.getElementById('addIntlYes').checked = false;
      
      // Clear and reset currentUser
      currentUser = null;
      
      // Reload fresh data
      setTimeout(() => {
        console.log('Reloading phone numbers and dropdown data...');
        loadPhoneNumbers();
      }, 100);
      
      console.log('Page reset completed successfully');
      
      // Show a brief visual feedback by temporarily changing button text
      const btn = document.getElementById('resetPageBtn');
      const originalText = btn.textContent;
      btn.textContent = '✅ Page Reset!';
      btn.style.background = '#28a745';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#007bff';
        btn.style.display = 'none';
      }, 2000);
    }

    function hideResetModal(){
      // Keep this function for compatibility but make it do nothing
      console.log('hideResetModal called (no-op in Teams)');
    }

    function confirmReset(){
      // Keep this function for compatibility but make it do nothing
      console.log('confirmReset called (no-op in Teams)');
    }

    async function submitAllOperations(){
      if(batchOperations.
