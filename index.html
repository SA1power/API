<!-- File: provisioning.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial‑scale=1">
  <title>MSOE Teams Phone User Provisioning</title>
  <style>
    /* your existing CSS here… */
  </style>
</head>
<body>
  <div class="container">
    <!-- Column 1: Add a Teams Phone User -->
    <div class="column">
      <h2>Add a Teams Phone User</h2>
      <div id="addUserMessages"></div>

      <div class="form-group">
        <label for="addUsername">Select User:</label>
        <select id="addUsername" class="form-control">
          <option value="">Loading users…</option>
        </select>
      </div>

      <div class="form-group">
        <label for="addPhoneNumber">Pick an available phone number:</label>
        <select id="addPhoneNumber" class="form-control">
          <option value="">Loading numbers…</option>
        </select>
      </div>

      <div class="form-group">
        <label>International Calling:</label>
        <div class="radio-group">
          <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
          <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
        </div>
      </div>

      <!-- … other groups … -->

      <button id="addUserSubmit" class="btn btn-primary" disabled>Activate Phone User</button>
    </div>

    <!-- Columns 2 & 3: Modify / Deprovision (unchanged) -->
  </div>

  <script>
    const API = {
      url:  'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key:  'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
    };

    let phoneNumbers = [], dropdownData = null;

    document.addEventListener('DOMContentLoaded', () => {
      loadPhoneNumbers();
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addUserSubmit').onclick = submitAddUser;
    });

    async function loadPhoneNumbers() {
      // GET phone numbers
      const resp1 = await fetch(`${API.url}?code=${API.key}`);
      if (!resp1.ok) return console.error('Phone‑number fetch failed');
      phoneNumbers = await resp1.json();
      populatePhoneDropdowns();
      // POST dropdown data
      const resp2 = await fetch(`${API.url}?code=${API.key}`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({action:'getdropdowndata'})
      });
      if (!resp2.ok) return console.error('Dropdown fetch failed');
      dropdownData = await resp2.json();
      populateDropdowns();
    }

    function populateDropdowns() {
      // Users
      const userSel = document.getElementById('addUsername');
      userSel.innerHTML = '<option value=\"\">Select a user…</option>';
      (dropdownData.a5Users || []).forEach(u => {
        userSel.appendChild(new Option(u, u));
      });

      // … callQueueGroups / autoAttendants / callQueues if needed …
    }

    function populatePhoneDropdowns() {
      const phoneSel = document.getElementById('addPhoneNumber');
      phoneSel.innerHTML = '<option value=\"\">Select a phone number…</option>';
      phoneNumbers
        .filter(i => i.AvailablePhoneNumber.startsWith('1414277'))
        .forEach(i => phoneSel.appendChild(new Option(i.AvailablePhoneNumber, i.AvailablePhoneNumber)));
    }

    function validateAddForm() {
      const u = !!document.getElementById('addUsername').value;
      const p = !!document.getElementById('addPhoneNumber').value;
      document.getElementById('addUserSubmit').disabled = !(u && p);
    }

    async function submitAddUser() {
      const body = {
        action:            'add',
        username:          document.getElementById('addUsername').value,
        phoneNumber:       document.getElementById('addPhoneNumber').value,
        a5Licensed:        true,
        internationalCalling: document.getElementById('addIntlYes').checked,
        // callQueueGroups, autoAttendants, callQueueManagers…
      };
      const resp = await fetch(`${API.url}?code=${API.key}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)
      });
      if (!resp.ok) {
        const err = await resp.json();
        return document.getElementById('addUserMessages').innerText = err.error;
      }
      const result = await resp.json();
      document.getElementById('addUserMessages').innerHTML =
        `<div class="success">User ${result.username} (${result.phoneNumber}) added!</div>`;
      populatePhoneDropdowns();
    }
  </script>
</body>
</html>
