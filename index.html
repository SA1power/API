<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Teams SSO Fixed</title>
</head>
<body>
  <div id="teamsStatus" class="teams-status">
    🔄 Initializing Teams integration...
  </div>
  <div id="debugInfo" style="background:#f0f0f0;border:1px solid #ccc;padding:10px;margin-bottom:15px;font-family:monospace;font-size:12px;display:none;">
    <strong>Debug Info:</strong><br>
    <div id="debugLog"></div>
  </div>
  <script src="https://statics.teams.microsoft.com/sdk/v1.11.0/js/MicrosoftTeams.min.js"></script>
  <script>
    const AZURE_CONFIG = {
      functionAppClientId: 'f2068d39-85c7-4507-9fd3-0758b193b0a9',
      functionAppUrl: 'https://provisionteamsphonesystemusers-a5b3b9fjcxcva8g4.northcentralus-01.azurewebsites.net/api/TriggerRunbook'
    };

    let isTeamsEnvironment = false;

    function debugLog(message) {
      console.log(message);
      const debugDiv = document.getElementById('debugLog');
      const debugInfo = document.getElementById('debugInfo');
      if (debugDiv && debugInfo) {
        debugDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        debugInfo.style.display = 'block';
      }
    }

    function initializeTeams() {
      debugLog('Starting Teams initialization...');

      try {
        if (typeof microsoftTeams !== 'undefined') {
          debugLog('Teams SDK found, initializing...');
          microsoftTeams.initialize();

          microsoftTeams.getContext((context) => {
            debugLog('Teams context received');
            isTeamsEnvironment = true;
            document.getElementById('teamsStatus').textContent = '✅ Teams context received';
            document.getElementById('teamsStatus').className = 'teams-status authenticated';
            testSSO();
          });
        } else {
          debugLog('Teams SDK not loaded');
          document.getElementById('teamsStatus').textContent = '⚠️ Running outside Teams - using fallback authentication';
          document.getElementById('teamsStatus').className = 'teams-status warning';
        }
      } catch (error) {
        debugLog('Teams initialization error: ' + error.message);
        document.getElementById('teamsStatus').textContent = '⚠️ Teams initialization failed - using fallback';
        document.getElementById('teamsStatus').className = 'teams-status warning';
      }
    }

    async function testSSO() {
      try {
        debugLog('Requesting SSO token...');
        document.getElementById('teamsStatus').textContent = '🔐 Requesting SSO token...';

        const token = await microsoftTeams.authentication.getAuthToken({
          resources: [`api://${AZURE_CONFIG.functionAppClientId}/.default`]
        });

        if (token && typeof token === 'string') {
          debugLog('SSO token acquired');
          document.getElementById('teamsStatus').textContent = '✅ SSO working';
          document.getElementById('teamsStatus').className = 'teams-status authenticated';
        } else {
          throw new Error('SSO token was empty or not a string');
        }
      } catch (err) {
        debugLog('SSO failed: ' + err.message);
        document.getElementById('teamsStatus').textContent = '⚠️ SSO failed - using fallback';
        document.getElementById('teamsStatus').className = 'teams-status warning';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeTeams();
    });
  </script>
</body>
</html>
