<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Phone User Provisioning</title>
  <style>
    /* … your existing CSS from before … */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1400px;margin:0 auto}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-small{padding:4px 8px;font-size:12px}
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <div class="columns">

      <!-- ADD -->
      <div class="column">
        <div class="column-header">Add a Teams Phone User</div>
        <div id="addUserMessages"></div>

        <div class="form-group">
          <label for="addUsername">Select User:</label>
          <select id="addUsername" class="form-control">
            <option value="">Loading users…</option>
          </select>
        </div>

        <div class="form-group">
          <label for="addPhoneNumber">Pick an available phone number:</label>
          <select id="addPhoneNumber" class="form-control">
            <option value="">Loading numbers…</option>
          </select>
        </div>

        <div class="form-group">
          <label>International Calling:</label>
          <div class="radio-group">
            <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
            <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
          </div>
        </div>

        <div class="form-group">
          <label>Teams Call Queue Group Membership(s):</label>
          <div id="addCallQueueGroups" class="dynamic-section">
            <div class="dynamic-item">
              <select class="form-control cq-group-select">
                <option value="">Loading Call Queue Groups…</option>
              </select>
              <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            </div>
          </div>
          <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
        </div>

        <div class="form-group">
          <label>Teams Auto Attendant Authorized User (Manager):</label>
          <div id="addAutoAttendants" class="dynamic-section">
            <div class="dynamic-item">
              <select class="form-control aa-select">
                <option value="">Loading Auto Attendants…</option>
              </select>
              <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            </div>
          </div>
          <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
        </div>

        <div class="form-group">
          <label>Teams Call Queue Authorized User (Manager):</label>
          <div id="addCallQueueManagers" class="dynamic-section">
            <div class="dynamic-item">
              <select class="form-control cq-select">
                <option value="">Loading Call Queues…</option>
              </select>
              <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            </div>
          </div>
          <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
        </div>

        <button id="addUserSubmit" class="btn btn-primary submit-button" disabled>
          Activate Phone User
        </button>
      </div>


      <!-- MODIFY -->
      <div class="column">
        <div class="column-header">Modify a Teams Phone User</div>
        <div id="modifyUserMessages"></div>

        <div class="form-group">
          <label for="modifyUsername">Username:</label>
          <input type="text" id="modifyUsername" class="form-control"
                 placeholder="Enter MSOE email to lookup user"/>
          <button id="modifyLookupBtn" class="btn btn-secondary"
                  style="margin-top:10px">Lookup User</button>
        </div>

        <div id="currentUserInfo" class="user-info" style="display:none">
          <h4>Current User Settings:</h4>
          <div id="currentSettings"></div>
        </div>

        <div id="modifyPhoneGroup" class="form-group" style="display:none">
          <label>Change Phone Number:</label>
          <select id="modifyPhoneNumber" class="form-control">
            <option value="">Select new phone number…</option>
          </select>
        </div>

        <div id="modifyIntlGroup" class="form-group" style="display:none">
          <label>International Calling:</label>
          <div class="radio-group">
            <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
            <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
          </div>
        </div>

        <div id="modifyCallQueueGroupsGroup" class="form-group" style="display:none">
          <label>Teams Call Queue Group Membership(s):</label>
          <div id="currentCallQueueGroups">
            <h5 style="color:#1976d2">Current Group Memberships:</h5>
            <div id="currentCallQueueGroupsList"></div>
          </div>
          <div class="dynamic-section">
            <div class="dynamic-item">
              <select id="newCallQueueGroupSelect" class="form-control cq-group-select">
                <option value="">Select to add…</option>
              </select>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueGroupMembership()">Add</button>
            </div>
          </div>
        </div>

        <div id="modifyAutoAttendantsGroup" class="form-group" style="display:none">
          <label>Add Auto Attendant Manager:</label>
          <div id="currentAutoAttendants">
            <h5 style="color:#1976d2">Current Auto Attendants:</h5>
            <div id="currentAutoAttendantsList"></div>
          </div>
          <div class="dynamic-section">
            <div class="dynamic-item">
              <select id="newAutoAttendantSelect" class="form-control aa-select">
                <option value="">Select to add…</option>
              </select>
              <button class="btn btn-secondary btn-small" onclick="addAutoAttendantRole()">Add</button>
            </div>
          </div>
        </div>

        <div id="modifyCallQueueManagersGroup" class="form-group" style="display:none">
          <label>Add Call Queue Manager:</label>
          <div id="currentCallQueueManagers">
            <h5 style="color:#1976d2">Current CQ Managers:</h5>
            <div id="currentCallQueueManagersList"></div>
          </div>
          <div class="dynamic-section">
            <div class="dynamic-item">
              <select id="newCallQueueSelect" class="form-control cq-select">
                <option value="">Select to add…</option>
              </select>
              <button class="btn btn-secondary btn-small" onclick="addCallQueueRole()">Add</button>
            </div>
          </div>
        </div>

        <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                style="display:none">Modify Phone User</button>
      </div>


      <!-- DEPROVISION -->
      <div class="column">
        <div class="column-header">Deprovision a Teams Phone User</div>
        <div id="deprovisionUserMessages"></div>

        <div class="form-group">
          <label for="deprovisionUsername">Username:</label>
          <input type="text" id="deprovisionUsername" class="form-control"
                 placeholder="Enter MSOE email"/>
          <button id="deprovLookupBtn" class="btn btn-secondary"
                  style="margin-top:10px">Lookup User</button>
        </div>

        <div id="deprovisionUserInfo" class="user-info" style="display:none">
          <h4>User to be Deprovisioned:</h4>
          <div id="deprovisionSettings"></div>
        </div>

        <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                style="display:none">Deprovision User</button>
      </div>

    </div>
  </div>

  <script>
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
    };
    let phoneNumbers = [], dropdownData = null, currentUser = null;

    document.addEventListener('DOMContentLoaded', ()=> {
      loadPhoneNumbers();

      // ADD
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addUserSubmit').onclick = submitAddUser;

      // MODIFY
      document.getElementById('modifyLookupBtn').addEventListener('click', ()=>{
        console.log('Modify Lookup clicked');
        lookupUser();
      });
      document.getElementById('modifyUserSubmit').onclick = submitModifyUser;

      // DEPROVISION
      document.getElementById('deprovLookupBtn').addEventListener('click', ()=>{
        console.log('Deprov Lookup clicked');
        lookupDeprovisionUser();
      });
      document.getElementById('deprovisionUserSubmit').onclick = submitDeprovisionUser;
    });

    async function loadPhoneNumbers() {
      // GET numbers
      let r = await fetch(`${API.url}?code=${API.key}`);
      if (!r.ok) return console.error('Phone fetch failed');
      phoneNumbers = await r.json();
      populatePhoneDropdowns();

      // POST dropdowns
      r = await fetch(`${API.url}?code=${API.key}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'getdropdowndata'})
      });
      if (!r.ok) return console.error('Dropdown fetch failed');
      dropdownData = await r.json();
      populateDropdowns();
    }

    function populateDropdowns() {
      // Users
      const uSel = document.getElementById('addUsername');
      uSel.innerHTML = '<option value="">Select a user…</option>';
      (dropdownData.a5Users||[]).forEach(u=>uSel.appendChild(new Option(u,u)));

      // Call‑Queue Groups
      document.querySelectorAll('.cq-group-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue Group…</option>';
        (dropdownData.callQueueGroups||[]).forEach(g=>sel.appendChild(new Option(g,g)));
      });

      // Auto‑Attendants
      document.querySelectorAll('.aa-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Auto Attendant…</option>';
        (dropdownData.autoAttendants||[]).forEach(a=>sel.appendChild(new Option(a,a)));
      });

      // Call‑Queues
      document.querySelectorAll('.cq-select').forEach(sel=>{
        sel.innerHTML = '<option value="">Select Call Queue…</option>';
        (dropdownData.callQueues||[]).forEach(q=>sel.appendChild(new Option(q,q)));
      });
    }

    function populatePhoneDropdowns() {
      const p1 = document.getElementById('addPhoneNumber');
      p1.innerHTML = '<option value="">Select a phone number…</option>';
      phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
        .forEach(i=>p1.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      const p2 = document.getElementById('modifyPhoneNumber');
      if(p2){
        p2.innerHTML = '<option value="">Select a phone number…</option>';
        phoneNumbers.filter(i=>i.AvailablePhoneNumber.startsWith('1414277'))
          .forEach(i=>p2.appendChild(new Option(i.AvailablePhoneNumber,i.AvailablePhoneNumber)));
      }
    }

    function validateAddForm(){
      const u=!!document.getElementById('addUsername').value;
      const p=!!document.getElementById('addPhoneNumber').value;
      document.getElementById('addUserSubmit').disabled=!(u&&p);
    }

    async function submitAddUser(){
      const body={
        action:'add',
        username:document.getElementById('addUsername').value,
        phoneNumber:document.getElementById('addPhoneNumber').value,
        a5Licensed:true,
        internationalCalling:document.getElementById('addIntlYes').checked,
        callQueueGroups:Array.from(document.querySelectorAll('#addCallQueueGroups .cq-group-select'))
                              .map(s=>s.value).filter(v=>v),
        autoAttendants: Array.from(document.querySelectorAll('#addAutoAttendants .aa-select'))
                              .map(s=>s.value).filter(v=>v),
        callQueueManagers:Array.from(document.querySelectorAll('#addCallQueueManagers .cq-select'))
                              .map(s=>s.value).filter(v=>v)
      };
      const r=await fetch(`${API.url}?code=${API.key}`,{
        method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)
      });
      if(!r.ok){
        const e=await r.json();
        return document.getElementById('addUserMessages').innerText=e.error;
      }
      const res=await r.json();
      document.getElementById('addUserMessages').innerHTML=
        `<div class="success">User ${res.username} (${res.phoneNumber}) added!</div>`;
      populatePhoneDropdowns();
    }

    // ─── MODIFY FUNCTIONS ───────────────────────────────────────────
    function lookupUser(){
      console.log('lookupUser()');
      const u=document.getElementById('modifyUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('modifyUserMessages','Enter a valid MSOE email','error');
      showMessage('modifyUserMessages','',null);
      _lookup(u,'modify');
    }
    function _lookup(username,ctx){
      fetch(`${API.url}?code=${API.key}`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action:'lookup',username})
      })
      .then(r=>r.ok? r.json(): r.json().then(e=>Promise.reject(e)))
      .then(user=>{
        if(ctx==='modify'){
          currentUser=user;
          displayCurrentUserSettings();
          showModifyFields();
        } else {
          displayDeprovisionUserSettings(user);
        }
      })
      .catch(err=>{
        console.error(err);
        showMessage(ctx==='modify'?'modifyUserMessages':'deprovisionUserMessages',
                    err.error||err.message,'error');
      });
    }
    function displayCurrentUserSettings(){
      const s=document.getElementById('currentSettings');
      s.innerHTML=`
        <div class="current-setting"><strong>Phone Number:</strong> ${formatPhoneNumber(currentUser.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${currentUser.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(currentUser.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(currentUser.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(currentUser.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('currentUserInfo').style.display='block';
    }
    function showModifyFields(){
      ['modifyPhoneGroup','modifyIntlGroup',
       'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
       'modifyCallQueueManagersGroup'].forEach(id=>document.getElementById(id).style.display='block');
      document.getElementById('modifyUserSubmit').style.display='block';
      document.getElementById('modifyIntlYes').checked=currentUser.internationalCalling;
      document.getElementById('modifyIntlNo').checked=!currentUser.internationalCalling;
    }
    async function submitModifyUser(){
      const u=document.getElementById('modifyUsername').value.trim();
      const body={action:'modify',username:u,
        phoneNumber:document.getElementById('modifyPhoneNumber').value||'',
        internationalCalling:document.getElementById('modifyIntlYes').checked,
        callQueueGroups:currentUser.callQueueGroups||[],
        autoAttendants:currentUser.autoAttendants||[],
        callQueueManagers:currentUser.callQueueManagers||[]
      };
      const btn=document.getElementById('modifyUserSubmit');
      btn.disabled=true;btn.textContent='Processing…';
      try{
        let r=await fetch(`${API.url}?code=${API.key}`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify(body)
        });
        if(!r.ok) throw await r.json();
        showMessage('modifyUserMessages',
          `<div class="success">Modification queued for ${u}</div>`);
        ['modifyPhoneGroup','modifyIntlGroup',
         'modifyCallQueueGroupsGroup','modifyAutoAttendantsGroup',
         'modifyCallQueueManagersGroup','currentUserInfo'].forEach(id=>
           document.getElementById(id).style.display='none');
        btn.style.display='none';
      }catch(e){
        console.error(e);
        showMessage('modifyUserMessages',e.error||e.message,'error');
        btn.disabled=false;btn.textContent='Modify Phone User';
      }
    }

    // ─── DEPROVISION FUNCTIONS ───────────────────────────────────────
    function lookupDeprovisionUser(){
      console.log('lookupDeprovisionUser()');
      const u=document.getElementById('deprovisionUsername').value.trim();
      if(!u||!u.endsWith('@msoe.edu')) return showMessage('deprovisionUserMessages','Enter valid MSOE email','error');
      showMessage('deprovisionUserMessages','',null);
      _lookup(u,'deprovision');
    }
    function displayDeprovisionUserSettings(user){
      const d=document.getElementById('deprovisionSettings');
      d.innerHTML=`
        <div class="current-setting"><strong>Username:</strong> ${user.username}</div>
        <div class="current-setting"><strong>Phone:</strong> ${formatPhoneNumber(user.phoneNumber)}</div>
        <div class="current-setting"><strong>Intl Calling:</strong> ${user.internationalCalling?'Yes':'No'}</div>
        <div class="current-setting"><strong>CQ Groups:</strong> ${(user.callQueueGroups||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>AAs:</strong> ${(user.autoAttendants||[]).join(', ')||'None'}</div>
        <div class="current-setting"><strong>CQMgrs:</strong> ${(user.callQueueManagers||[]).join(', ')||'None'}</div>`;
      document.getElementById('deprovisionUserInfo').style.display='block';
      document.getElementById('deprovisionUserSubmit').style.display='block';
    }
    async function submitDeprovisionUser(){
      const u=document.getElementById('deprovisionUsername').value.trim();
      const btn=document.getElementById('deprovisionUserSubmit');
      btn.disabled=true;btn.textContent='Processing…';
      try{
        let r=await fetch(`${API.url}?code=${API.key}`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({action:'deprovision',username:u})
        });
        if(!r.ok) throw await r.json();
        showMessage('deprovisionUserMessages',
          `<div class="success">${u} queued for deprovisioning</div>`);
        document.getElementById('deprovisionUserInfo').style.display='none';
        btn.style.display='none';
      }catch(e){
        console.error(e);
        showMessage('deprovisionUserMessages',e.error||e.message,'error');
        btn.disabled=false;btn.textContent='Deprovision User';
      }
    }

    // ─── UTILITIES ─────────────────────────────────────────────────────
    function formatPhoneNumber(p){
      let d=p.replace(/\D/g,'');
      if(d.length===11&&d.startsWith('1')) return `+1 ${d.slice(1,4)} ${d.slice(4,7)} ${d.slice(7)}`;
      if(d.length===10) return `+1 ${d.slice(0,3)} ${d.slice(3,6)} ${d.slice(6)}`;
      return p;
    }
    function showMessage(id,msg,type){
      let c=document.getElementById(id);
      c.innerHTML=type?`<div class="${type}">${msg}</div>`:msg;
    }
    function removeItem(btn){btn.parentNode.remove();}
    function addCallQueueGroup(){
      let c=document.getElementById('addCallQueueGroups');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-group-select">
          <option value="">Select Call Queue Group…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }
    function addAutoAttendant(){
      let c=document.getElementById('addAutoAttendants');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control aa-select">
          <option value="">Select Auto Attendant…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }
    function addCallQueueManager(){
      let c=document.getElementById('addCallQueueManagers');
      let div=document.createElement('div');
      div.className='dynamic-item';
      div.innerHTML=`
        <select class="form-control cq-select">
          <option value="">Select Call Queue…</option>
        </select>
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      c.appendChild(div);populateDropdowns();
    }
  </script>

</body>
</html>
