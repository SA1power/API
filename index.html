<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>MSOE Teams Provisioning Portal</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px}
    .container{max-width:1600px;margin:0 auto}
    
    /* Tab Navigation */
    .tab-navigation{display:flex;background:#fff;border:1px solid #ddd;border-radius:4px 4px 0 0;margin-bottom:0}
    .tab-button{flex:1;padding:15px 20px;background:#f8f9fa;border:none;border-right:1px solid #ddd;cursor:pointer;font-weight:bold;transition:all 0.3s}
    .tab-button:last-child{border-right:none}
    .tab-button:hover{background:#e9ecef}
    .tab-button.active{background:#c41e3a;color:white}
    
    /* Tab Content */
    .tab-content{display:none;background:#f5f5f5;border:1px solid #ddd;border-top:none;border-radius:0 0 4px 4px;padding:20px}
    .tab-content.active{display:block}
    
    .main-layout{display:flex;gap:20px;flex-wrap:wrap}
    .left-panel{flex:2;min-width:800px}
    .right-panel{flex:1;min-width:400px}
    .columns{display:flex;gap:20px;flex-wrap:wrap}
    .column{flex:1;background:#e8e8e8;border:2px solid #999;border-radius:4px;
      padding:20px;display:flex;flex-direction:column;min-width:300px}
    .column-header{background:#d0d0d0;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #999}
    
    /* Special styling for reservation column */
    .reservation-column{background:#f0e6ff;border-color:#6b3aa0}
    .reservation-column .column-header{background:#8b5fbf;color:white}
    
    /* Special styling for AA/CQ columns */
    .aaq-column{background:#e6f3ff;border-color:#0066cc}
    .aaq-column .column-header{background:#4d94ff;color:white}
    
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-control{width:100%;padding:8px;border:1px solid #999;border-radius:4px}
    .form-control.textarea{min-height:80px;resize:vertical;font-family:Arial,sans-serif}
    .radio-group{display:flex;gap:15px;margin-top:5px}
    .checkbox-group{margin-top:5px}
    .checkbox-group label{font-weight:normal;display:flex;align-items:center;margin-bottom:5px}
    .checkbox-group input[type="checkbox"]{margin-right:8px}
    .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;margin-top:auto}
    .btn-primary{background:#c41e3a;color:#fff}
    .btn-primary:disabled{background:#ccc;cursor:not-allowed}
    .btn-secondary{background:#0066cc;color:#fff}
    .btn-secondary:hover{background:#0052a3}
    .btn-danger{background:#dc3545;color:#fff}
    .btn-danger:hover{background:#c82333}
    .btn-success{background:#28a745;color:#fff}
    .btn-success:hover{background:#218838}
    .btn-reserve{background:#6b3aa0;color:#fff}
    .btn-reserve:hover{background:#8b5fbf}
    .btn-reserve:disabled{background:#ccc;cursor:not-allowed}
    .btn-small{padding:4px 8px;font-size:12px}
    .dynamic-section{border:1px solid #ccc;padding:10px;border-radius:4px;background:#f9f9f9;margin-bottom:10px}
    .dynamic-item{display:flex;justify-content:space-between;align-items:center;
      background:#fff;padding:5px;border-radius:3px;margin:5px 0}
    .reserved-item{display:flex;justify-content:space-between;align-items:flex-start;
      background:#fff;padding:10px;border-radius:3px;margin:5px 0;border:1px solid #ddd}
    .reserved-item-content{flex:1}
    .reserved-phone{font-weight:bold;color:#6b3aa0;margin-bottom:5px}
    .reserved-notes{color:#666;font-size:12px;font-style:italic}
    .user-info{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px}
    .user-info h4{color:#1976d2;margin-bottom:10px}
    .current-setting{display:flex;justify-content:space-between;
      background:#fff;padding:5px;border-radius:3px;margin:3px 0}
    .success{background:#e6ffe6;color:#006600;padding:10px;border:1px solid #006600;border-radius:4px;margin-bottom:15px}
    .error{background:#ffe6e6;color:#cc0000;padding:10px;border:1px solid #cc0000;border-radius:4px;margin-bottom:15px}
    .warning{background:#fff3cd;color:#856404;padding:10px;border:1px solid #ffc107;border-radius:4px;margin-bottom:15px}
    .help-text{font-size:12px;color:#666;margin-top:3px;font-style:italic}
    .char-counter{font-size:11px;color:#666;text-align:right;margin-top:2px}
    
    /* Naming convention preview */
    .naming-preview{background:#f0f8ff;border:1px solid #0066cc;padding:10px;border-radius:4px;margin-top:10px}
    .naming-preview h5{color:#0066cc;margin-bottom:5px}
    .naming-item{font-family:monospace;font-size:12px;margin:3px 0}
    
    /* Batch Operations Table Styles */
    .batch-panel{background:#f0f8ff;border:2px solid #4169e1;border-radius:4px;padding:20px}
    .batch-header{background:#4169e1;color:white;margin:-20px -20px 20px -20px;
      padding:10px 20px;font-weight:bold;border-bottom:1px solid #4169e1}
    .batch-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .batch-table th,.batch-table td{border:1px solid #ddd;padding:8px;text-align:left}
    .batch-table th{background:#e6f2ff;font-weight:bold}
    .batch-table .action-add{background:#e8f5e8}
    .batch-table .action-modify{background:#fff3cd}
    .batch-table .action-deprovision{background:#f8d7da}
    .batch-summary{background:#fff;border:1px solid #ddd;padding:10px;border-radius:4px;margin-bottom:15px}
    .remove-batch-item{background:#dc3545;color:white;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;font-size:11px}
    .remove-batch-item:hover{background:#c82333}
    .batch-empty{text-align:center;color:#666;font-style:italic;padding:20px}
    
    /* Teams status indicator */
    .teams-status{background:#e3f2fd;border:1px solid #2196f3;padding:10px;border-radius:4px;margin-bottom:15px;text-align:center}
    .teams-status.authenticated{background:#e8f5e8;border-color:#4caf50;color:#2e7d32}
    .teams-status.warning{background:#fff3cd;border-color:#ffc107;color:#856404}
    
    /* Fix for modify section width to accommodate longer UPNs */
    .current-setting{
      align-items:flex-start;
      word-wrap:break-word;
      overflow-wrap:break-word;
      flex-wrap:wrap;
    }
    
    .current-setting span{
      word-wrap:break-word;
      overflow-wrap:break-word;
      max-width:100%;
    }
    
    /* Ensure user info boxes handle long text properly */
    .user-info{
      word-wrap:break-word;
      overflow-wrap:break-word;
    }
    
    /* Make sure form controls in device sections don't overflow */
    #shared-devices .form-control,
    #shared-devices .current-setting{
      word-wrap:break-word;
      overflow-wrap:break-word;
      max-width:100%;
    }
    
    /* Fix TSD Account display in current device settings */
    #currentDeviceSettings .current-setting{
      display:block;
      margin-bottom:8px;
    }
    
    #currentDeviceSettings .current-setting strong{
      display:inline-block;
      min-width:120px;
      vertical-align:top;
    }
    
    #currentDeviceSettings .current-setting span{
      display:inline-block;
      word-wrap:break-word;
      overflow-wrap:break-word;
      max-width:calc(100% - 130px);
      vertical-align:top;
    }
    
    @media(max-width:1200px){
      .main-layout{flex-direction:column}
      .left-panel,.right-panel{min-width:auto}
    }
    @media(max-width:800px){.columns{flex-direction:column}}
  </style>
</head>
<body>

  <div class="container">
    <!-- Teams Authentication Status -->
    <div id="teamsStatus" class="teams-status">
      🔄 Initializing Teams integration...
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-button active" onclick="showTab('phone-users', event)">Teams Phone Users</button>
      <button class="tab-button" onclick="showTab('shared-devices', event)">Teams Shared Devices</button>
      <button class="tab-button" onclick="showTab('call-queues', event)">Call Queues</button>
      <button class="tab-button" onclick="showTab('auto-attendants', event)">Auto Attendants</button>
      <button class="tab-button" onclick="showTab('aa-cq-pairs', event)">AA/CQ Pairs</button>
    </div>

    <!-- TEAMS PHONE USERS TAB (unchanged) -->
    <div id="phone-users" class="tab-content active">
      <div class="main-layout">
        <!-- LEFT PANEL - Forms -->
        <div class="left-panel">
          <div class="columns">

            <!-- ADD PHONE USER -->
            <div class="column">
              <div class="column-header">Add a Teams Phone User</div>
              <div id="addUserMessages"></div>

              <div class="form-group">
                <label for="addUsername">Select User:</label>
                <select id="addUsername" class="form-control">
                  <option value="">Loading users…</option>
                </select>
                <div class="help-text">(A5 Faculty non-enterprise voice enabled)</div>
              </div>

              <div class="form-group">
                <label for="addPhoneNumber">Pick an available phone number:</label>
                <select id="addPhoneNumber" class="form-control">
                  <option value="">Loading numbers…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="addReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div class="form-group">
                <label>International Calling:</label>
                <div class="radio-group">
                  <label><input type="radio" name="addIntlCalling" id="addIntlYes" value="yes"> Yes</label>
                  <label><input type="radio" name="addIntlCalling" id="addIntlNo"  value="no" checked> No</label>
                </div>
              </div>

              <div class="form-group">
                <label>Teams Call Queue Group Membership(s):</label>
                <div id="addCallQueueGroups" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control cq-group-select">
                      <option value="">Loading Call Queue Groups…</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addCallQueueGroup()">Add Another Group</button>
              </div>

              <div class="form-group">
                <label>Teams Auto Attendant Authorized User (Manager):</label>
                <div id="addAutoAttendants" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control aa-select">
                      <option value="">Loading Auto Attendants…</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addAutoAttendant()">Add Another AA</button>
              </div>

              <div class="form-group">
                <label>Teams Call Queue Authorized User (Manager):</label>
                <div id="addCallQueueManagers" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control cq-select">
                      <option value="">Loading Call Queues…</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addCallQueueManager()">Add Another CQ</button>
              </div>

              <div style="display:flex; gap:10px; margin-top:auto;">
                <button id="addUserSubmit" class="btn btn-primary submit-button" disabled style="flex:1;">
                  Add to Batch Queue
                </button>
                <button id="clearAddForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- MODIFY PHONE USER -->
            <div class="column">
              <div class="column-header">Modify a Teams Phone User</div>
              <div id="modifyUserMessages"></div>

              <div class="form-group">
                <label for="modifyUsername">Username:</label>
                <input type="text" id="modifyUsername" class="form-control"
                       placeholder="Enter MSOE email to lookup user"/>
                <button id="modifyLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup User</button>
              </div>

              <div id="currentUserInfo" class="user-info" style="display:none">
                <h4>Current User Settings:</h4>
                <div id="currentSettings"></div>
              </div>

              <div id="modifyPhoneGroup" class="form-group" style="display:none">
                <label>Change Phone Number:</label>
                <select id="modifyPhoneNumber" class="form-control">
                  <option value="">Select new phone number…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="modifyReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div id="modifyIntlGroup" class="form-group" style="display:none">
                <label>International Calling:</label>
                <div class="radio-group">
                  <label><input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes"> Yes</label>
                  <label><input type="radio" id="modifyIntlNo"  name="modifyIntlCalling" value="no"> No</label>
                </div>
              </div>

              <div id="modifyCallQueueGroupsGroup" class="form-group" style="display:none">
                <label>Teams Call Queue Group Membership(s):</label>
                <div id="currentCallQueueGroups">
                  <h5 style="color:#1976d2">Current Group Memberships:</h5>
                  <div id="currentCallQueueGroupsList"></div>
                </div>
                <div class="dynamic-section">
                  <div class="dynamic-item">
                    <select id="newCallQueueGroupSelect" class="form-control cq-group-select">
                      <option value="">Select to add…</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="addCallQueueGroupMembership()">Add</button>
                  </div>
                </div>
              </div>

              <div id="modifyAutoAttendantsGroup" class="form-group" style="display:none">
                <label>Add Auto Attendant Manager:</label>
                <div id="currentAutoAttendants">
                  <h5 style="color:#1976d2">Current Auto Attendants:</h5>
                  <div id="currentAutoAttendantsList"></div>
                </div>
                <div class="dynamic-section">
                  <div class="dynamic-item">
                    <select id="newAutoAttendantSelect" class="form-control aa-select">
                      <option value="">Select to add…</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="addAutoAttendantRole()">Add</button>
                  </div>
                </div>
              </div>

              <div id="modifyCallQueueManagersGroup" class="form-group" style="display:none">
                <label>Add Call Queue Manager:</label>
                <div id="currentCallQueueManagers">
                  <h5 style="color:#1976d2">Current CQ Managers:</h5>
                  <div id="currentCallQueueManagersList"></div>
                </div>
                <div class="dynamic-section">
                  <div class="dynamic-item">
                    <select id="newCallQueueSelect" class="form-control cq-select">
                      <option value="">Select to add…</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="addCallQueueRole()">Add</button>
                  </div>
                </div>
              </div>

              <div id="modifyButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="modifyUserSubmit" class="btn btn-primary submit-button"
                        style="display:none; flex:1;">Add Modification to Batch</button>
                <button id="clearModifyForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- DEPROVISION PHONE USER -->
            <div class="column">
              <div class="column-header">Deprovision a Teams Phone User</div>
              <div id="deprovisionUserMessages"></div>

              <div class="form-group">
                <label for="deprovisionUsername">Username:</label>
                <input type="text" id="deprovisionUsername" class="form-control"
                       placeholder="Enter MSOE email"/>
                <button id="deprovLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup User</button>
              </div>

              <div id="deprovisionUserInfo" class="user-info" style="display:none">
                <h4>User to be Deprovisioned:</h4>
                <div id="deprovisionSettings"></div>
              </div>

              <div id="deprovisionButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="deprovisionUserSubmit" class="btn btn-danger submit-button"
                        style="display:none; flex:1;">Add Deprovision to Batch</button>
                <button id="clearDeprovisionForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- RESERVE PHONE NUMBER -->
            <div class="column reservation-column">
              <div class="column-header">Reserve a Phone Number</div>
              <div id="reserveMessages"></div>

              <div class="form-group">
                <label for="reservePhoneNumber">Select Phone Number to Reserve:</label>
                <select id="reservePhoneNumber" class="form-control">
                  <option value="">Loading available numbers…</option>
                </select>
              </div>

              <div class="form-group">
                <label for="reserveNotes">Reservation Notes:</label>
                <textarea id="reserveNotes" class="form-control textarea" 
                          placeholder="Enter notes about this reservation (optional)"
                          maxlength="500"></textarea>
                <div class="char-counter">
                  <span id="charCount">0</span> / 500 characters
                </div>
              </div>

              <button id="reserveSubmit" class="btn btn-reserve submit-button" disabled style="width:100%;">
                Reserve Phone Number
              </button>

              <div style="margin-top:20px;border-top:1px solid #999;padding-top:15px;">
                <h4 style="margin-bottom:10px;color:#6b3aa0;">Currently Reserved Numbers:</h4>
                <div id="reservedNumbersList" class="dynamic-section">
                  <div class="batch-empty">Loading reserved numbers...</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT PANEL - Batch Operations -->
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Batch Operations Queue - Phone Users</div>
            
            <div class="batch-summary">
              <strong>Summary:</strong>
              <div>Adds: <span id="batchAddCount">0</span></div>
              <div>Modifications: <span id="batchModifyCount">0</span></div>
              <div>Deprovisions: <span id="batchDeprovisionCount">0</span></div>
              <div><strong>Total: <span id="batchTotalCount">0</span></strong></div>
            </div>

            <div id="batchTableContainer">
              <div id="batchEmptyMessage" class="batch-empty">
                No operations queued. Use the forms on the left to add operations to the batch.
              </div>
              <table id="batchTable" class="batch-table" style="display:none">
                <thead>
                  <tr>
                    <th>Action</th>
                    <th>Username</th>
                    <th>Details</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="batchTableBody">
                </tbody>
              </table>
            </div>

            <div style="margin-top:15px;">
              <button id="submitAllBatch" class="btn btn-success" style="width:100%; display:none">
                Submit All Operations
              </button>
              <button id="clearAllBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
                Clear All
              </button>
              <button id="resetPageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
                🔄 Reset Page
              </button>
            </div>

            <div id="batchResults" style="margin-top:15px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- TEAMS SHARED DEVICES TAB (unchanged) -->
    <div id="shared-devices" class="tab-content">
      <div class="main-layout">
        <!-- LEFT PANEL - Forms -->
        <div class="left-panel">
          <div class="columns">

            <!-- ADD SHARED DEVICE -->
            <div class="column">
              <div class="column-header">Add a Teams Shared Device</div>
              <div id="addDeviceMessages"></div>

              <div class="form-group">
                <label for="addDeviceName">Select TSD Account:</label>
                <select id="addDeviceName" class="form-control">
                  <option value="">Loading TSD accounts…</option>
                </select>
                <div class="help-text">Accounts with Teams Shared Device License applied and no Enterprise Voice</div>
              </div>

              <div class="form-group">
                <label for="addDevicePhoneNumber">Pick an available phone number:</label>
                <select id="addDevicePhoneNumber" class="form-control">
                  <option value="">Loading numbers…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="addDeviceReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div class="form-group">
                <label>Teams Call Queue Group Membership(s):</label>
                <div id="addDeviceCallQueueGroups" class="dynamic-section">
                  <div class="dynamic-item">
                    <select class="form-control cq-group-select">
                      <option value="">Loading Call Queue Groups…</option>
                    </select>
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addDeviceCallQueueGroup()">Add Another Group</button>
              </div>

              <div style="display:flex; gap:10px; margin-top:auto;">
                <button id="addDeviceSubmit" class="btn btn-primary submit-button" disabled style="flex:1;">
                  Add to Batch Queue
                </button>
                <button id="clearAddDeviceForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- MODIFY SHARED DEVICE -->
            <div class="column">
              <div class="column-header">Modify a Teams Shared Device</div>
              <div id="modifyDeviceMessages"></div>

              <div class="form-group">
                <label for="modifyDeviceName">Select TSD Account:</label>
                <select id="modifyDeviceName" class="form-control">
                  <option value="">Loading provisioned TSD accounts…</option>
                </select>
                <button id="modifyDeviceLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup Device</button>
              </div>

              <div id="currentDeviceInfo" class="user-info" style="display:none">
                <h4>Current Device Settings:</h4>
                <div id="currentDeviceSettings"></div>
              </div>

              <div id="modifyDevicePhoneGroup" class="form-group" style="display:none">
                <label>Change Phone Number:</label>
                <select id="modifyDevicePhoneNumber" class="form-control">
                  <option value="">Select new phone number…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="modifyDeviceReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div id="modifyDeviceCallQueueGroupsGroup" class="form-group" style="display:none">
                <label>Teams Call Queue Group Membership(s):</label>
                <div id="currentDeviceCallQueueGroups">
                  <h5 style="color:#1976d2">Current Group Memberships:</h5>
                  <div id="currentDeviceCallQueueGroupsList"></div>
                </div>
                <div class="dynamic-section">
                  <div class="dynamic-item">
                    <select id="newDeviceCallQueueGroupSelect" class="form-control cq-group-select">
                      <option value="">Select to add…</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="addDeviceCallQueueGroupMembership()">Add</button>
                  </div>
                </div>
              </div>

              <div id="modifyDeviceButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="modifyDeviceSubmit" class="btn btn-primary submit-button"
                        style="display:none; flex:1;">Add Modification to Batch</button>
                <button id="clearModifyDeviceForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- DEPROVISION SHARED DEVICE -->
            <div class="column">
              <div class="column-header">Deprovision a Teams Shared Device</div>
              <div id="deprovisionDeviceMessages"></div>

              <div class="form-group">
                <label for="deprovisionDeviceName">Select TSD Account:</label>
                <select id="deprovisionDeviceName" class="form-control">
                  <option value="">Loading provisioned TSD accounts…</option>
                </select>
                <button id="deprovDeviceLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup Device</button>
              </div>

              <div id="deprovisionDeviceInfo" class="user-info" style="display:none">
                <h4>Device to be Deprovisioned:</h4>
                <div id="deprovisionDeviceSettings"></div>
              </div>

              <div id="deprovisionDeviceButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="deprovisionDeviceSubmit" class="btn btn-danger submit-button"
                        style="display:none; flex:1;">Add Deprovision to Batch</button>
                <button id="clearDeprovisionDeviceForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- RESERVE PHONE NUMBER FOR DEVICES -->
            <div class="column reservation-column">
              <div class="column-header">Reserve Phone Number for Device</div>
              <div id="reserveDeviceMessages"></div>

              <div class="form-group">
                <label for="reserveDevicePhoneNumber">Select Phone Number to Reserve:</label>
                <select id="reserveDevicePhoneNumber" class="form-control">
                  <option value="">Loading available numbers…</option>
                </select>
              </div>

              <div class="form-group">
                <label for="reserveDeviceNotes">Reservation Notes:</label>
                <textarea id="reserveDeviceNotes" class="form-control textarea" 
                          placeholder="Enter notes about this reservation (optional)"
                          maxlength="500"></textarea>
                <div class="char-counter">
                  <span id="deviceCharCount">0</span> / 500 characters
                </div>
              </div>

              <button id="reserveDeviceSubmit" class="btn btn-reserve submit-button" disabled style="width:100%;">
                Reserve Phone Number
              </button>

              <div style="margin-top:20px;border-top:1px solid #999;padding-top:15px;">
                <h4 style="margin-bottom:10px;color:#6b3aa0;">Currently Reserved Numbers:</h4>
                <div id="reservedDeviceNumbersList" class="dynamic-section">
                  <div class="batch-empty">Loading reserved numbers...</div>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT PANEL - Batch Operations -->
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Batch Operations Queue - Shared Devices</div>
            
            <div class="batch-summary">
              <strong>Summary:</strong>
              <div>Adds: <span id="batchDeviceAddCount">0</span></div>
              <div>Modifications: <span id="batchDeviceModifyCount">0</span></div>
              <div>Deprovisions: <span id="batchDeviceDeprovisionCount">0</span></div>
              <div><strong>Total: <span id="batchDeviceTotalCount">0</span></strong></div>
            </div>

            <div id="batchDeviceTableContainer">
              <div id="batchDeviceEmptyMessage" class="batch-empty">
                No operations queued. Use the forms on the left to add operations to the batch.
              </div>
              <table id="batchDeviceTable" class="batch-table" style="display:none">
                <thead>
                  <tr>
                    <th>Action</th>
                    <th>TSD Account</th>
                    <th>Details</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="batchDeviceTableBody">
                </tbody>
              </table>
            </div>

            <div style="margin-top:15px;">
              <button id="submitAllDeviceBatch" class="btn btn-success" style="width:100%; display:none">
                Submit All Operations
              </button>
              <button id="clearAllDeviceBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
                Clear All
              </button>
              <button id="resetDevicePageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
                🔄 Reset Page
              </button>
            </div>

            <div id="batchDeviceResults" style="margin-top:15px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CALL QUEUES TAB (unchanged) -->
    <div id="call-queues" class="tab-content">
      <div class="main-layout">
        <div class="left-panel">
          <div class="columns">
            <div class="column" style="min-width:100%;">
              <div class="column-header">Call Queue Management</div>
              <div style="text-align:center; padding:40px; color:#666;">
                <h3>🚧 Coming Soon</h3>
                <p>Call Queue provisioning functionality will be available in a future release.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Call Queue Operations</div>
            <div class="batch-empty">
              Call Queue operations will appear here when the feature is implemented.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AUTO ATTENDANTS TAB (unchanged) -->
    <div id="auto-attendants" class="tab-content">
      <div class="main-layout">
        <div class="left-panel">
          <div class="columns">
            <div class="column" style="min-width:100%;">
              <div class="column-header">Auto Attendant Management</div>
              <div style="text-align:center; padding:40px; color:#666;">
                <h3>🚧 Coming Soon</h3>
                <p>Auto Attendant provisioning functionality will be available in a future release.</p>
              </div>
            </div>
          </div>
        </div>
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Auto Attendant Operations</div>
            <div class="batch-empty">
              Auto Attendant operations will appear here when the feature is implemented.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- AUTO ATTENDANT / CALL QUEUE PAIRS TAB -->
    <div id="aa-cq-pairs" class="tab-content">
      <div class="main-layout">
        <!-- LEFT PANEL - Forms -->
        <div class="left-panel">
          <div class="columns">

            <!-- ADD AA/CQ PAIR -->
            <div class="column aaq-column">
              <div class="column-header">Add Auto Attendant / Call Queue Pair</div>
              <div id="addAAQMessages"></div>

              <div class="form-group">
                <label for="aaqName">Name (e.g., "Admissions", "Campus Store"):</label>
                <input type="text" id="aaqName" class="form-control" 
                       placeholder="Enter name (without 'Call' or 'Q' prefix)"
                       oninput="updateAAQNamingPreview()"/>
                <div class="help-text">Enter the base name only. Prefixes will be added automatically.</div>
              </div>

              <!-- Naming Convention Preview -->
              <div class="naming-preview" id="aaqNamingPreview" style="display:none">
                <h5>Resource Accounts to be Created:</h5>
                <div class="naming-item">AA Display Name: <span id="previewAADisplay"></span></div>
                <div class="naming-item">AA UPN: <span id="previewAAUPN"></span></div>
                <div class="naming-item">CQ Display Name: <span id="previewCQDisplay"></span></div>
                <div class="naming-item">CQ UPN: <span id="previewCQUPN"></span></div>
                <div class="naming-item">Voicemail Group: <span id="previewVMDisplay"></span></div>
                <div class="naming-item">Voicemail UPN: <span id="previewVMUPN"></span></div>
              </div>

              <div class="form-group">
                <label for="aaqPhoneNumber">Select Phone Number:</label>
                <select id="aaqPhoneNumber" class="form-control">
                  <option value="">Loading available numbers…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="aaqReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div class="form-group">
                <label for="aaqAgentGroup">Select Agent Distribution Group:</label>
                <select id="aaqAgentGroup" class="form-control">
                  <option value="">Loading distribution groups…</option>
                </select>
                <div class="help-text">Select the group that will receive calls from this queue</div>
              </div>

              <div class="form-group">
                <label>Business Hours:</label>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                  <div style="flex:1">
                    <label style="font-weight:normal">Start Time:</label>
                    <select id="aaqBusinessStart" class="form-control">
                      <option value="00:00">12:00 AM</option>
                      <option value="07:00">7:00 AM</option>
                      <option value="08:00" selected>8:00 AM</option>
                      <option value="09:00">9:00 AM</option>
                    </select>
                  </div>
                  <div style="flex:1">
                    <label style="font-weight:normal">End Time:</label>
                    <select id="aaqBusinessEnd" class="form-control">
                      <option value="16:00">4:00 PM</option>
                      <option value="17:00" selected>5:00 PM</option>
                      <option value="18:00">6:00 PM</option>
                      <option value="20:00">8:00 PM</option>
                    </select>
                  </div>
                </div>
                <div class="checkbox-group">
                  <label><input type="checkbox" id="aaqMonday" checked> Monday</label>
                  <label><input type="checkbox" id="aaqTuesday" checked> Tuesday</label>
                  <label><input type="checkbox" id="aaqWednesday" checked> Wednesday</label>
                  <label><input type="checkbox" id="aaqThursday" checked> Thursday</label>
                  <label><input type="checkbox" id="aaqFriday" checked> Friday</label>
                  <label><input type="checkbox" id="aaqSaturday"> Saturday</label>
                  <label><input type="checkbox" id="aaqSunday"> Sunday</label>
                </div>
              </div>

              <div class="form-group">
                <label>Authorized Managers (optional):</label>
                <div id="aaqAuthorizedUsers" class="dynamic-section">
                  <div class="dynamic-item">
                    <input type="text" class="form-control" placeholder="Enter MSOE email">
                    <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                  </div>
                </div>
                <button class="btn btn-secondary btn-small" onclick="addAAQAuthorizedUser()">Add Another Manager</button>
              </div>

              <div style="display:flex; gap:10px; margin-top:auto;">
                <button id="addAAQSubmit" class="btn btn-primary submit-button" disabled style="flex:1;">
                  Add to Batch Queue
                </button>
                <button id="clearAddAAQForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- MODIFY AA/CQ -->
            <div class="column aaq-column">
              <div class="column-header">Modify Auto Attendant / Call Queue</div>
              <div id="modifyAAQMessages"></div>

              <div class="form-group">
                <label for="modifyAAQSelect">Select AA/CQ Pair to Modify:</label>
                <select id="modifyAAQSelect" class="form-control">
                  <option value="">Loading AA/CQ pairs…</option>
                </select>
                <button id="modifyAAQLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup AA/CQ</button>
              </div>

              <div id="currentAAQInfo" class="user-info" style="display:none">
                <h4>Current AA/CQ Settings:</h4>
                <div id="currentAAQSettings"></div>
              </div>

              <div id="modifyAAQPhoneGroup" class="form-group" style="display:none">
                <label>Change Phone Number:</label>
                <select id="modifyAAQPhoneNumber" class="form-control">
                  <option value="">Select new phone number…</option>
                </select>
                <div class="help-text">Or use a reserved number from dropdown below</div>
                <select id="modifyAAQReservedNumber" class="form-control" style="margin-top:5px">
                  <option value="">-- Select a reserved number (optional) --</option>
                </select>
              </div>

              <div id="modifyAAQBusinessHoursGroup" class="form-group" style="display:none">
                <label>Modify Business Hours:</label>
                <div style="display:flex; gap:10px; margin-bottom:10px">
                  <div style="flex:1">
                    <label style="font-weight:normal">Start Time:</label>
                    <select id="modifyAAQBusinessStart" class="form-control">
                      <option value="00:00">12:00 AM</option>
                      <option value="07:00">7:00 AM</option>
                      <option value="08:00">8:00 AM</option>
                      <option value="09:00">9:00 AM</option>
                    </select>
                  </div>
                  <div style="flex:1">
                    <label style="font-weight:normal">End Time:</label>
                    <select id="modifyAAQBusinessEnd" class="form-control">
                      <option value="16:00">4:00 PM</option>
                      <option value="17:00">5:00 PM</option>
                      <option value="18:00">6:00 PM</option>
                      <option value="20:00">8:00 PM</option>
                    </select>
                  </div>
                </div>
                <div class="checkbox-group">
                  <label><input type="checkbox" id="modifyAAQMonday"> Monday</label>
                  <label><input type="checkbox" id="modifyAAQTuesday"> Tuesday</label>
                  <label><input type="checkbox" id="modifyAAQWednesday"> Wednesday</label>
                  <label><input type="checkbox" id="modifyAAQThursday"> Thursday</label>
                  <label><input type="checkbox" id="modifyAAQFriday"> Friday</label>
                  <label><input type="checkbox" id="modifyAAQSaturday"> Saturday</label>
                  <label><input type="checkbox" id="modifyAAQSunday"> Sunday</label>
                </div>
              </div>

              <div id="modifyAAQButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="modifyAAQSubmit" class="btn btn-primary submit-button"
                        style="display:none; flex:1;">Add Modification to Batch</button>
                <button id="clearModifyAAQForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

            <!-- DEPROVISION AA/CQ PAIR -->
            <div class="column aaq-column">
              <div class="column-header">Deprovision Auto Attendant / Call Queue Pair</div>
              <div id="deprovisionAAQMessages"></div>

              <div class="form-group">
                <label for="deprovisionAAQSelect">Select AA/CQ Pair to Deprovision:</label>
                <select id="deprovisionAAQSelect" class="form-control">
                  <option value="">Loading AA/CQ pairs…</option>
                </select>
                <button id="deprovAAQLookupBtn" class="btn btn-secondary"
                        style="margin-top:10px">Lookup AA/CQ</button>
              </div>

              <div id="deprovisionAAQInfo" class="user-info" style="display:none">
                <h4>AA/CQ Pair to be Deprovisioned:</h4>
                <div id="deprovisionAAQSettings"></div>
                <div class="warning" style="margin-top:10px">
                  ⚠️ This will remove both the Auto Attendant and Call Queue, release the phone number, 
                  and delete associated resource accounts and voicemail groups.
                </div>
              </div>

              <div id="deprovisionAAQButtonGroup" style="display:flex; gap:10px; margin-top:auto;">
                <button id="deprovisionAAQSubmit" class="btn btn-danger submit-button"
                        style="display:none; flex:1;">Add Deprovision to Batch</button>
                <button id="clearDeprovisionAAQForm" class="btn btn-secondary" style="flex:0 0 auto;">
                  Clear Form
                </button>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT PANEL - Batch Operations -->
        <div class="right-panel">
          <div class="batch-panel">
            <div class="batch-header">Batch Operations Queue - AA/CQ Pairs</div>
            
            <div class="batch-summary">
              <strong>Summary:</strong>
              <div>Add Pairs: <span id="batchAAQAddCount">0</span></div>
              <div>Modifications: <span id="batchAAQModifyCount">0</span></div>
              <div>Deprovisions: <span id="batchAAQDeprovisionCount">0</span></div>
              <div><strong>Total: <span id="batchAAQTotalCount">0</span></strong></div>
            </div>

            <div id="batchAAQTableContainer">
              <div id="batchAAQEmptyMessage" class="batch-empty">
                No operations queued. Use the forms on the left to add operations to the batch.
              </div>
              <table id="batchAAQTable" class="batch-table" style="display:none">
                <thead>
                  <tr>
                    <th>Action</th>
                    <th>AA/CQ Name</th>
                    <th>Details</th>
                    <th>Remove</th>
                  </tr>
                </thead>
                <tbody id="batchAAQTableBody">
                </tbody>
              </table>
            </div>

            <div style="margin-top:15px;">
              <button id="submitAllAAQBatch" class="btn btn-success" style="width:100%; display:none">
                Write to SQL Tables (Test Mode)
              </button>
              <button id="clearAllAAQBatch" class="btn btn-secondary" style="width:100%; margin-top:10px; display:none">
                Clear All
              </button>
              <button id="resetAAQPageBtn" class="btn btn-primary" style="width:100%; margin-top:10px; display:none">
                🔄 Reset Page
              </button>
            </div>

            <div id="batchAAQResults" style="margin-top:15px;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Teams SDK -->
  <script src="https://statics.teams.microsoft.com/sdk/v1.11.0/js/MicrosoftTeams.min.js"></script>

  <script>
    const API = {
      url: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
      key: 'NULL'
    };

    const AZURE_CONFIG = {
      functionAppClientId: 'f2068d39-85c7-4507-9fd3-0758b193b0a9',
      phoneUsersUrl: 'https://provisionteamsphonesystemusers-a5b3b9fjcxcva8g4.northcentralus-01.azurewebsites.net/api/TriggerRunbook',
      sharedDevicesUrl: 'https://provisionteamsphonesystemusers-a5b3b9fjcxcva8g4.northcentralus-01.azurewebsites.net/api/TriggerSharedDeviceRunbook',
      aaqPairsUrl: 'https://provisionteamsphonesystemusers-a5b3b9fjcxcva8g4.northcentralus-01.azurewebsites.net/api/TriggerAAQRunbook' // Future endpoint
    };

    let phoneNumbers = [], dropdownData = null, currentUser = null, currentDevice = null, currentAAQ = null;
    let reservedNumbers = [];
    let batchOperations = [];
    let batchDeviceOperations = [];
    let batchAAQOperations = [];
    let isTeamsEnvironment = false;

    // Tab Management
    function showTab(tabName, event) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Add active class to clicked tab button
      event.target.classList.add('active');
      
      // Load data when switching tabs
      if (tabName === 'shared-devices') {
        loadPhoneNumbers();
        loadReservedNumbers();
      } else if (tabName === 'aa-cq-pairs') {
        loadPhoneNumbers();
        loadReservedNumbers();
        loadAAQDropdownData();
      }
    }

    // Simple Teams detection
    function initializeTeams() {
      try {
        if (typeof microsoftTeams !== 'undefined') {
          microsoftTeams.initialize();
          isTeamsEnvironment = true;
          document.getElementById('teamsStatus').textContent = '✅ Teams detected - SSO enabled';
          document.getElementById('teamsStatus').className = 'teams-status authenticated';
        } else {
          isTeamsEnvironment = false;
          document.getElementById('teamsStatus').textContent = '⚠️ Running outside Teams - using fallback authentication';
          document.getElementById('teamsStatus').className = 'teams-status warning';
        }
      } catch (error) {
        isTeamsEnvironment = false;
        document.getElementById('teamsStatus').textContent = '⚠️ Teams initialization failed - using fallback authentication';
        document.getElementById('teamsStatus').className = 'teams-status warning';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=> {
      // Initialize Teams detection
      initializeTeams();
      
      // Load data immediately
      loadPhoneNumbers();
      loadReservedNumbers();

      // PHONE USERS - ADD
      document.getElementById('addUsername').addEventListener('change', validateAddForm);
      document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
      document.getElementById('addReservedNumber').addEventListener('change', handleReservedNumberSelection);
      document.getElementById('addUserSubmit').onclick = addToBatch;
      document.getElementById('clearAddForm').onclick = clearAddFormOnly;
      
      // PHONE USERS - MODIFY
      document.getElementById('modifyLookupBtn').addEventListener('click', lookupUser);
      document.getElementById('modifyReservedNumber').addEventListener('change', handleModifyReservedNumberSelection);
      document.getElementById('modifyUserSubmit').onclick = addModifyToBatch;
      document.getElementById('clearModifyForm').onclick = clearModifyFormOnly;
      
      document.getElementById('modifyUsername').addEventListener('input', ()=>{
        const modifyField = document.getElementById('modifyUsername');
        const deprovisionField = document.getElementById('deprovisionUsername');
        validateUsername(modifyField, deprovisionField, 'modifyUserMessages', 'Deprovision');
      });

      // PHONE USERS - DEPROVISION
      document.getElementById('deprovLookupBtn').addEventListener('click', lookupDeprovisionUser);
      document.getElementById('deprovisionUserSubmit').onclick = addDeprovisionToBatch;
      document.getElementById('clearDeprovisionForm').onclick = clearDeprovisionFormOnly;
      
      document.getElementById('deprovisionUsername').addEventListener('input', ()=>{
        const deprovisionField = document.getElementById('deprovisionUsername');
        const modifyField = document.getElementById('modifyUsername');
        validateUsername(deprovisionField, modifyField, 'deprovisionUserMessages', 'Modify');
      });

      // PHONE USERS - BATCH OPERATIONS
      document.getElementById('submitAllBatch').onclick = submitAllOperations;
      document.getElementById('clearAllBatch').onclick = clearAllBatch;
      
      const resetBtn = document.getElementById('resetPageBtn');
      if (resetBtn) {
        resetBtn.onclick = resetPage;
      }

      // PHONE NUMBER RESERVATION
      document.getElementById('reservePhoneNumber').addEventListener('change', validateReserveForm);
      document.getElementById('reserveNotes').addEventListener('input', function() {
        document.getElementById('charCount').textContent = this.value.length;
        validateReserveForm();
      });
      document.getElementById('reserveSubmit').onclick = reservePhoneNumber;

      // SHARED DEVICES - ADD
      document.getElementById('addDeviceName').addEventListener('change', validateAddDeviceForm);
      document.getElementById('addDevicePhoneNumber').addEventListener('change', validateAddDeviceForm);
      document.getElementById('addDeviceReservedNumber').addEventListener('change', handleDeviceReservedNumberSelection);
      document.getElementById('addDeviceSubmit').onclick = addDeviceToBatch;
      document.getElementById('clearAddDeviceForm').onclick = clearAddDeviceFormOnly;
      
      // SHARED DEVICES - MODIFY
      document.getElementById('modifyDeviceLookupBtn').addEventListener('click', lookupDevice);
      document.getElementById('modifyDeviceReservedNumber').addEventListener('change', handleDeviceModifyReservedNumberSelection);
      document.getElementById('modifyDeviceSubmit').onclick = addModifyDeviceToBatch;
      document.getElementById('clearModifyDeviceForm').onclick = clearModifyDeviceFormOnly;
      
      document.getElementById('modifyDeviceName').addEventListener('change', ()=>{
        const modifyField = document.getElementById('modifyDeviceName');
        const deprovisionField = document.getElementById('deprovisionDeviceName');
        validateDeviceName(modifyField, deprovisionField, 'modifyDeviceMessages', 'Deprovision');
      });

      // SHARED DEVICES - DEPROVISION
      document.getElementById('deprovDeviceLookupBtn').addEventListener('click', lookupDeprovisionDevice);
      document.getElementById('deprovisionDeviceSubmit').onclick = addDeprovisionDeviceToBatch;
      document.getElementById('clearDeprovisionDeviceForm').onclick = clearDeprovisionDeviceFormOnly;
      
      document.getElementById('deprovisionDeviceName').addEventListener('change', ()=>{
        const deprovisionField = document.getElementById('deprovisionDeviceName');
        const modifyField = document.getElementById('modifyDeviceName');
        validateDeviceName(deprovisionField, modifyField, 'deprovisionDeviceMessages', 'Modify');
      });

      // SHARED DEVICES - BATCH OPERATIONS
      document.getElementById('submitAllDeviceBatch').onclick = submitAllDeviceOperations;
      document.getElementById('clearAllDeviceBatch').onclick = clearAllDeviceBatch;
      
      const resetDeviceBtn = document.getElementById('resetDevicePageBtn');
      if (resetDeviceBtn) {
        resetDeviceBtn.onclick = resetDevicePage;
      }

      // DEVICE PHONE NUMBER RESERVATION
      document.getElementById('reserveDevicePhoneNumber').addEventListener('change', validateDeviceReserveForm);
      document.getElementById('reserveDeviceNotes').addEventListener('input', function() {
        document.getElementById('deviceCharCount').textContent = this.value.length;
        validateDeviceReserveForm();
      });
      document.getElementById('reserveDeviceSubmit').onclick = reserveDevicePhoneNumber;

      // AA/CQ PAIRS - ADD
      document.getElementById('aaqName').addEventListener('input', validateAddAAQForm);
      document.getElementById('aaqPhoneNumber').addEventListener('change', validateAddAAQForm);
      document.getElementById('aaqReservedNumber').addEventListener('change', handleAAQReservedNumberSelection);
      document.getElementById('aaqAgentGroup').addEventListener('change', validateAddAAQForm);
      document.getElementById('addAAQSubmit').onclick = addAAQToBatch;
      document.getElementById('clearAddAAQForm').onclick = clearAddAAQFormOnly;

      // AA/CQ PAIRS - MODIFY
      document.getElementById('modifyAAQLookupBtn').addEventListener('click', lookupAAQ);
      document.getElementById('modifyAAQReservedNumber').addEventListener('change', handleAAQModifyReservedNumberSelection);
      document.getElementById('modifyAAQSubmit').onclick = addModifyAAQToBatch;
      document.getElementById('clearModifyAAQForm').onclick = clearModifyAAQFormOnly;

      // AA/CQ PAIRS - DEPROVISION
      document.getElementById('deprovAAQLookupBtn').addEventListener('click', lookupDeprovisionAAQ);
      document.getElementById('deprovisionAAQSubmit').onclick = addDeprovisionAAQToBatch;
      document.getElementById('clearDeprovisionAAQForm').onclick = clearDeprovisionAAQFormOnly;

      // AA/CQ PAIRS - BATCH OPERATIONS
      document.getElementById('submitAllAAQBatch').onclick = submitAllAAQOperations;
      document.getElementById('clearAllAAQBatch').onclick = clearAllAAQBatch;
      
      const resetAAQBtn = document.getElementById('resetAAQPageBtn');
      if (resetAAQBtn) {
        resetAAQBtn.onclick = resetAAQPage;
      }
    });

    // AA/CQ Naming Convention Functions
    function updateAAQNamingPreview() {
      const name = document.getElementById('aaqName').value.trim();
      
      if (!name) {
        document.getElementById('aaqNamingPreview').style.display = 'none';
        return;
      }
      
      const sanitized = name.toLowerCase().replace(/[^a-z0-9]/g, '');
      const formatted = name.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join(' ');
      
      document.getElementById('previewAADisplay').textContent = `Call ${formatted}`;
      document.getElementById('previewAAUPN').textContent = `call_${sanitized}@msoe.edu`;
      document.getElementById('previewCQDisplay').textContent = `Q ${formatted}`;
      document.getElementById('previewCQUPN').textContent = `q_${sanitized}@msoe.edu`;
      document.getElementById('previewVMDisplay').textContent = `Q G ${formatted}`;
      document.getElementById('previewVMUPN').textContent = `qg${sanitized}@msoe.edu`;
      
      document.getElementById('aaqNamingPreview').style.display = 'block';
    }

    // Load AA/CQ dropdown data
    async function loadAAQDropdownData() {
      try {
        // For now, populate with test data until Azure Function is updated
        const agentGroups = dropdownData?.callQueueGroups || ['Q G Admissions', 'Q G Campus Store', 'Q G Helpdesk'];
        const aaqPairs = ['Call Admissions / Q Admissions', 'Call Campus Store / Q Campus Store', 'Call Helpdesk / Q Helpdesk'];
        
        // Populate agent group dropdown
        const agentSelect = document.getElementById('aaqAgentGroup');
        if (agentSelect) {
          agentSelect.innerHTML = '<option value="">Select distribution group…</option>';
          agentGroups.forEach(group => {
            agentSelect.appendChild(new Option(group, group));
          });
        }
        
        // Populate modify/deprovision dropdowns
        const modifySelect = document.getElementById('modifyAAQSelect');
        if (modifySelect) {
          modifySelect.innerHTML = '<option value="">Select AA/CQ pair…</option>';
          aaqPairs.forEach(pair => {
            modifySelect.appendChild(new Option(pair, pair));
          });
        }
        
        const deprovisionSelect = document.getElementById('deprovisionAAQSelect');
        if (deprovisionSelect) {
          deprovisionSelect.innerHTML = '<option value="">Select AA/CQ pair…</option>';
          aaqPairs.forEach(pair => {
            deprovisionSelect.appendChild(new Option(pair, pair));
          });
        }
        
        // Populate phone number dropdowns
        populateAAQPhoneDropdowns();
        
      } catch (error) {
        console.error('Error loading AA/CQ dropdown data:', error);
      }
    }

    // Populate AA/CQ phone dropdowns
    function populateAAQPhoneDropdowns() {
      const batchPhoneNumbers = batchAAQOperations
        .filter(op => op.action === 'add')
        .map(op => op.phoneNumber);
      
      const addPhone = document.getElementById('aaqPhoneNumber');
      if (addPhone) {
        addPhone.innerHTML = '<option value="">Select a phone number…</option>';
        phoneNumbers
          .filter(i => i.AvailablePhoneNumber.startsWith('1414277'))
          .filter(i => !batchPhoneNumbers.includes(i.AvailablePhoneNumber))
          .forEach(i => addPhone.appendChild(new Option(i.AvailablePhoneNumber, i.AvailablePhoneNumber)));
      }
      
      const modifyPhone = document.getElementById('modifyAAQPhoneNumber');
      if (modifyPhone) {
        modifyPhone.innerHTML = '<option value="">Select a phone number…</option>';
        phoneNumbers
          .filter(i => i.AvailablePhoneNumber.startsWith('1414277'))
          .forEach(i => modifyPhone.appendChild(new Option(i.AvailablePhoneNumber, i.AvailablePhoneNumber)));
      }
      
      // Also update reserved dropdowns
      const addReserved = document.getElementById('aaqReservedNumber');
      if (addReserved) {
        addReserved.innerHTML = '<option value="">-- Select a reserved number (optional) --</option>';
        reservedNumbers.forEach(num => {
          const option = new Option(
            `${formatPhoneNumber(num.AvailablePhoneNumber)} - ${num.ReservedNotes || 'No notes'}`,
            num.AvailablePhoneNumber
          );
          addReserved.appendChild(option);
        });
      }
      
      const modifyReserved = document.getElementById('modifyAAQReservedNumber');
      if (modifyReserved) {
        modifyReserved.innerHTML = '<option value="">-- Select a reserved number (optional) --</option>';
        reservedNumbers.forEach(num => {
          const option = new Option(
            `${formatPhoneNumber(num.AvailablePhoneNumber)} - ${num.ReservedNotes || 'No notes'}`,
            num.AvailablePhoneNumber
          );
          modifyReserved.appendChild(option);
        });
      }
    }

    // Handle AA/CQ reserved number selection
    function handleAAQReservedNumberSelection() {
      const reserved = document.getElementById('aaqReservedNumber').value;
      const regular = document.getElementById('aaqPhoneNumber');
      
      if (reserved) {
        regular.value = '';
        regular.disabled = true;
      } else {
        regular.disabled = false;
      }
      
      validateAddAAQForm();
    }

    function handleAAQModifyReservedNumberSelection() {
      const reserved = document.getElementById('modifyAAQReservedNumber').value;
      const regular = document.getElementById('modifyAAQPhoneNumber');
      
      if (reserved) {
        regular.value = '';
        regular.disabled = true;
      } else {
        regular.disabled = false;
      }
    }

    // Validate AA/CQ add form
    function validateAddAAQForm() {
      const name = document.getElementById('aaqName').value.trim();
      const phoneNumber = document.getElementById('aaqPhoneNumber').value;
      const reservedNumber = document.getElementById('aaqReservedNumber').value;
      const agentGroup = document.getElementById('aaqAgentGroup').value;
      
      const phoneToUse = reservedNumber || phoneNumber;
      
      // Check for valid name
      if (!name || name.length < 2) {
        document.getElementById('addAAQSubmit').disabled = true;
        return;
      }
      
      // Check if name already in batch
      const nameInBatch = batchAAQOperations.some(op => 
        op.action === 'add' && op.aaqName.toLowerCase() === name.toLowerCase()
      );
      
      if (nameInBatch) {
        showMessage('addAAQMessages', '<div class="error">This AA/CQ pair is already in the batch queue</div>');
        document.getElementById('aaqName').value = '';
        document.getElementById('addAAQSubmit').disabled = true;
        return;
      }
      
      // Check if phone already in batch
      const phoneInBatch = batchAAQOperations.some(op => 
        op.action === 'add' && op.phoneNumber === phoneToUse
      );
      
      if (phoneInBatch && phoneToUse) {
        showMessage('addAAQMessages', '<div class="error">This phone number is already in the batch queue</div>');
        document.getElementById('aaqPhoneNumber').value = '';
        document.getElementById('aaqReservedNumber').value = '';
        document.getElementById('addAAQSubmit').disabled = true;
        return;
      }
      
      const valid = !!(name && phoneToUse && agentGroup);
      document.getElementById('addAAQSubmit').disabled = !valid;
    }

    // Add AA/CQ functions
    function addAAQAuthorizedUser() {
      const container = document.getElementById('aaqAuthorizedUsers');
      const div = document.createElement('div');
      div.className = 'dynamic-item';
      div.innerHTML = `
        <input type="text" class="form-control" placeholder="Enter MSOE email">
        <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>`;
      container.appendChild(div);
    }

    function addAAQToBatch() {
      const name = document.getElementById('aaqName').value.trim();
      const sanitized = name.toLowerCase().replace(/[^a-z0-9]/g, '');
      const formatted = name.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join(' ');
      
      const selectedReserved = document.getElementById('aaqReservedNumber').value;
      const selectedPhone = document.getElementById('aaqPhoneNumber').value;
      const phoneToUse = selectedReserved || selectedPhone;
      
      // Get business hours
      const businessDays = [];
      if (document.getElementById('aaqMonday').checked) businessDays.push('Monday');
      if (document.getElementById('aaqTuesday').checked) businessDays.push('Tuesday');
      if (document.getElementById('aaqWednesday').checked) businessDays.push('Wednesday');
      if (document.getElementById('aaqThursday').checked) businessDays.push('Thursday');
      if (document.getElementById('aaqFriday').checked) businessDays.push('Friday');
      if (document.getElementById('aaqSaturday').checked) businessDays.push('Saturday');
      if (document.getElementById('aaqSunday').checked) businessDays.push('Sunday');
      
      // Get authorized users
      const authorizedUsers = Array.from(document.querySelectorAll('#aaqAuthorizedUsers input'))
        .map(input => input.value.trim())
        .filter(email => email && email.endsWith('@msoe.edu'));
      
      const operation = {
        id: Date.now(),
        action: 'add',
        aaqName: name,
        aaDisplayName: `Call ${formatted}`,
        aaUPN: `call_${sanitized}@msoe.edu`,
        cqDisplayName: `Q ${formatted}`,
        cqUPN: `q_${sanitized}@msoe.edu`,
        vmDisplayName: `Q G ${formatted}`,
        vmUPN: `qg${sanitized}@msoe.edu`,
        phoneNumber: phoneToUse,
        agentGroup: document.getElementById('aaqAgentGroup').value,
        businessHoursStart: document.getElementById('aaqBusinessStart').value,
        businessHoursEnd: document.getElementById('aaqBusinessEnd').value,
        businessDays: businessDays.join(','),
        authorizedUsers: authorizedUsers.join(';'),
        wasReserved: !!selectedReserved
      };
      
      batchAAQOperations.push(operation);
      updateAAQBatchTable();
      clearAddAAQFormOnly();
      
      showMessage('addAAQMessages', 
        `<div class="success">AA/CQ pair "${operation.aaqName}" added to batch queue</div>`);
    }

    function clearAddAAQFormOnly() {
      document.getElementById('aaqName').value = '';
      document.getElementById('aaqPhoneNumber').value = '';
      document.getElementById('aaqReservedNumber').value = '';
      document.getElementById('aaqAgentGroup').value = '';
      document.getElementById('aaqBusinessStart').value = '08:00';
      document.getElementById('aaqBusinessEnd').value = '17:00';
      
      // Reset checkboxes
      document.getElementById('aaqMonday').checked = true;
      document.getElementById('aaqTuesday').checked = true;
      document.getElementById('aaqWednesday').checked = true;
      document.getElementById('aaqThursday').checked = true;
      document.getElementById('aaqFriday').checked = true;
      document.getElementById('aaqSaturday').checked = false;
      document.getElementById('aaqSunday').checked = false;
      
      // Clear authorized users except first one
      document.getElementById('aaqAuthorizedUsers').innerHTML = `
        <div class="dynamic-item">
          <input type="text" class="form-control" placeholder="Enter MSOE email">
          <button class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
        </div>`;
      
      document.getElementById('aaqNamingPreview').style.display = 'none';
      document.getElementById('addAAQMessages').innerHTML = '';
      document.getElementById('addAAQSubmit').disabled = true;
      
      populateAAQPhoneDropdowns();
    }

    // Lookup AA/CQ for modification
    async function lookupAAQ() {
      const selected = document.getElementById('modifyAAQSelect').value;
      if (!selected) {
        showMessage('modifyAAQMessages', '<div class="error">Please select an AA/CQ pair</div>');
        return;
      }
      
      // For testing, create mock data
      currentAAQ = {
        name: selected.split(' / ')[0].replace('Call ', ''),
        phoneNumber: '14142771234',
        agentGroup: 'Q G Admissions',
        businessHoursStart: '08:00',
        businessHoursEnd: '17:00',
        businessDays: 'Monday,Tuesday,Wednesday,Thursday,Friday',
        authorizedUsers: ['admin@msoe.edu', 'manager@msoe.edu']
      };
      
      displayCurrentAAQSettings();
      showModifyAAQFields();
    }

    function displayCurrentAAQSettings() {
      const settings = document.getElementById('currentAAQSettings');
      settings.innerHTML = `
        <div class="current-setting"><strong>AA Name:</strong> Call ${currentAAQ.name}</div>
        <div class="current-setting"><strong>CQ Name:</strong> Q ${currentAAQ.name}</div>
        <div class="current-setting"><strong>Phone:</strong> ${formatPhoneNumber(currentAAQ.phoneNumber)}</div>
        <div class="current-setting"><strong>Agent Group:</strong> ${currentAAQ.agentGroup}</div>
        <div class="current-setting"><strong>Business Hours:</strong> ${currentAAQ.businessHoursStart} - ${currentAAQ.businessHoursEnd}</div>
        <div class="current-setting"><strong>Business Days:</strong> ${currentAAQ.businessDays}</div>
        <div class="current-setting"><strong>Managers:</strong> ${currentAAQ.authorizedUsers.join('; ')}</div>`;
      document.getElementById('currentAAQInfo').style.display = 'block';
    }

    function showModifyAAQFields() {
      document.getElementById('modifyAAQPhoneGroup').style.display = 'block';
      document.getElementById('modifyAAQBusinessHoursGroup').style.display = 'block';
      document.getElementById('modifyAAQSubmit').style.display = 'block';
      
      // Set current values
      document.getElementById('modifyAAQBusinessStart').value = currentAAQ.businessHoursStart;
      document.getElementById('modifyAAQBusinessEnd').value = currentAAQ.businessHoursEnd;
      
      // Set checkboxes based on current days
      const days = currentAAQ.businessDays.split(',');
      document.getElementById('modifyAAQMonday').checked = days.includes('Monday');
      document.getElementById('modifyAAQTuesday').checked = days.includes('Tuesday');
      document.getElementById('modifyAAQWednesday').checked = days.includes('Wednesday');
      document.getElementById('modifyAAQThursday').checked = days.includes('Thursday');
      document.getElementById('modifyAAQFriday').checked = days.includes('Friday');
      document.getElementById('modifyAAQSaturday').checked = days.includes('Saturday');
      document.getElementById('modifyAAQSunday').checked = days.includes('Sunday');
    }

    function addModifyAAQToBatch() {
      const selectedReserved = document.getElementById('modifyAAQReservedNumber').value;
      const selectedPhone = document.getElementById('modifyAAQPhoneNumber').value;
      const phoneToUse = selectedReserved || selectedPhone || currentAAQ.phoneNumber;
      
      // Get business hours
      const businessDays = [];
      if (document.getElementById('modifyAAQMonday').checked) businessDays.push('Monday');
      if (document.getElementById('modifyAAQTuesday').checked) businessDays.push('Tuesday');
      if (document.getElementById('modifyAAQWednesday').checked) businessDays.push('Wednesday');
      if (document.getElementById('modifyAAQThursday').checked) businessDays.push('Thursday');
      if (document.getElementById('modifyAAQFriday').checked) businessDays.push('Friday');
      if (document.getElementById('modifyAAQSaturday').checked) businessDays.push('Saturday');
      if (document.getElementById('modifyAAQSunday').checked) businessDays.push('Sunday');
      
      const operation = {
        id: Date.now(),
        action: 'modify',
        aaqName: currentAAQ.name,
        phoneNumber: phoneToUse,
        businessHoursStart: document.getElementById('modifyAAQBusinessStart').value,
        businessHoursEnd: document.getElementById('modifyAAQBusinessEnd').value,
        businessDays: businessDays.join(','),
        originalAAQ: {...currentAAQ},
        wasReserved: !!selectedReserved
      };
      
      batchAAQOperations.push(operation);
      updateAAQBatchTable();
      clearModifyAAQFormOnly();
      
      showMessage('modifyAAQMessages', 
        `<div class="success">Modification for "${operation.aaqName}" added to batch queue</div>`);
    }

    function clearModifyAAQFormOnly() {
      document.getElementById('modifyAAQSelect').value = '';
      document.getElementById('currentAAQInfo').style.display = 'none';
      document.getElementById('modifyAAQPhoneGroup').style.display = 'none';
      document.getElementById('modifyAAQBusinessHoursGroup').style.display = 'none';
      document.getElementById('modifyAAQSubmit').style.display = 'none';
      document.getElementById('modifyAAQMessages').innerHTML = '';
      currentAAQ = null;
    }

    // Lookup AA/CQ for deprovision
    async function lookupDeprovisionAAQ() {
      const selected = document.getElementById('deprovisionAAQSelect').value;
      if (!selected) {
        showMessage('deprovisionAAQMessages', '<div class="error">Please select an AA/CQ pair</div>');
        return;
      }
      
      // For testing, create mock data
      const name = selected.split(' / ')[0].replace('Call ', '');
      
      displayDeprovisionAAQSettings({
        name: name,
        aaName: `Call ${name}`,
        cqName: `Q ${name}`,
        phoneNumber: '14142771234',
        vmGroup: `Q G ${name}`
      });
    }

    function displayDeprovisionAAQSettings(aaq) {
      const settings = document.getElementById('deprovisionAAQSettings');
      settings.innerHTML = `
        <div class="current-setting"><strong>Auto Attendant:</strong> ${aaq.aaName}</div>
        <div class="current-setting"><strong>Call Queue:</strong> ${aaq.cqName}</div>
        <div class="current-setting"><strong>Phone Number:</strong> ${formatPhoneNumber(aaq.phoneNumber)}</div>
        <div class="current-setting"><strong>Voicemail Group:</strong> ${aaq.vmGroup}</div>`;
      document.getElementById('deprovisionAAQInfo').style.display = 'block';
      document.getElementById('deprovisionAAQSubmit').style.display = 'block';
    }

    function addDeprovisionAAQToBatch() {
      const selected = document.getElementById('deprovisionAAQSelect').value;
      const name = selected.split(' / ')[0].replace('Call ', '');
      
      const operation = {
        id: Date.now(),
        action: 'deprovision',
        aaqName: name,
        aaName: `Call ${name}`,
        cqName: `Q ${name}`
      };
      
      batchAAQOperations.push(operation);
      updateAAQBatchTable();
      clearDeprovisionAAQFormOnly();
      
      showMessage('deprovisionAAQMessages', 
        `<div class="success">Deprovision for "${operation.aaqName}" added to batch queue</div>`);
    }

    function clearDeprovisionAAQFormOnly() {
      document.getElementById('deprovisionAAQSelect').value = '';
      document.getElementById('deprovisionAAQInfo').style.display = 'none';
      document.getElementById('deprovisionAAQSubmit').style.display = 'none';
      document.getElementById('deprovisionAAQMessages').innerHTML = '';
    }

    // Update AA/CQ batch table
    function updateAAQBatchTable() {
      const addCount = batchAAQOperations.filter(op => op.action === 'add').length;
      const modifyCount = batchAAQOperations.filter(op => op.action === 'modify').length;
      const deprovisionCount = batchAAQOperations.filter(op => op.action === 'deprovision').length;
      const totalCount = batchAAQOperations.length;
      
      document.getElementById('batchAAQAddCount').textContent = addCount;
      document.getElementById('batchAAQModifyCount').textContent = modifyCount;
      document.getElementById('batchAAQDeprovisionCount').textContent = deprovisionCount;
      document.getElementById('batchAAQTotalCount').textContent = totalCount;
      
      const emptyMsg = document.getElementById('batchAAQEmptyMessage');
      const table = document.getElementById('batchAAQTable');
      const submitBtn = document.getElementById('submitAllAAQBatch');
      const clearBtn = document.getElementById('clearAllAAQBatch');
      
      if (totalCount === 0) {
        emptyMsg.style.display = 'block';
        table.style.display = 'none';
        submitBtn.style.display = 'none';
        clearBtn.style.display = 'none';
      } else {
        emptyMsg.style.display = 'none';
        table.style.display = 'table';
        submitBtn.style.display = 'block';
        clearBtn.style.display = 'block';
        populateAAQBatchTableRows();
      }
    }

    function populateAAQBatchTableRows() {
      const tbody = document.getElementById('batchAAQTableBody');
      tbody.innerHTML = '';
      
      batchAAQOperations.forEach(op => {
        const row = document.createElement('tr');
        row.className = `action-${op.action}`;
        
        let details = '';
        switch(op.action) {
          case 'add':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Agent Group: ${op.agentGroup}`;
            break;
          case 'modify':
            details = `Phone: ${formatPhoneNumber(op.phoneNumber)}<br>Hours: ${op.businessHoursStart} - ${op.businessHoursEnd}`;
            break;
          case 'deprovision':
            details = 'Remove AA/CQ pair and release resources';
            break;
        }
        
        row.innerHTML = `
          <td style="text-transform:capitalize; font-weight:bold">${op.action}</td>
          <td>${op.aaqName || op.aaName}</td>
          <td>${details}</td>
          <td><button class="remove-batch-item" onclick="removeAAQBatchOperation(${op.id})">Remove</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    function removeAAQBatchOperation(id) {
      batchAAQOperations = batchAAQOperations.filter(op => op.id !== id);
      updateAAQBatchTable();
      populateAAQPhoneDropdowns();
    }

    function clearAllAAQBatch() {
      batchAAQOperations = [];
      updateAAQBatchTable();
      document.getElementById('batchAAQResults').innerHTML = '';
      document.getElementById('resetAAQPageBtn').style.display = 'none';
      populateAAQPhoneDropdowns();
      
      const btn = document.getElementById('clearAllAAQBatch');
      const originalText = btn.textContent;
      btn.textContent = '✅ Cleared!';
      btn.style.background = '#28a745';
      
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#6c757d';
      }, 2000);
    }

    function resetAAQPage() {
      batchAAQOperations = [];
      updateAAQBatchTable();
      document.getElementById('batchAAQResults').innerHTML = '';
      document.getElementById('resetAAQPageBtn').style.display = 'none';
      
      clearAddAAQFormOnly();
      clearModifyAAQFormOnly();
      clearDeprovisionAAQFormOnly();
      
      currentAAQ = null;
      
      setTimeout(() => {
        loadPhoneNumbers();
        loadAAQDropdownData();
      }, 100);
      
      const btn = document.getElementById('resetAAQPageBtn');
      const originalText = btn.textContent;
      btn.textContent = '✅ Page Reset!';
      btn.style.background = '#28a745';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '#007bff';
        btn.style.display = 'none';
      }, 2000);
    }

    // Submit AA/CQ operations to SQL (TEST MODE)
    async function submitAllAAQOperations() {
      if (!batchAAQOperations.length) return;
      
      const submitBtn = document.getElementById('submitAllAAQBatch');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '💾 Writing to SQL Tables...';
      
      try {
        // In test mode, we'll simulate writing to SQL
        // In production, this will make actual API calls
        
        const results = [];
        for (const op of batchAAQOperations) {
          // Simulate SQL write with a delay
          await new Promise(resolve => setTimeout(resolve, 500));
          
          results.push({
            operation: op,
            success: true,
            message: `Successfully wrote ${op.action} operation for ${op.aaqName || op.aaName} to SQL`
          });
        }
        
        displayAAQBatchResults(results, results.length, 0);
        
        // Clear batch after success
        batchAAQOperations = [];
        updateAAQBatchTable();
        
      } catch (error) {
        displayAAQBatchResults([{
          operation: { action: 'batch', aaqName: 'system' },
          success: false,
          message: `Error: ${error.message}`
        }], 0, 1);
      }
      
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }

    function displayAAQBatchResults(results, successCount, errorCount) {
      const resultsDiv = document.getElementById('batchAAQResults');
      
      let html = `<div class="batch-summary">
        <strong>Batch Results:</strong><br>
        Successful: ${successCount}<br>
        Failed: ${errorCount}<br>
        Total: ${results.length}
      </div>`;
      
      results.forEach(result => {
        const className = result.success ? 'success' : 'error';
        html += `<div class="${className}" style="margin-bottom:5px; padding:5px; font-size:12px;">
          <strong>${result.operation.action.toUpperCase()}</strong> ${result.operation.aaqName || result.operation.aaName || 'AA/CQ'}: ${result.message}
        </div>`;
      });
      
      if (successCount > 0) {
        html += `<div class="success" style="margin-top:10px; text-align:center;">
          ✅ Test mode: Data would be written to SQL tables. Ready for runbook testing!
        </div>`;
      }
      
      resultsDiv.innerHTML = html;
      
      if (errorCount > 0 && successCount === 0) {
        document.getElementById('resetAAQPageBtn').style.display = 'block';
      }
    }
