<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSOE Teams Phone User Provisioning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .logo {
            width: 80px;
            height: 80px;
            background-color: #c41e3a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            border-radius: 4px;
        }

        .logo-text {
            color: white;
            font-weight: bold;
            font-size: 24px;
            letter-spacing: -1px;
        }

        .title {
            font-size: 32px;
            color: #333;
            font-weight: normal;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .columns {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .column {
            flex: 1;
            background-color: #e8e8e8;
            border: 2px solid #999;
            border-radius: 4px;
            padding: 20px;
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .column-header {
            background-color: #d0d0d0;
            margin: -20px -20px 20px -20px;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 16px;
            color: #333;
            border-bottom: 1px solid #999;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #999;
            border-radius: 4px;
            background-color: white;
            font-size: 14px;
            color: #333;
        }

        .form-control:focus {
            outline: none;
            border-color: #c41e3a;
            box-shadow: 0 0 5px rgba(196, 30, 58, 0.3);
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 0;
        }

        .btn-primary {
            background-color: #c41e3a;
            color: white;
        }

        .btn-primary:hover {
            background-color: #a01729;
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #0066cc;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0052a3;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .submit-button {
            margin-top: auto;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: bold;
        }

        .dynamic-section {
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }

        .dynamic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            background-color: white;
            border-radius: 3px;
        }

        .error {
            color: #c41e3a;
            padding: 10px;
            background-color: #ffe6e6;
            border: 1px solid #c41e3a;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success {
            color: #006600;
            padding: 15px;
            background-color: #e6ffe6;
            border: 1px solid #006600;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }

        .user-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }

        .user-info h4 {
            margin-bottom: 10px;
            color: #1976d2;
        }

        .current-setting {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            margin: 3px 0;
            background-color: white;
            border-radius: 3px;
        }

        @media (max-width: 1200px) {
            .columns {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-text">MSOE</div>
            </div>
            <h1 class="title">MSOE Teams Phone User Provisioning</h1>
        </div>

        <div class="columns">
            <!-- Column 1: Add a Teams Phone User -->
            <div class="column">
                <div class="column-header">Add a Teams Phone User</div>
                
                <div id="addUserMessages"></div>
                
                <div class="form-group">
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; margin-bottom: 15px;">
                        <input type="checkbox" id="a5LicenseConfirm" style="transform: scale(1.2);">
                        <label for="a5LicenseConfirm" style="margin: 0; font-weight: bold; color: #856404;">Confirm user is A5 licensed</label>
                    </div>
                </div>

                <div id="addUserFields" style="opacity: 0.5; pointer-events: none;">
                
                <div class="form-group">
                    <label for="addUsername">Username:</label>
                    <input type="text" id="addUsername" class="form-control" placeholder="Enter MSOE email (e.g., user@msoe.edu)" />
                    <div id="addUsernameError" class="error" style="display: none; margin-top: 5px; padding: 5px;">Username must end with @msoe.edu</div>
                </div>

                <div class="form-group">
                    <label for="addPhoneNumber">Pick an available phone number for this user:</label>
                    <select id="addPhoneNumber" class="form-control">
                        <option value="">Loading phone numbers...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>International Calling:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="addIntlYes" name="addIntlCalling" value="yes">
                            <label for="addIntlYes">Yes</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="addIntlNo" name="addIntlCalling" value="no" checked>
                            <label for="addIntlNo">No</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Teams Call Queue Group Membership(s):</label>
                    <div id="addCallQueueGroups" class="dynamic-section">
                        <div class="dynamic-item">
                            <select class="form-control cq-group-select" style="width: 80%;">
                                <option value="">Loading Call Queue Groups...</option>
                            </select>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCallQueueGroup('add')">Add Another Group Membership</button>
                </div>

                <div class="form-group">
                    <label>Teams Auto Attendant Authorized User (Manager):</label>
                    <div id="addAutoAttendants" class="dynamic-section">
                        <div class="dynamic-item">
                            <select class="form-control aa-select" style="width: 80%;">
                                <option value="">Loading Auto Attendants...</option>
                            </select>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addAutoAttendant('add')">Add Another Auto Attendant</button>
                </div>

                <div class="form-group">
                    <label>Teams Call Queue Authorized User (Manager):</label>
                    <div id="addCallQueueManagers" class="dynamic-section">
                        <div class="dynamic-item">
                            <select class="form-control cq-select" style="width: 80%;">
                                <option value="">Loading Call Queues...</option>
                            </select>
                            <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCallQueueManager('add')">Add Another Call Queue</button>
                </div>

                <button id="addUserSubmit" class="btn btn-primary submit-button" disabled>Activate Phone User</button>
                
                </div> <!-- End of addUserFields -->
            </div>

            <!-- Column 2: Modify a Teams Phone User -->
            <div class="column">
                <div class="column-header">Modify a Teams Phone User</div>
                
                <div id="modifyUserMessages"></div>
                
                <div class="form-group">
                    <label for="modifyUsername">Username:</label>
                    <input type="text" id="modifyUsername" class="form-control" placeholder="Enter MSOE email to lookup user" />
                    <button type="button" class="btn btn-secondary" onclick="lookupUser()" style="margin-top: 10px;">Lookup User</button>
                </div>

                <div id="currentUserInfo" class="user-info" style="display: none;">
                    <h4>Current User Settings:</h4>
                    <div id="currentSettings"></div>
                </div>

                <div class="form-group" style="display: none;" id="modifyPhoneGroup">
                    <label>Change Phone Number:</label>
                    <select id="modifyPhoneNumber" class="form-control">
                        <option value="">Select new phone number...</option>
                    </select>
                </div>

                <div class="form-group" style="display: none;" id="modifyIntlGroup">
                    <label>International Calling:</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="modifyIntlYes" name="modifyIntlCalling" value="yes">
                            <label for="modifyIntlYes">Yes</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="modifyIntlNo" name="modifyIntlCalling" value="no">
                            <label for="modifyIntlNo">No</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="display: none;" id="modifyCallQueueGroupsGroup">
                    <label>Teams Call Queue Group Membership(s):</label>
                    <div id="currentCallQueueGroups">
                        <h5 style="margin: 10px 0 5px 0; color: #1976d2;">Current Group Memberships:</h5>
                        <div id="currentCallQueueGroupsList"></div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCallQueueGroup('modify')">Add Group Membership</button>
                </div>

                <div class="form-group" style="display: none;" id="modifyAutoAttendantsGroup">
                    <label>Add user as Teams Auto Attendant Authorized User (Manager):</label>
                    <div id="currentAutoAttendants">
                        <h5 style="margin: 10px 0 5px 0; color: #1976d2;">Current Auto Attendant Authorized User Roles:</h5>
                        <div id="currentAutoAttendantsList"></div>
                    </div>
                    <div class="dynamic-section">
                        <div class="dynamic-item">
                            <select class="form-control aa-select" style="width: 70%;">
                                <option value="">Select Auto Attendant to Add...</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-small">Add</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addAutoAttendant('modify')">Add Another Auto Attendant</button>
                </div>

                <div class="form-group" style="display: none;" id="modifyCallQueueManagersGroup">
                    <label>Add user as Teams Call Queue Authorized User (Manager):</label>
                    <div id="currentCallQueueManagers">
                        <h5 style="margin: 10px 0 5px 0; color: #1976d2;">Current Call Queue Authorized User Roles:</h5>
                        <div id="currentCallQueueManagersList"></div>
                    </div>
                    <div class="dynamic-section">
                        <div class="dynamic-item">
                            <select class="form-control cq-select" style="width: 70%;">
                                <option value="">Select Call Queue to Add...</option>
                            </select>
                            <button type="button" class="btn btn-secondary btn-small">Add</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCallQueueManager('modify')">Add Another Call Queue</button>
                </div>

                <button id="modifyUserSubmit" class="btn btn-primary submit-button" style="display: none;">Modify Phone User</button>
            </div>

            <!-- Column 3: Deprovision a Teams Phone User -->
            <div class="column">
                <div class="column-header">Deprovision a Teams Phone User</div>
                
                <div id="deprovisionUserMessages"></div>
                
                <div class="form-group">
                    <label for="deprovisionUsername">Username:</label>
                    <input type="text" id="deprovisionUsername" class="form-control" placeholder="Enter MSOE email" />
                    <button type="button" class="btn btn-secondary" onclick="lookupDeprovisionUser()" style="margin-top: 10px;">Lookup User</button>
                </div>

                <div id="deprovisionUserInfo" class="user-info" style="display: none;">
                    <h4>User to be Deprovisioned:</h4>
                    <div id="deprovisionSettings"></div>
                </div>

                <button id="deprovisionUserSubmit" class="btn btn-danger submit-button" style="display: none;">Deprovision User</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_CONFIG = {
            functionUrl: 'https://availablephonenumberapi.azurewebsites.net/api/GetAvailablePhoneNumbers',
            functionKey: 'EsQlM7c0jssk1pzk83F5IYFV6SkZm6AXto3KSbXSA4JlAzFuN7cgbw=='
        };

        // Global variables
        let availableNumbers = [];
        let currentUser = null;
        let dropdownData = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadPhoneNumbers();
            setupEventListeners();
        });

        function setupEventListeners() {
            // A5 License confirmation checkbox
            document.getElementById('a5LicenseConfirm').addEventListener('change', function() {
                const isChecked = this.checked;
                const fieldsContainer = document.getElementById('addUserFields');
                
                if (isChecked) {
                    fieldsContainer.style.opacity = '1';
                    fieldsContainer.style.pointerEvents = 'auto';
                } else {
                    fieldsContainer.style.opacity = '0.5';
                    fieldsContainer.style.pointerEvents = 'none';
                    // Reset form when unchecked
                    resetAddForm();
                }
            });
            
            // Add User Column
            document.getElementById('addPhoneNumber').addEventListener('change', validateAddForm);
            document.getElementById('addUsername').addEventListener('input', function() {
                validateUsername('add');
                validateAddForm();
            });
            document.getElementById('addUserSubmit').addEventListener('click', submitAddUser);

            // Modify User Column
            document.getElementById('modifyUserSubmit').addEventListener('click', submitModifyUser);

            // Deprovision User Column
            document.getElementById('deprovisionUserSubmit').addEventListener('click', submitDeprovisionUser);
        }

        async function loadPhoneNumbers() {
            try {
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Filter and sort numbers
                availableNumbers = data
                    .filter(item => 
                        item.AvailablePhoneNumber && 
                        item.AvailablePhoneNumber.startsWith('1414277')
                    )
                    .sort((a, b) => a.AvailablePhoneNumber.localeCompare(b.AvailablePhoneNumber));

                populatePhoneDropdowns();
                
                // Load dropdown data for call queue groups, auto attendants, etc.
                await loadDropdownData();
                
            } catch (error) {
                console.error('Error loading phone numbers:', error);
                showMessage('addUserMessages', `Failed to load phone numbers: ${error.message}`, 'error');
            }
        }

        async function loadDropdownData() {
            try {
                console.log('Trying GET method with data=dropdowns parameter...');
                
                // Try GET method first (this should work with the updated function)
                const getResponse = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}&data=dropdowns`);
                console.log('GET Response status:', getResponse.status);
                
                const getResponseText = await getResponse.text();
                console.log('GET Raw response text:', getResponseText);
                
                if (getResponse.ok && !getResponseText.includes('"error"')) {
                    try {
                        dropdownData = JSON.parse(getResponseText);
                        console.log('GET Success - parsed dropdown data:', dropdownData);
                        
                        if (dropdownData && typeof dropdownData === 'object' && !Array.isArray(dropdownData)) {
                            populateDropdowns();
                            return; // Success!
                        }
                    } catch (parseError) {
                        console.error('GET Parse error:', parseError);
                    }
                }
                
                console.log('GET method failed or returned wrong data, trying direct endpoint approach...');
                
                // If GET fails, try POST with exact action name from your function
                console.log('Trying POST with exact switch case name...');
                
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'getdropdowndata'  // Exact match from switch statement
                    })
                });
                
                console.log('POST Response status:', response.status);
                const responseText = await response.text();
                console.log('POST Raw response text:', responseText);
                
                // For debugging - let's see what happens with an invalid action
                console.log('Testing with invalid action to see default behavior...');
                const testResponse = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'invalid_action_test'
                    })
                });
                const testText = await testResponse.text();
                console.log('Invalid action response:', testText);
                
                throw new Error('Unable to load dropdown data with any method');
                
            } catch (error) {
                console.error('Error loading dropdown data:', error);
                showMessage('addUserMessages', `Failed to load dropdown options: ${error.message}`, 'error');
            }
        }

        function populateDropdowns() {
            if (!dropdownData) {
                console.error('No dropdown data available');
                return;
            }

            console.log('Dropdown data structure:', dropdownData);
            console.log('Type of dropdownData:', typeof dropdownData);
            console.log('Is array:', Array.isArray(dropdownData));

            // Handle case where API returns an array instead of object
            if (Array.isArray(dropdownData)) {
                console.error('API returned an array instead of an object. This suggests the database tables are empty or there\'s an issue with the GetDropdownData function.');
                showMessage('addUserMessages', 'Database tables appear to be empty or inaccessible. Please check the database connection and table contents.', 'error');
                return;
            }

            // Check if the expected properties exist
            if (!dropdownData.callQueueGroups || !Array.isArray(dropdownData.callQueueGroups)) {
                console.error('callQueueGroups not found or not an array:', dropdownData.callQueueGroups);
                showMessage('addUserMessages', 'Invalid dropdown data structure received - missing callQueueGroups', 'error');
                return;
            }

            // Populate Call Queue Group dropdowns
            const cqGroupSelects = document.querySelectorAll('.cq-group-select');
            cqGroupSelects.forEach(select => {
                // Clear existing options except first
                select.innerHTML = '<option value="">Select Call Queue Group...</option>';
                
                // Add call queue groups from database
                dropdownData.callQueueGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                });
            });

            // Populate Auto Attendant dropdowns
            if (dropdownData.autoAttendants && Array.isArray(dropdownData.autoAttendants)) {
                const aaSelects = document.querySelectorAll('.aa-select');
                aaSelects.forEach(select => {
                    // Clear existing options except first
                    select.innerHTML = '<option value="">Select Auto Attendant...</option>';
                    
                    // Add auto attendants from database
                    dropdownData.autoAttendants.forEach(attendant => {
                        const option = document.createElement('option');
                        option.value = attendant;
                        option.textContent = attendant;
                        select.appendChild(option);
                    });
                });
            } else {
                console.error('autoAttendants not found or not an array:', dropdownData.autoAttendants);
            }

            // Populate Call Queue dropdowns
            if (dropdownData.callQueues && Array.isArray(dropdownData.callQueues)) {
                const cqSelects = document.querySelectorAll('.cq-select');
                cqSelects.forEach(select => {
                    // Clear existing options except first
                    select.innerHTML = '<option value="">Select Call Queue...</option>';
                    
                    // Add call queues from database
                    dropdownData.callQueues.forEach(queue => {
                        const option = document.createElement('option');
                        option.value = queue;
                        option.textContent = queue;
                        select.appendChild(option);
                    });
                });
            } else {
                console.error('callQueues not found or not an array:', dropdownData.callQueues);
            }

            console.log('Dropdown population completed');
        }

        function populatePhoneDropdowns() {
            const dropdowns = ['addPhoneNumber', 'modifyPhoneNumber'];
            
            dropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                dropdown.innerHTML = '<option value="">Select a phone number...</option>';
                
                availableNumbers.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.AvailablePhoneNumber;
                    option.textContent = item.AvailablePhoneNumber;
                    dropdown.appendChild(option);
                });
            });
        }

        function validateUsername(column) {
            const usernameField = document.getElementById(`${column}Username`);
            const errorDiv = document.getElementById(`${column}UsernameError`);
            const username = usernameField.value;
            
            const isValid = username && username.endsWith('@msoe.edu');
            
            if (errorDiv) {
                if (username && !isValid) {
                    errorDiv.style.display = 'block';
                } else {
                    errorDiv.style.display = 'none';
                }
            }
            
            return isValid;
        }

        function validateAddForm() {
            const a5Licensed = document.getElementById('a5LicenseConfirm').checked;
            const phoneSelected = document.getElementById('addPhoneNumber').value !== '';
            const usernameValid = validateUsername('add');
            
            document.getElementById('addUserSubmit').disabled = !(a5Licensed && phoneSelected && usernameValid);
        }

        function lookupDeprovisionUser() {
            const username = document.getElementById('deprovisionUsername').value;
            
            if (!username || !username.endsWith('@msoe.edu')) {
                showMessage('deprovisionUserMessages', 'Please enter a valid MSOE email address', 'error');
                return;
            }
            
            // Clear any previous messages
            showMessage('deprovisionUserMessages', '', '');
            
            // Call API to lookup user
            lookupUserData(username, 'deprovision');
        }

        async function lookupUserData(username, context) {
            try {
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'lookup',
                        username: username
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const userData = await response.json();
                
                if (context === 'deprovision') {
                    displayDeprovisionUserSettings(userData);
                    showDeprovisionButton();
                } else if (context === 'modify') {
                    currentUser = userData;
                    displayCurrentUserSettings();
                    showModifyFields();
                }
                
            } catch (error) {
                console.error('Error looking up user:', error);
                const messageContainer = context === 'deprovision' ? 'deprovisionUserMessages' : 'modifyUserMessages';
                showMessage(messageContainer, `Failed to lookup user: ${error.message}`, 'error');
            }
        }

        function displayDeprovisionUserSettings(user) {
            const settingsDiv = document.getElementById('deprovisionSettings');
            const formattedPhone = formatPhoneNumber(user.phoneNumber);
            
            settingsDiv.innerHTML = `
                <div class="current-setting"><strong>Username:</strong> ${user.username}</div>
                <div class="current-setting"><strong>Phone Number:</strong> ${formattedPhone}</div>
                <div class="current-setting"><strong>International Calling:</strong> ${user.internationalCalling ? 'Yes' : 'No'}</div>
                <div class="current-setting"><strong>Call Queue Groups:</strong> ${user.callQueueGroups.join(', ')}</div>
                <div class="current-setting"><strong>Auto Attendants Manager:</strong> ${user.autoAttendants.join(', ')}</div>
                <div class="current-setting"><strong>Call Queue Manager:</strong> ${user.callQueueManagers.join(', ')}</div>
                <div style="margin-top: 15px; padding: 10px; background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; color: #c62828;">
                    <strong>Warning:</strong> All Teams Phone functionality for this user will be removed.
                </div>
            `;
            
            document.getElementById('deprovisionUserInfo').style.display = 'block';
        }

        function showDeprovisionButton() {
            document.getElementById('deprovisionUserSubmit').style.display = 'block';
        }

        async function submitAddUser() {
            try {
                const phoneNumber = document.getElementById('addPhoneNumber').value;
                const username = document.getElementById('addUsername').value;
                const a5Licensed = document.getElementById('a5LicenseConfirm').checked;
                const internationalCalling = document.getElementById('addIntlYes').checked;
                
                // Collect Call Queue Groups
                const callQueueGroups = [];
                document.querySelectorAll('#addCallQueueGroups .cq-group-select').forEach(select => {
                    if (select.value) callQueueGroups.push(select.value);
                });
                
                // Collect Auto Attendants
                const autoAttendants = [];
                document.querySelectorAll('#addAutoAttendants .aa-select').forEach(select => {
                    if (select.value) autoAttendants.push(select.value);
                });
                
                // Collect Call Queue Managers
                const callQueueManagers = [];
                document.querySelectorAll('#addCallQueueManagers .cq-select').forEach(select => {
                    if (select.value) callQueueManagers.push(select.value);
                });
                
                console.log('Form data being submitted:', {
                    username,
                    phoneNumber,
                    a5Licensed,
                    internationalCalling,
                    callQueueGroups,
                    autoAttendants,
                    callQueueManagers
                });
                
                // Disable button during submission
                const submitBtn = document.getElementById('addUserSubmit');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                // Make API call to submit the user data
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'add',
                        username: username,
                        phoneNumber: phoneNumber,
                        a5Licensed: a5Licensed,
                        internationalCalling: internationalCalling,
                        callQueueGroups: callQueueGroups,
                        autoAttendants: autoAttendants,
                        callQueueManagers: callQueueManagers
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                const responseText = await response.text();
                console.log('Raw response text:', responseText);

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.error) {
                            errorMessage += ` - ${errorData.error}`;
                        }
                    } catch (parseError) {
                        errorMessage += ` - ${responseText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = JSON.parse(responseText);
                console.log('Parsed result:', result);
                
                // Format phone number for display
                const formattedPhone = formatPhoneNumber(phoneNumber);
                
                // Show success message
                const successHTML = `
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${username}</div>
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${formattedPhone}</div>
                    <div style="font-weight: bold;">***provisioning complete***</div>
                `;
                showMessage('addUserMessages', successHTML, 'success');
                
                // Remove the number from available list and refresh dropdowns
                availableNumbers = availableNumbers.filter(item => 
                    item.AvailablePhoneNumber !== phoneNumber
                );
                populatePhoneDropdowns();
                
                // Reset form
                resetAddForm();
                
            } catch (error) {
                console.error('Error submitting user:', error);
                showMessage('addUserMessages', `Failed to add user: ${error.message}`, 'error');
                
                // Re-enable button
                const submitBtn = document.getElementById('addUserSubmit');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Activate Phone User';
            }
        }

        async function submitDeprovisionUser() {
            try {
                const username = document.getElementById('deprovisionUsername').value;
                
                // Disable button during submission
                const submitBtn = document.getElementById('deprovisionUserSubmit');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                // Make API call to deprovision the user
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'deprovision',
                        username: username
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show confirmation message
                const confirmHTML = `
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${username}</div>
                    <div style="font-weight: bold;">***deprovisioning complete***</div>
                `;
                showMessage('deprovisionUserMessages', confirmHTML, 'success');
                
                // Reset form
                document.getElementById('deprovisionUsername').value = '';
                document.getElementById('deprovisionUserInfo').style.display = 'none';
                document.getElementById('deprovisionUserSubmit').style.display = 'none';
                
            } catch (error) {
                console.error('Error deprovisioning user:', error);
                showMessage('deprovisionUserMessages', `Failed to deprovision user: ${error.message}`, 'error');
                
                // Re-enable button
                const submitBtn = document.getElementById('deprovisionUserSubmit');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Deprovision User';
            }
        }

        function lookupUser() {
            const username = document.getElementById('modifyUsername').value;
            
            if (!username || !username.endsWith('@msoe.edu')) {
                showMessage('modifyUserMessages', 'Please enter a valid MSOE email address', 'error');
                return;
            }
            
            // Clear any previous messages
            showMessage('modifyUserMessages', '', '');
            
            // Call API to lookup user
            lookupUserData(username, 'modify');
        }

        function displayCurrentUserSettings() {
            const settingsDiv = document.getElementById('currentSettings');
            const formattedPhone = formatPhoneNumber(currentUser.phoneNumber);
            
            settingsDiv.innerHTML = `
                <div class="current-setting"><strong>Phone Number:</strong> ${formattedPhone}</div>
                <div class="current-setting"><strong>International Calling:</strong> ${currentUser.internationalCalling ? 'Yes' : 'No'}</div>
                <div class="current-setting"><strong>Call Queue Groups:</strong> ${currentUser.callQueueGroups.join(', ')}</div>
                <div class="current-setting"><strong>Auto Attendants Manager:</strong> ${currentUser.autoAttendants.join(', ')}</div>
                <div class="current-setting"><strong>Call Queue Manager:</strong> ${currentUser.callQueueManagers.join(', ')}</div>
            `;
            
            // Display current memberships with remove buttons
            displayCurrentMemberships();
            
            document.getElementById('currentUserInfo').style.display = 'block';
        }

        function displayCurrentMemberships() {
            // Display current call queue groups
            const callQueueGroupsList = document.getElementById('currentCallQueueGroupsList');
            callQueueGroupsList.innerHTML = '';
            currentUser.callQueueGroups.forEach(group => {
                const item = document.createElement('div');
                item.className = 'current-setting';
                item.innerHTML = `
                    <span>${group}</span>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCurrentMembership('callQueueGroups', '${group}')">Remove</button>
                `;
                callQueueGroupsList.appendChild(item);
            });

            // Display current auto attendants
            const autoAttendantsList = document.getElementById('currentAutoAttendantsList');
            autoAttendantsList.innerHTML = '';
            currentUser.autoAttendants.forEach(attendant => {
                const item = document.createElement('div');
                item.className = 'current-setting';
                item.innerHTML = `
                    <span>${attendant}</span>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCurrentMembership('autoAttendants', '${attendant}')">Remove</button>
                `;
                autoAttendantsList.appendChild(item);
            });

            // Display current call queue managers
            const callQueueManagersList = document.getElementById('currentCallQueueManagersList');
            callQueueManagersList.innerHTML = '';
            currentUser.callQueueManagers.forEach(queue => {
                const item = document.createElement('div');
                item.className = 'current-setting';
                item.innerHTML = `
                    <span>${queue}</span>
                    <button type="button" class="btn btn-danger btn-small" onclick="removeCurrentMembership('callQueueManagers', '${queue}')">Remove</button>
                `;
                callQueueManagersList.appendChild(item);
            });
        }

        function showModifyFields() {
            const fieldsToShow = ['modifyPhoneGroup', 'modifyIntlGroup', 'modifyCallQueueGroupsGroup', 'modifyAutoAttendantsGroup', 'modifyCallQueueManagersGroup'];
            fieldsToShow.forEach(id => {
                document.getElementById(id).style.display = 'block';
            });
            document.getElementById('modifyUserSubmit').style.display = 'block';
            
            // Set current values
            document.getElementById('modifyIntlYes').checked = currentUser.internationalCalling;
            document.getElementById('modifyIntlNo').checked = !currentUser.internationalCalling;
        }

        function resetAddForm() {
            document.getElementById('addPhoneNumber').value = '';
            document.getElementById('addUsername').value = '';
            document.getElementById('addIntlNo').checked = true;
            document.getElementById('a5LicenseConfirm').checked = false;
            
            // Reset the fields container to disabled state
            const fieldsContainer = document.getElementById('addUserFields');
            fieldsContainer.style.opacity = '0.5';
            fieldsContainer.style.pointerEvents = 'none';
            
            validateAddForm();
        }

        function formatPhoneNumber(phoneNumber) {
            const digits = phoneNumber.replace(/\D/g, '');
            
            if (digits.length === 11 && digits.startsWith('1')) {
                return `+1 ${digits.slice(1, 4)} ${digits.slice(4, 7)} ${digits.slice(7)}`;
            } else if (digits.length === 10) {
                return `+1 ${digits.slice(0, 3)} ${digits.slice(3, 6)} ${digits.slice(6)}`;
            }
            
            return `+1 ${phoneNumber}`;
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Dynamic content management functions
        function addCallQueueGroup(column) {
            const container = document.getElementById(`${column}CallQueueGroups`);
            const newItem = document.createElement('div');
            newItem.className = 'dynamic-item';
            newItem.innerHTML = `
                <select class="form-control cq-group-select" style="width: 80%;">
                    <option value="">Select Call Queue Group...</option>
                </select>
                <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            `;
            container.appendChild(newItem);
            
            // Populate the new dropdown with current data
            if (dropdownData && dropdownData.callQueueGroups) {
                const select = newItem.querySelector('.cq-group-select');
                dropdownData.callQueueGroups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                });
            }
        }

        function addAutoAttendant(column) {
            const container = document.getElementById(`${column}AutoAttendants`);
            const newItem = document.createElement('div');
            newItem.className = 'dynamic-item';
            newItem.innerHTML = `
                <select class="form-control aa-select" style="width: 80%;">
                    <option value="">Select Auto Attendant...</option>
                </select>
                <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            `;
            container.appendChild(newItem);
            
            // Populate the new dropdown with current data
            if (dropdownData && dropdownData.autoAttendants) {
                const select = newItem.querySelector('.aa-select');
                dropdownData.autoAttendants.forEach(attendant => {
                    const option = document.createElement('option');
                    option.value = attendant;
                    option.textContent = attendant;
                    select.appendChild(option);
                });
            }
        }

        function addCallQueueManager(column) {
            const container = document.getElementById(`${column}CallQueueManagers`);
            const newItem = document.createElement('div');
            newItem.className = 'dynamic-item';
            newItem.innerHTML = `
                <select class="form-control cq-select" style="width: 80%;">
                    <option value="">Select Call Queue...</option>
                </select>
                <button type="button" class="btn btn-danger btn-small" onclick="removeItem(this)">Remove</button>
            `;
            container.appendChild(newItem);
            
            // Populate the new dropdown with current data
            if (dropdownData && dropdownData.callQueues) {
                const select = newItem.querySelector('.cq-select');
                dropdownData.callQueues.forEach(queue => {
                    const option = document.createElement('option');
                    option.value = queue;
                    option.textContent = queue;
                    select.appendChild(option);
                });
            }
        }

        function removeItem(button) {
            button.parentElement.remove();
        }

        async function submitModifyUser() {
            try {
                const username = document.getElementById('modifyUsername').value;
                const phoneNumber = document.getElementById('modifyPhoneNumber').value;
                const internationalCalling = document.getElementById('modifyIntlYes').checked;
                
                // Collect new Call Queue Groups (from add sections, not current ones)
                const callQueueGroups = [];
                document.querySelectorAll('#modifyCallQueueGroupsGroup .cq-group-select').forEach(select => {
                    if (select.value) callQueueGroups.push(select.value);
                });
                
                // Collect new Auto Attendants (from add sections, not current ones)
                const autoAttendants = [];
                document.querySelectorAll('#modifyAutoAttendantsGroup .aa-select').forEach(select => {
                    if (select.value) autoAttendants.push(select.value);
                });
                
                // Collect new Call Queue Managers (from add sections, not current ones)
                const callQueueManagers = [];
                document.querySelectorAll('#modifyCallQueueManagersGroup .cq-select').forEach(select => {
                    if (select.value) callQueueManagers.push(select.value);
                });
                
                // Merge with existing data that hasn't been removed
                const finalCallQueueGroups = [...currentUser.callQueueGroups, ...callQueueGroups];
                const finalAutoAttendants = [...currentUser.autoAttendants, ...autoAttendants];
                const finalCallQueueManagers = [...currentUser.callQueueManagers, ...callQueueManagers];
                
                // Disable button during submission
                const submitBtn = document.getElementById('modifyUserSubmit');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';
                
                // Make API call to modify the user
                const response = await fetch(`${API_CONFIG.functionUrl}?code=${API_CONFIG.functionKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'modify',
                        username: username,
                        phoneNumber: phoneNumber,
                        internationalCalling: internationalCalling,
                        callQueueGroups: finalCallQueueGroups,
                        autoAttendants: finalAutoAttendants,
                        callQueueManagers: finalCallQueueManagers
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                // Show success message
                const successHTML = `
                    <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${username}</div>
                    <div style="font-weight: bold;">***modification complete***</div>
                `;
                showMessage('modifyUserMessages', successHTML, 'success');
                
                // Refresh user data
                lookupUserData(username, 'modify');
                
            } catch (error) {
                console.error('Error modifying user:', error);
                showMessage('modifyUserMessages', `Failed to modify user: ${error.message}`, 'error');
                
                // Re-enable button
                const submitBtn = document.getElementById('modifyUserSubmit');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Modify Phone User';
            }
        }

        function removeCurrentMembership(type, item) {
            // Remove from current user data
            const index = currentUser[type].indexOf(item);
            if (index > -1) {
                currentUser[type].splice(index, 1);
            }
            
            // Refresh the display
            displayCurrentMemberships();
        }
    </script>
</body>
</html>
